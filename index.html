<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>idaraBUILDING</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">

  <style>
    :root {
      --navy:   #1B2A4A;
      --burg:   #9B2335;
      --forest: #1A6B3C;
      --gold:   #C9A84C;
      --bg:     #F0EFEB;
      --surf:   #FFFFFF;
      --bdr:    rgba(27,42,74,0.10);
      --muted:  rgba(27,42,74,0.45);
      --font:   'Cairo', sans-serif;
      --mono:   'DM Mono', monospace;
      --nav-h:  72px;
    }

    *, *::before, *::after {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      margin: 0; padding: 0;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--navy);
      -webkit-font-smoothing: antialiased;
      direction: rtl;
      display: flex;
      flex-direction: column;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LOGIN SCREEN
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #login-screen {
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 24px 24px calc(24px + env(safe-area-inset-bottom));
      gap: 0;
    }

    #login-screen.out {
      animation: loginOut 0.4s ease forwards;
    }

    @keyframes loginOut {
      to { opacity: 0; transform: scale(1.03); pointer-events: none; }
    }

    /* Brand */
    .lgn-brand {
      text-align: center;
      margin-bottom: 6px;
    }

    .lgn-brand-mark {
      display: flex;
      align-items: baseline;
      justify-content: center;
      direction: ltr;
    }

    .lgn-b-idara {
      font-family: var(--font);
      font-size: 28px;
      font-weight: 700;
      color: var(--navy);
      letter-spacing: -0.5px;
    }

    .lgn-b-building {
      font-family: var(--font);
      font-size: 28px;
      font-weight: 700;
      color: var(--burg);
      letter-spacing: -0.5px;
    }

    .lgn-b-tag {
      font-size: 9px;
      color: var(--muted);
      letter-spacing: 0.3px;
      margin-top: 3px;
      direction: ltr;
    }

    /* Building name */
    .lgn-bld {
      font-size: 14px;
      font-weight: 700;
      color: var(--navy);
      text-align: center;
      direction: rtl;
      margin-bottom: 32px;
      min-height: 20px;
    }

    /* Gold divider */
    .lgn-divider {
      width: 48px;
      height: 2px;
      background: var(--gold);
      border-radius: 2px;
      margin: 10px auto 28px;
    }

    /* Prompt */
    .lgn-prompt {
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      text-align: center;
      margin-bottom: 20px;
      direction: rtl;
    }

    /* PIN dots */
    .lgn-dots {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-bottom: 28px;
    }

    .lgn-dot {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid var(--bdr);
      background: transparent;
      transition: all 0.15s ease;
    }

    .lgn-dot.filled {
      background: var(--navy);
      border-color: var(--navy);
      transform: scale(1.1);
    }

    .lgn-dot.error {
      background: var(--burg);
      border-color: var(--burg);
    }

    .lgn-dot.success {
      background: var(--forest);
      border-color: var(--forest);
    }

    /* Dots shake on error */
    .lgn-dots.shake {
      animation: dotShake 0.4s ease;
    }

    @keyframes dotShake {
      0%,100% { transform: translateX(0); }
      20%     { transform: translateX(-8px); }
      40%     { transform: translateX(8px); }
      60%     { transform: translateX(-5px); }
      80%     { transform: translateX(5px); }
    }

    /* Hidden real input â€” captures keyboard on desktop */
    #pin-input {
      position: absolute;
      opacity: 0;
      width: 1px;
      height: 1px;
      pointer-events: none;
    }

    /* Numpad */
    .lgn-pad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      width: 100%;
      max-width: 300px;
      margin-bottom: 20px;
    }

    .pad-btn {
      height: 64px;
      border-radius: 16px;
      border: 1.5px solid var(--bdr);
      background: var(--surf);
      font-family: var(--mono);
      font-size: 22px;
      font-weight: 500;
      color: var(--navy);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1px;
      transition: all 0.12s ease;
      box-shadow: 0 1px 4px rgba(27,42,74,0.06);
      -webkit-user-select: none;
      user-select: none;
    }

    .pad-btn:active {
      transform: scale(0.92);
      background: var(--bg);
      box-shadow: none;
    }

    .pad-btn .pad-letters {
      font-family: var(--font);
      font-size: 7px;
      color: var(--muted);
      letter-spacing: 1px;
      line-height: 1;
    }

    .pad-btn.pad-zero {
      grid-column: 2;
    }

    .pad-btn.pad-back {
      grid-column: 3;
      font-size: 20px;
      color: var(--muted);
      border-color: transparent;
      background: transparent;
      box-shadow: none;
    }

    .pad-btn.pad-back:active {
      background: var(--bg);
    }

    /* Status messages */
    .lgn-status {
      min-height: 20px;
      font-size: 12px;
      font-weight: 600;
      text-align: center;
      color: var(--burg);
      direction: rtl;
    }

    /* Attempt counter */
    .lgn-attempts {
      font-size: 11px;
      color: var(--muted);
      text-align: center;
      margin-top: 6px;
      min-height: 16px;
    }

    /* Verifying spinner */
    #lgn-verifying {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      min-height: 52px;
    }

    #lgn-verifying.show { display: flex; }

    .lgn-wave {
      display: flex;
      align-items: flex-end;
      gap: 5px;
      height: 24px;
    }

    .lgn-wave span {
      display: block;
      width: 5px;
      border-radius: 3px;
      background: var(--navy);
      animation: waveBar 1.1s ease-in-out infinite;
    }

    .lgn-wave span:nth-child(1) { height: 8px;  animation-delay: 0s; }
    .lgn-wave span:nth-child(2) { height: 16px; animation-delay: 0.15s; }
    .lgn-wave span:nth-child(3) { height: 24px; animation-delay: 0.3s; }
    .lgn-wave span:nth-child(4) { height: 16px; animation-delay: 0.45s; }
    .lgn-wave span:nth-child(5) { height: 8px;  animation-delay: 0.6s; }

    @keyframes waveBar {
      0%, 100% { transform: scaleY(0.4); opacity: 0.35; }
      50%       { transform: scaleY(1);   opacity: 1; }
    }

    .lgn-verif-txt {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      letter-spacing: 0.5px;
    }

    /* Lockout overlay (inside login screen) */
    #lockout-banner {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 20px;
      background: rgba(155,35,53,0.07);
      border: 1px solid rgba(155,35,53,0.22);
      border-radius: 16px;
      width: 100%;
      max-width: 300px;
      text-align: center;
    }

    #lockout-banner.show { display: flex; }

    .lo-icon { font-size: 28px; }

    .lo-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--burg);
    }

    .lo-msg {
      font-size: 12px;
      color: var(--muted);
      direction: rtl;
    }

    .lo-timer {
      font-family: var(--mono);
      font-size: 20px;
      font-weight: 500;
      color: var(--burg);
    }

    /* Welcome toast inside login (success) */
    .lgn-welcome {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      text-align: center;
    }

    .lgn-welcome.show { display: flex; }

    .lgn-welcome-icon { font-size: 36px; }
    .lgn-welcome-name {
      font-size: 18px;
      font-weight: 700;
      color: var(--navy);
    }
    .lgn-welcome-role {
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 0.5px;
    }

    /* Session info bar â€” shown in main app */
    #session-bar {
      display: none;
      flex-shrink: 0;
      background: var(--navy);
      padding: 6px 14px;
      align-items: center;
      justify-content: space-between;
    }

    #session-bar.show { display: flex; }

    .sb-name {
      font-size: 10px;
      font-weight: 700;
      color: rgba(255,255,255,0.7);
    }

    .sb-role {
      font-family: var(--mono);
      font-size: 8px;
      color: var(--gold);
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .sb-logout {
      font-size: 10px;
      color: rgba(255,255,255,0.4);
      cursor: pointer;
      padding: 4px 8px;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 6px;
      direction: ltr;
      transition: all 0.15s;
    }

    .sb-logout:active { color: rgba(255,255,255,0.8); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SCROLL ZONE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #scroll {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 14px 14px 16px;
    }

    #scroll::-webkit-scrollbar { display: none; }
    #scroll { scrollbar-width: none; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FIXED BOTTOM NAV
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #nav {
      flex-shrink: 0;
      background: var(--surf);
      border-top: 1px solid var(--bdr);
      box-shadow: 0 -4px 16px rgba(27,42,74,0.08);
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    .nav-tabs {
      display: flex;
      align-items: stretch;
      height: 52px;
    }

    .nav-tab {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1px;
      cursor: pointer;
      border: none;
      background: none;
      font-family: var(--font);
      transition: background 0.15s;
      padding: 0;
      position: relative;
    }

    .nav-tab:active { background: rgba(27,42,74,0.04); }

    .nav-tab::before {
      content: '';
      position: absolute;
      top: 0; left: 20%; right: 20%;
      height: 2.5px;
      border-radius: 0 0 3px 3px;
      background: transparent;
      transition: background 0.2s;
    }

    .nav-tab.n-inc::before { background: var(--forest); }
    .nav-tab.n-exp::before { background: var(--burg); }
    .nav-tab.n-rep::before { background: var(--navy); }

    .nav-ico { font-size: 20px; line-height: 1; }
    .nav-ar  { font-size: 10px; font-weight: 700; color: var(--muted); line-height: 1; }
    .nav-en  { font-size: 7px; font-weight: 500; color: var(--muted); opacity: 0.7; line-height: 1; }

    .nav-tab.n-inc .nav-ar, .nav-tab.n-inc .nav-en { color: var(--forest); opacity: 1; }
    .nav-tab.n-exp .nav-ar, .nav-tab.n-exp .nav-en { color: var(--burg);   opacity: 1; }
    .nav-tab.n-rep .nav-ar, .nav-tab.n-rep .nav-en { color: var(--navy);   opacity: 1; }

    .nav-brand {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0px;
      padding: 3px 0 calc(3px + env(safe-area-inset-bottom));
      border-top: 1px solid var(--bdr);
      background: rgba(27,42,74,0.02);
    }

    .nb-wrap { display: flex; align-items: baseline; direction: ltr; gap: 0; }
    .nb-idara { font-family: var(--font); font-size: 11px; font-weight: 700; color: var(--navy); }
    .nb-sep { display: none; }
    .nb-pro { font-family: var(--font); font-size: 11px; font-weight: 700; color: var(--burg); }
    .nb-tag { font-size: 6.5px; color: var(--muted); letter-spacing: 0.3px; line-height: 1; }
    .nb-tag b { font-family: var(--mono); font-weight: 500; color: var(--navy); opacity: 0.7; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LOADER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #loader {
      position: fixed; inset: 0;
      background: var(--bg);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 20px; z-index: 9999;
      transition: opacity 0.4s ease;
    }

    #loader.out { opacity: 0; pointer-events: none; }

    .ldr-brand { font-size: 30px; font-weight: 700; color: var(--navy); direction: ltr; }
    .ldr-brand b { font-family: var(--font); font-size: 30px; font-weight: 700; color: var(--burg); }
    .ldr-track { width: 72px; height: 2px; background: var(--bdr); border-radius: 2px; overflow: hidden; }
    .ldr-bar { height: 100%; width: 40%; background: linear-gradient(90deg, var(--burg), var(--gold)); border-radius: 2px; animation: sweep 1s ease-in-out infinite; }
    @keyframes sweep { 0% { transform: translateX(200%); } 100% { transform: translateX(-300%); } }
    .ldr-hint { font-size: 11px; color: var(--muted); }
    .ldr-platform { font-size: 10px; color: var(--muted); direction: ltr; margin-top: -12px; letter-spacing: 0.2px; }
    .ldr-platform span { font-family: var(--mono); font-size: 9px; font-weight: 500; color: var(--navy); opacity: 0.6; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOAST
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #toast {
      position: fixed;
      bottom: calc(var(--nav-h) + env(safe-area-inset-bottom) + 10px);
      left: 16px; right: 16px;
      padding: 13px 16px;
      border-radius: 12px;
      font-size: 14px; font-weight: 600;
      color: #fff; text-align: center;
      z-index: 8000;
      opacity: 0; transform: translateY(8px);
      pointer-events: none;
      transition: all 0.25s ease;
      box-shadow: 0 6px 20px rgba(0,0,0,0.18);
    }

    #toast.show { opacity: 1; transform: translateY(0); }
    #toast.ok   { background: var(--forest); }
    #toast.fail { background: var(--burg); }
    #toast.info { background: var(--navy); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HEADER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
    .bld-name { font-size: 15px; font-weight: 700; color: var(--navy); line-height: 1.2; }
    .bld-sub { font-size: 9px; color: var(--muted); margin-top: 1px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--forest); box-shadow: 0 0 0 3px rgba(26,107,60,0.15); flex-shrink: 0; transition: all 0.3s; }
    .dot.off { background: var(--burg); box-shadow: 0 0 0 3px rgba(155,35,53,0.15); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DASHBOARD CARD
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .dash-card { background: var(--navy); border-radius: 20px; padding: 22px 20px 18px; margin-bottom: 16px; position: relative; overflow: hidden; box-shadow: 0 10px 28px rgba(27,42,74,0.22); }
    .dash-card::before { content: ''; position: absolute; top: -45px; left: -45px; width: 160px; height: 160px; border-radius: 50%; background: rgba(201,168,76,0.07); pointer-events: none; }
    .dash-card::after  { content: ''; position: absolute; bottom: -45px; right: -25px; width: 150px; height: 150px; border-radius: 50%; background: rgba(155,35,53,0.09); pointer-events: none; }
    .d-top { display: flex; justify-content: space-between; align-items: flex-start; position: relative; z-index: 1; }
    .d-lbl-en { font-size: 9px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; color: rgba(255,255,255,0.4); }
    .d-lbl-ar { font-size: 11px; color: rgba(255,255,255,0.3); margin-top: 2px; }
    .d-heart { display: flex; flex-direction: column; align-items: center; gap: 2px; cursor: pointer; position: relative; z-index: 1; }
    .d-heart-ico { font-size: 20px; line-height: 1; animation: hb 2s ease-in-out infinite; }
    @keyframes hb { 0%,100% { transform: scale(1); } 15% { transform: scale(1.22); } 30% { transform: scale(1); } 45% { transform: scale(1.12); } }
    .d-heart-pct { font-family: var(--mono); font-size: 11px; color: rgba(255,255,255,0.75); }
    .d-amount { font-family: var(--mono); font-size: clamp(30px, 9vw, 44px); font-weight: 500; color: #fff; direction: ltr; text-align: right; letter-spacing: -1px; line-height: 1; margin: 10px 0 6px; position: relative; z-index: 1; }
    .d-line { height: 1px; background: linear-gradient(90deg, var(--gold), transparent); opacity: 0.45; border-radius: 1px; position: relative; z-index: 1; }
    .d-foot { display: flex; justify-content: space-between; align-items: center; margin-top: 9px; position: relative; z-index: 1; }
    .d-time { font-family: var(--mono); font-size: 9px; color: rgba(255,255,255,0.28); }
    .d-refresh { width: 28px; height: 28px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.5); font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s; flex-shrink: 0; }
    .d-refresh:active { opacity: 0.6; }
    .d-refresh.spin { animation: spin 0.7s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CARD, LABELS, INPUTS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .card { background: var(--surf); border-radius: 16px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--bdr); box-shadow: 0 1px 4px rgba(27,42,74,0.05); }
    .lbl { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; }
    .l-ar { font-size: 13px; font-weight: 700; color: var(--navy); }
    .l-en { font-size: 9px; color: var(--muted); direction: ltr; }
    .inp { width: 100%; height: 54px; border: 1.5px solid var(--bdr); border-radius: 12px; background: var(--bg); font-family: var(--font); font-size: 16px; font-weight: 600; color: var(--navy); padding: 0 14px; outline: none; -webkit-appearance: none; appearance: none; transition: border-color 0.2s, box-shadow 0.2s; text-align: right; }
    .inp:focus { border-color: var(--navy); background: var(--surf); box-shadow: 0 0 0 3px rgba(27,42,74,0.07); }
    .inp.err { border-color: var(--burg); animation: shake 0.3s ease; }
    @keyframes shake { 0%,100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    select.inp { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%231B2A4A' opacity='.35'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: left 14px center; padding-left: 36px; cursor: pointer; font-size: 15px; }
    .inp-amt { font-family: var(--mono); font-size: 28px; font-weight: 400; height: 62px; text-align: center; direction: ltr; letter-spacing: -0.5px; }
    .inp-amt::placeholder { color: rgba(27,42,74,0.18); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       REPORT CARDS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .r-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin-bottom: 12px; }
    .rcard { background: var(--surf); border: 1.5px solid var(--bdr); border-radius: 12px; padding: 12px 6px; text-align: center; cursor: pointer; transition: all 0.18s ease; display: flex; flex-direction: column; align-items: center; gap: 3px; }
    .rcard:active { transform: scale(0.95); }
    .rcard.on { background: var(--navy); border-color: var(--navy); }
    .rcard.on .r-icon, .rcard.on .r-title, .rcard.on .r-sub { color: #fff; }
    .r-icon  { font-size: 18px; }
    .r-title { font-size: 11px; font-weight: 700; color: var(--navy); }
    .r-sub   { font-size: 8px; color: var(--muted); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SUBMIT BUTTON
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .btn-sub { width: 100%; height: 58px; border: none; border-radius: 12px; font-family: var(--font); font-size: 17px; font-weight: 700; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 12px; -webkit-appearance: none; transition: opacity 0.2s, transform 0.15s; }
    .btn-sub:active:not(:disabled) { opacity: 0.85; transform: scale(0.98); }
    .btn-sub:disabled { opacity: 0.3; cursor: not-allowed; }
    .b-inc { background: var(--forest); box-shadow: 0 4px 14px rgba(26,107,60,0.28); }
    .b-exp { background: var(--burg);   box-shadow: 0 4px 14px rgba(155,35,53,0.26); }
    .b-rep { background: var(--navy);   box-shadow: 0 4px 14px rgba(27,42,74,0.24); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LOCK BANNER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #lock-banner { display: none; padding: 14px; background: rgba(155,35,53,0.07); border: 1px solid rgba(155,35,53,0.22); border-radius: 12px; font-size: 13px; color: var(--burg); text-align: center; margin-bottom: 12px; }
    .lock-btn { width: 100%; margin-top: 8px; padding: 10px; background: var(--burg); color: #fff; border: none; border-radius: 10px; font-family: var(--font); font-size: 14px; font-weight: 700; cursor: pointer; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MODAL
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #modal { display: none; position: fixed; inset: 0; background: rgba(27,42,74,0.45); z-index: 7000; align-items: flex-end; backdrop-filter: blur(3px); }
    #modal.open { display: flex; }
    .m-sheet { background: var(--surf); border-radius: 24px 24px 0 0; padding: 24px 20px calc(36px + env(safe-area-inset-bottom)); width: 100%; animation: shup 0.3s ease; }
    @keyframes shup { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .m-title { font-size: 16px; font-weight: 700; text-align: center; margin-bottom: 16px; }
    .m-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--bdr); font-size: 13px; }
    .m-row:last-of-type { border: none; }
    .m-val { font-family: var(--mono); font-weight: 500; color: var(--forest); }
    .m-confirm { display: flex; align-items: center; gap: 10px; background: var(--bg); border-radius: 10px; padding: 12px; margin: 12px 0; cursor: pointer; font-size: 13px; }
    .m-confirm input { transform: scale(1.2); accent-color: var(--navy); }
    .m-ok { width: 100%; height: 50px; background: var(--forest); color: #fff; border: none; border-radius: 12px; font-family: var(--font); font-size: 15px; font-weight: 700; cursor: pointer; margin-bottom: 10px; }
    .m-cancel { width: 100%; height: 44px; background: var(--bg); color: var(--muted); border: none; border-radius: 12px; font-family: var(--font); font-size: 13px; font-weight: 600; cursor: pointer; }

    .hide     { display: none !important; }
    .disabled { opacity: 0.35; pointer-events: none; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DESKTOP LAYOUT  â‰¥ 769px
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @media (min-width: 769px) {

      html, body { height: 100%; overflow: hidden; }
      body { flex-direction: column; background: #E8E7E2; }

      #dt-topbar {
        flex-shrink: 0; height: 64px;
        background: #ffffff;
        display: flex !important;
        align-items: center;
        justify-content: space-between;
        padding: 0 36px;
        border-bottom: 3px solid var(--gold);
        box-shadow: 0 1px 8px rgba(27,42,74,0.07);
      }

      .dt-topbrand { display: flex; align-items: center; gap: 12px; direction: ltr; }
      .dt-brand-mark { display: flex; align-items: baseline; gap: 0; }
      .dt-b-idara { font-family: var(--font); font-size: 18px; font-weight: 700; color: var(--navy); letter-spacing: -0.3px; }
      .dt-b-pro   { font-family: var(--font); font-size: 18px; font-weight: 700; color: var(--burg); letter-spacing: -0.3px; }
      .dt-b-divider { width: 1px; height: 22px; background: #D0CEC8; margin: 0 12px; }
      .dt-b-platform { font-size: 9px; color: #aaa; letter-spacing: 0.3px; direction: ltr; line-height: 1.4; }
      .dt-b-platform span { font-weight: 600; color: #888; }

      .dt-bld { display: flex; flex-direction: column; align-items: flex-end; }
      .dt-bld-name { font-size: 15px; font-weight: 700; color: var(--navy); line-height: 1.2; direction: rtl; }
      .dt-bld-sub  { font-size: 9px; color: #aaa; letter-spacing: 0.5px; text-transform: uppercase; }

      /* Session info in topbar */
      .dt-session {
        display: flex;
        align-items: center;
        gap: 10px;
        direction: ltr;
      }

      .dt-session-name {
        font-size: 11px;
        font-weight: 700;
        color: var(--navy);
      }

      .dt-session-role {
        font-family: var(--mono);
        font-size: 8px;
        color: var(--muted);
        letter-spacing: 1px;
        text-transform: uppercase;
        padding: 2px 6px;
        border: 1px solid var(--bdr);
        border-radius: 4px;
      }

      .dt-logout {
        font-size: 10px;
        color: var(--muted);
        cursor: pointer;
        padding: 4px 10px;
        border: 1px solid var(--bdr);
        border-radius: 6px;
        transition: all 0.15s;
        font-family: var(--font);
      }

      .dt-logout:hover { color: var(--burg); border-color: var(--burg); }

      .dt-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--forest); box-shadow: 0 0 0 3px rgba(26,107,60,0.2); transition: all 0.3s; }
      .dt-dot.off { background: var(--burg); box-shadow: 0 0 0 3px rgba(155,35,53,0.2); }

      #dt-main {
        flex: 1; min-height: 0;
        display: flex !important;
        overflow: hidden;
      }

      #dt-sidebar {
        width: 320px; flex-shrink: 0;
        display: flex !important;
        flex-direction: column;
        gap: 16px;
        padding: 24px 20px;
        overflow-y: auto;
        background: #E0DFD9;
        border-left: 1px solid rgba(27,42,74,0.08);
      }
      #dt-sidebar::-webkit-scrollbar { display: none; }

      .dt-sidebar-label { font-size: 9px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); margin-bottom: -8px; }

      #dt-content {
        flex: 1; min-width: 0;
        display: flex !important;
        flex-direction: column;
        overflow: hidden;
        background: var(--bg);
      }

      #dt-tabs {
        flex-shrink: 0; height: 54px;
        background: var(--surf);
        border-bottom: 1px solid var(--bdr);
        display: flex !important;
        align-items: stretch;
        padding: 0 28px;
        gap: 4px;
        box-shadow: 0 1px 4px rgba(27,42,74,0.05);
      }

      .dt-tab { display: flex; align-items: center; gap: 8px; padding: 0 22px; border: none; background: none; font-family: var(--font); font-size: 13px; font-weight: 700; color: var(--muted); cursor: pointer; border-bottom: 2.5px solid transparent; transition: all 0.18s; }
      .dt-tab:hover { color: var(--navy); background: rgba(27,42,74,0.025); }
      .dt-tab.dt-inc { border-bottom-color: var(--forest); color: var(--forest); }
      .dt-tab.dt-exp { border-bottom-color: var(--burg);   color: var(--burg);   }
      .dt-tab.dt-rep { border-bottom-color: var(--navy);   color: var(--navy);   }
      .dt-tab-ico { font-size: 16px; }

      #dt-form-scroll { display: none; }

      #nav    { display: none !important; }

      #scroll {
        display: block !important;
        overflow-y: auto;
        padding: 28px 36px;
        flex: 1;
        min-height: 0;
      }

      #scroll .header     { display: none; }
      #scroll .dash-card  { display: none; }
      #scroll #lock-banner { max-width: 520px; }
      #scroll .card    { max-width: 520px; }
      #scroll .r-grid  { max-width: 520px; }
      #scroll #f-rep > .card { max-width: 520px; }

      .dash-card { margin-bottom: 0; border-radius: 16px; }

      #session-bar { display: none !important; } /* desktop uses topbar instead */

      #toast {
        bottom: 28px; left: 50%; right: auto;
        width: 360px;
        transform: translateX(-50%) translateY(8px);
      }
      #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

      #modal { align-items: center; justify-content: center; }
      .m-sheet {
        border-radius: 20px; max-width: 460px;
        padding: 32px 28px;
        animation: fadeUp 0.25s ease;
      }
      @keyframes fadeUp {
        from { opacity: 0; transform: translateY(16px); }
        to   { opacity: 1; transform: translateY(0); }
      }

      /* Login screen â€” larger on desktop */
      #login-screen {
        padding: 40px;
      }

      .lgn-pad {
        max-width: 280px;
      }
    }

    #dt-topbar, #dt-main { display: none; }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LOADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="loader">
  <div class="ldr-brand">idara<b>BUILDING</b></div>
  <div class="ldr-platform">a platform of <span>idara360</span></div>
  <div class="ldr-track"><div class="ldr-bar"></div></div>
  <div class="ldr-hint">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ / Loading...</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LOGIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="login-screen">

  <!-- Brand -->
  <div class="lgn-brand">
    <div class="lgn-brand-mark">
      <span class="lgn-b-idara">idara</span><span class="lgn-b-building">BUILDING</span>
    </div>
    <div class="lgn-b-tag">a platform of idara360</div>
  </div>

  <div class="lgn-divider"></div>

  <!-- Building name (filled after GAS call) -->
  <div class="lgn-bld" id="lgn-bld-name"></div>

  <!-- Welcome state (shown briefly after correct PIN) -->
  <div class="lgn-welcome" id="lgn-welcome">
    <div class="lgn-welcome-icon">âœ…</div>
    <div class="lgn-welcome-name" id="lgn-welcome-name"></div>
    <div class="lgn-welcome-role" id="lgn-welcome-role"></div>
  </div>

  <!-- Normal login state -->
  <div id="lgn-main">
    <div class="lgn-prompt">Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ / Enter PIN</div>

    <!-- PIN dots -->
    <div class="lgn-dots" id="lgn-dots">
      <div class="lgn-dot" id="d0"></div>
      <div class="lgn-dot" id="d1"></div>
      <div class="lgn-dot" id="d2"></div>
      <div class="lgn-dot" id="d3"></div>
    </div>

    <!-- Hidden input for desktop keyboard -->
    <input type="password" id="pin-input" inputmode="numeric"
           maxlength="4" autocomplete="off" pattern="[0-9]*">

    <!-- Numpad -->
    <div class="lgn-pad" id="lgn-pad">
      <button class="pad-btn" onclick="padPress('1')">1<span class="pad-letters"></span></button>
      <button class="pad-btn" onclick="padPress('2')">2<span class="pad-letters">ABC</span></button>
      <button class="pad-btn" onclick="padPress('3')">3<span class="pad-letters">DEF</span></button>
      <button class="pad-btn" onclick="padPress('4')">4<span class="pad-letters">GHI</span></button>
      <button class="pad-btn" onclick="padPress('5')">5<span class="pad-letters">JKL</span></button>
      <button class="pad-btn" onclick="padPress('6')">6<span class="pad-letters">MNO</span></button>
      <button class="pad-btn" onclick="padPress('7')">7<span class="pad-letters">PQRS</span></button>
      <button class="pad-btn" onclick="padPress('8')">8<span class="pad-letters">TUV</span></button>
      <button class="pad-btn" onclick="padPress('9')">9<span class="pad-letters">WXYZ</span></button>
      <div></div><!-- empty cell -->
      <button class="pad-btn pad-zero" onclick="padPress('0')">0</button>
      <button class="pad-btn pad-back" onclick="padBack()">âŒ«</button>
    </div>

    <!-- Verifying spinner (shown during GAS call) -->
    <div id="lgn-verifying">
      <div class="lgn-wave">
        <span></span><span></span><span></span><span></span><span></span>
      </div>
      <div class="lgn-verif-txt">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ / Verifying...</div>
    </div>

    <!-- Status + attempts (shown on wrong PIN / error) -->
    <div class="lgn-status" id="lgn-status"></div>
    <div class="lgn-attempts" id="lgn-attempts"></div>
  </div>

  <!-- Lockout banner -->
  <div id="lockout-banner">
    <div class="lo-icon">ğŸ”’</div>
    <div class="lo-title">ØªÙ… ØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨ / Account Locked</div>
    <div class="lo-msg">Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø®Ø§Ø·Ø¦Ø© Ù…ØªØ¹Ø¯Ø¯Ø©<br>Too many failed attempts</div>
    <div class="lo-timer" id="lo-timer">30:00</div>
    <div class="lo-msg" style="font-size:10px;">ÙŠÙØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± / Please wait</div>
  </div>

</div>
<!-- /login-screen -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SESSION BAR (mobile â€” shown below session start)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="session-bar">
  <div>
    <div class="sb-name" id="sb-name"></div>
    <div class="sb-role" id="sb-role"></div>
  </div>
  <div class="sb-logout" onclick="doLogout()">Ø®Ø±ÙˆØ¬ / Logout</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCROLL ZONE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="scroll">

  <div class="header">
    <div>
      <div class="bld-name" id="bldName">...</div>
      <div class="bld-sub">Building Management</div>
    </div>
    <div class="dot" id="dot"></div>
  </div>

  <div class="dash-card">
    <div class="d-top">
      <div>
        <div class="d-lbl-en">CASH ON HAND</div>
        <div class="d-lbl-ar">Ø§Ù„Ù†Ù‚Ø¯ Ø§Ù„Ù…ØªÙˆÙØ±</div>
      </div>
      <div class="d-heart" onclick="refreshDash()">
        <span class="d-heart-ico" id="heart">ğŸ’š</span>
        <span class="d-heart-pct" id="hpct">â€”%</span>
      </div>
    </div>
    <div class="d-amount" id="cashAmt">Loading...</div>
    <div class="d-line"></div>
    <div class="d-foot">
      <div class="d-time" id="dashTime">â€”</div>
      <button class="d-refresh" id="rBtn" onclick="refreshDash()">â†»</button>
    </div>
  </div>

  <div id="lock-banner">
    <strong>âš ï¸ Fiscal Year Mismatch</strong><br>
    <span id="lock-msg"></span>
    <button class="lock-btn" onclick="openFiscal()">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ù†Ø© / Close Year</button>
  </div>

  <form id="form" onsubmit="event.preventDefault(); doSubmit();">
    <input type="hidden" id="eType" value="Income">

    <div class="card" id="f-inc">
      <div class="lbl"><span class="l-ar">Ø´Ø§ØºÙ„ Ø§Ù„Ù‚Ø³Ù…</span><span class="l-en">Occupant of Unit</span></div>
      <select class="inp" id="sel-owner"><option value="" disabled selected>Ø§Ø®ØªØ± / Select...</option></select>
      <div class="lbl" style="margin-top:12px;"><span class="l-ar">Ø§Ù„ÙØ¦Ø©</span><span class="l-en">Category</span></div>
      <select class="inp" id="sel-icat"><option value="" disabled selected>Ø§Ø®ØªØ± / Select...</option></select>
    </div>

    <div class="card hide" id="f-exp">
      <div class="lbl"><span class="l-ar">ÙØ¦Ø© Ø§Ù„Ù…ØµØ±ÙˆÙ</span><span class="l-en">Expense Category</span></div>
      <select class="inp" id="sel-ecat"><option value="" disabled selected>Ø§Ø®ØªØ± / Select...</option></select>
    </div>

    <div class="hide" id="f-rep">
      <div class="r-grid">
        <div class="rcard on" id="rc-ytd" onclick="pickReport('YTD')">
          <span class="r-icon">ğŸ“Š</span><span class="r-title">YTD</span><span class="r-sub">ØªØ±Ø§ÙƒÙ…ÙŠ</span>
        </div>
        <div class="rcard" id="rc-month" onclick="pickReport('CurrentMonth')">
          <span class="r-icon">ğŸ“…</span><span class="r-title">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</span><span class="r-sub">This Month</span>
        </div>
        <div class="rcard" id="rc-journal" onclick="pickReport('Journal')">
          <span class="r-icon">ğŸ“–</span><span class="r-title">Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</span><span class="r-sub">Journal</span>
        </div>
      </div>
      <div class="card">
        <div class="lbl"><span class="l-ar">Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</span><span class="l-en">Report Type</span></div>
        <select class="inp" id="sel-rep" onchange="pickReport(this.value)">
          <option value="YTD">YTD â€” ØªØ±Ø§ÙƒÙ…ÙŠ Ø³Ù†ÙˆÙŠ</option>
          <option value="CurrentMonth">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± / This Month</option>
          <option value="LastMonth">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ / Last Month</option>
          <option value="Journal">Ø¯ÙØªØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ© / Journal</option>
        </select>
      </div>
    </div>

    <div class="card" id="f-amt">
      <div class="lbl"><span class="l-ar">Ø§Ù„Ù…Ø¨Ù„Øº</span><span class="l-en">Amount $</span></div>
      <input type="number" step="0.01" min="0" class="inp inp-amt" id="inp-amt" placeholder="0.00" inputmode="decimal">
    </div>

    <!-- Submit button â€” no more PIN field -->
    <div class="card">
      <button type="submit" class="btn-sub b-inc" id="btn-sub">
        <span id="btn-ico">ğŸ’°</span>
        <span id="btn-txt">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© / Record Payment</span>
      </button>
    </div>

  </form>

</div><!-- /scroll -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FIXED BOTTOM NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav id="nav">
  <div class="nav-tabs">
    <button class="nav-tab n-inc" id="t-inc" onclick="setTab('Income')">
      <span class="nav-ico">ğŸ’°</span>
      <span class="nav-ar">Ù‚Ø¨Ø¶</span>
      <span class="nav-en">Income</span>
    </button>
    <button class="nav-tab" id="t-exp" onclick="setTab('Expense')">
      <span class="nav-ico">ğŸ“‰</span>
      <span class="nav-ar">Ù…ØµØ±ÙˆÙ</span>
      <span class="nav-en">Expense</span>
    </button>
    <button class="nav-tab" id="t-rep" onclick="setTab('Report')">
      <span class="nav-ico">ğŸ“„</span>
      <span class="nav-ar">ØªÙ‚Ø§Ø±ÙŠØ±</span>
      <span class="nav-en">Reports</span>
    </button>
  </div>
  <div class="nav-brand">
    <div class="nb-wrap">
      <span class="nb-idara">idara</span>
      <span class="nb-sep"></span>
      <span class="nb-pro">BUILDING</span>
    </div>
    <div class="nb-tag">a platform of <b>idara360</b></div>
  </div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FISCAL MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="modal">
  <div class="m-sheet">
    <div class="m-title">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© / Year-End Closing</div>
    <div class="m-row"><span>Closing Year</span><span class="m-val" id="cy-close">â€”</span></div>
    <div class="m-row"><span>New Year</span><span class="m-val" id="cy-open">â€”</span></div>
    <div class="m-row"><span>Cash Carry Forward</span><span class="m-val" id="cy-cash">â€”</span></div>
    <div class="m-row"><span>Units</span><span class="m-val" id="cy-units">â€”</span></div>
    <label class="m-confirm">
      <input type="checkbox" id="conf-chk">
      I verify these balances are correct
    </label>
    <button class="m-ok" onclick="execClose()">Execute &amp; Close</button>
    <button class="m-cancel" onclick="closeModal()">Cancel / Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DESKTOP CHROME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="dt-topbar">
  <div class="dt-topbrand">
    <div class="dt-brand-mark">
      <span class="dt-b-idara">idara</span><span class="dt-b-pro">BUILDING</span>
    </div>
    <div class="dt-b-divider"></div>
    <div class="dt-b-platform">a platform of <span>idara360</span></div>
    <div class="dt-dot" id="dt-dot"></div>
  </div>
  <!-- Session info (shown after login) -->
  <div class="dt-session" id="dt-session" style="display:none;">
    <div>
      <div class="dt-session-name" id="dt-session-name"></div>
      <div class="dt-session-role" id="dt-session-role"></div>
    </div>
    <div class="dt-logout" onclick="doLogout()">Ø®Ø±ÙˆØ¬ / Logout</div>
  </div>
  <div class="dt-bld">
    <div class="dt-bld-name" id="dt-bldName">...</div>
    <div class="dt-bld-sub">Building Management</div>
  </div>
</div>

<div id="dt-main">
  <div id="dt-sidebar">
    <div class="dt-sidebar-label">Overview</div>
    <div class="dash-card" id="dt-dash">
      <div class="d-top">
        <div>
          <div class="d-lbl-en">CASH ON HAND</div>
          <div class="d-lbl-ar">Ø§Ù„Ù†Ù‚Ø¯ Ø§Ù„Ù…ØªÙˆÙØ±</div>
        </div>
        <div class="d-heart" onclick="refreshDash()">
          <span class="d-heart-ico" id="dt-heart">ğŸ’š</span>
          <span class="d-heart-pct" id="dt-hpct">â€”%</span>
        </div>
      </div>
      <div class="d-amount" id="dt-cashAmt">Loading...</div>
      <div class="d-line"></div>
      <div class="d-foot">
        <div class="d-time" id="dt-dashTime">â€”</div>
        <button class="d-refresh" id="dt-rBtn" onclick="refreshDash()">â†»</button>
      </div>
    </div>
  </div>

  <div id="dt-content">
    <div id="dt-tabs">
      <button class="dt-tab dt-inc" id="dt-t-inc" onclick="setTab('Income')">
        <span class="dt-tab-ico">ğŸ’°</span> Ù‚Ø¨Ø¶ / Income
      </button>
      <button class="dt-tab" id="dt-t-exp" onclick="setTab('Expense')">
        <span class="dt-tab-ico">ğŸ“‰</span> Ù…ØµØ±ÙˆÙ / Expense
      </button>
      <button class="dt-tab" id="dt-t-rep" onclick="setTab('Report')">
        <span class="dt-tab-ico">ğŸ“„</span> ØªÙ‚Ø§Ø±ÙŠØ± / Reports
      </button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>

// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var GAS = 'https://script.google.com/macros/s/AKfycbxAXi3phO9lrfi9cWmbIVID-kwnbWSogVB7wM3PwvNi40y8uOgmmrHdU-EqIHz_rkXv/exec';
var SESSION_DURATION_MS = 8 * 60 * 60 * 1000;  // 8 hours
var MAX_ATTEMPTS        = 5;
var LOCKOUT_DURATION_MS = 30 * 60 * 1000;       // 30 minutes

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var TAB     = 'Income';
var REPORT  = 'YTD';
var _fiscal = null;
var _rtimer = null;
var _ttimer = null;
var _sessionTimer = null;

// Login state
var _pinBuffer    = '';
var _attempts     = 0;
var _lockedUntil  = 0;
var _lockTimer    = null;

// Session (in-memory only)
// { token, name, role, permissions, expires }
var _session = null;

// â”€â”€ GAS helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gasGet(action) {
  return fetch(GAS + '?action=' + action)
    .then(function(r) { return r.json(); })
    .then(function(r) { if (!r.ok) throw new Error(r.error); return r.data; });
}

function gasPost(body) {
  return fetch(GAS, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' },
    body: JSON.stringify(body)
  })
    .then(function(r) { return r.json(); })
    .then(function(r) { if (!r.ok) throw new Error(r.error); return r.data; });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onload = function() {
  // Fetch building name for login screen (lightweight getAppData call)
  gasGet('getBuildingName')
    .then(function(name) {
      if (name) {
        document.getElementById('lgn-bld-name').textContent = name;
        document.getElementById('dt-bldName').textContent   = name;
      }
    })
    .catch(function() {});

  // Show login screen, focus hidden input for desktop keyboard
  showLoginScreen();
  hideLo();
  watchNet();
};

function hideLo() {
  var lo = document.getElementById('loader');
  if (!lo) return;
  lo.classList.add('out');
  setTimeout(function() { lo.style.display = 'none'; }, 500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGIN SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showLoginScreen() {
  var ls = document.getElementById('login-screen');
  ls.style.display = 'flex';
  ls.classList.remove('out');
  _pinBuffer = '';
  _attempts  = 0;
  updateDots();
  setLoginStatus('');

  // Focus hidden input so desktop keyboard works
  setTimeout(function() {
    document.getElementById('pin-input').focus();
  }, 100);

  // Check if still locked out
  if (_lockedUntil > Date.now()) {
    showLockout();
  }
}

function hideLoginScreen() {
  var ls = document.getElementById('login-screen');
  ls.classList.add('out');
  setTimeout(function() { ls.style.display = 'none'; }, 420);
}

// â”€â”€ PIN buffer management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function padPress(digit) {
  if (_lockedUntil > Date.now()) return;
  if (_pinBuffer.length >= 4) return;
  _pinBuffer += digit;
  updateDots();
  // Sync hidden input (for consistency)
  document.getElementById('pin-input').value = _pinBuffer;
  if (_pinBuffer.length === 4) {
    setTimeout(submitPin, 120); // tiny delay so last dot fills visually
  }
}

function padBack() {
  if (_lockedUntil > Date.now()) return;
  if (_pinBuffer.length === 0) return;
  _pinBuffer = _pinBuffer.slice(0, -1);
  updateDots();
  document.getElementById('pin-input').value = _pinBuffer;
}

function updateDots() {
  for (var i = 0; i < 4; i++) {
    var dot = document.getElementById('d' + i);
    dot.classList.remove('filled', 'error', 'success');
    if (i < _pinBuffer.length) dot.classList.add('filled');
  }
}

function setDotsError() {
  for (var i = 0; i < 4; i++)
    document.getElementById('d' + i).classList.add('error');
  document.getElementById('lgn-dots').classList.add('shake');
  setTimeout(function() {
    document.getElementById('lgn-dots').classList.remove('shake');
  }, 500);
}

function setDotsSuccess() {
  for (var i = 0; i < 4; i++) {
    document.getElementById('d' + i).classList.remove('filled');
    document.getElementById('d' + i).classList.add('success');
  }
}

function setLoginStatus(msg) {
  document.getElementById('lgn-status').textContent = msg;
}

function setAttemptsMsg(msg) {
  document.getElementById('lgn-attempts').textContent = msg;
}

// â”€â”€ PIN submission â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function submitPin() {
  if (_lockedUntil > Date.now()) return;

  var pin = _pinBuffer;
  _pinBuffer = '';
  updateDots();

  // Show verifying spinner, hide status text
  disablePad(true);
  showVerifying(true);
  setLoginStatus('');

  gasPost({ action: 'login', pin: pin })
    .then(function(auth) {
      showVerifying(false);
      disablePad(false);
      if (!auth) {
        onWrongPin();
        return;
      }
      onLoginSuccess(auth);
    })
    .catch(function(e) {
      showVerifying(false);
      disablePad(false);
      setLoginStatus('âš ï¸ Connection error. Try again.');
      setTimeout(function() { setLoginStatus(''); }, 3000);
    });
}

function disablePad(state) {
  var btns = document.querySelectorAll('.pad-btn');
  btns.forEach(function(b) { b.disabled = state; });
}

function showVerifying(state) {
  var el = document.getElementById('lgn-verifying');
  if (state) {
    el.classList.add('show');
  } else {
    el.classList.remove('show');
  }
}

// â”€â”€ Wrong PIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onWrongPin() {
  _attempts++;
  setDotsError();

  var remaining = MAX_ATTEMPTS - _attempts;

  if (remaining <= 0) {
    // Lockout
    _lockedUntil = Date.now() + LOCKOUT_DURATION_MS;
    _attempts = 0;
    setTimeout(showLockout, 600);
    return;
  }

  var msg = 'Ø±Ù…Ø² Ø®Ø§Ø·Ø¦ / Wrong PIN';
  if (remaining <= 2) {
    msg += ' â€” ' + remaining + ' attempt' + (remaining === 1 ? '' : 's') + ' remaining';
  }
  setLoginStatus(msg);
  setAttemptsMsg('');

  // Clear dots after shake
  setTimeout(function() {
    for (var i = 0; i < 4; i++)
      document.getElementById('d' + i).classList.remove('error', 'filled');
    setLoginStatus('');
  }, 1200);
}

// â”€â”€ Lockout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLockout() {
  document.getElementById('lgn-main').style.display  = 'none';
  document.getElementById('lockout-banner').classList.add('show');
  startLockoutCountdown();
}

function startLockoutCountdown() {
  if (_lockTimer) clearInterval(_lockTimer);
  _lockTimer = setInterval(function() {
    var remaining = Math.max(0, _lockedUntil - Date.now());
    var mins = Math.floor(remaining / 60000);
    var secs = Math.floor((remaining % 60000) / 1000);
    document.getElementById('lo-timer').textContent =
      pad(mins) + ':' + pad(secs);

    if (remaining <= 0) {
      clearInterval(_lockTimer);
      _lockTimer = null;
      _lockedUntil = 0;
      hideLockout();
    }
  }, 1000);
}

function hideLockout() {
  document.getElementById('lgn-main').style.display  = '';
  document.getElementById('lockout-banner').classList.remove('show');
  setLoginStatus('');
  setAttemptsMsg('');
  updateDots();
}

// â”€â”€ Login success â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onLoginSuccess(auth) {
  setDotsSuccess();
  _attempts = 0;

  // Brief welcome message
  document.getElementById('lgn-main').style.display = 'none';
  var welcome = document.getElementById('lgn-welcome');
  welcome.classList.add('show');
  document.getElementById('lgn-welcome-name').textContent =
    'Ø£Ù‡Ù„Ø§Ù‹ØŒ ' + auth.name + ' / Welcome';
  document.getElementById('lgn-welcome-role').textContent =
    auth.role.toUpperCase();

  // Start session
  startSession(auth);

  // Transition to main app after welcome flash
  setTimeout(function() {
    hideLoginScreen();
    launchApp(auth);
  }, 900);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SESSION MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function startSession(auth) {
  var now = Date.now();
  _session = {
    token:       auth.name + '_' + now,
    name:        auth.name,
    role:        auth.role,
    permissions: auth.permissions,
    expires:     now + SESSION_DURATION_MS
  };

  // Auto-expire
  if (_sessionTimer) clearTimeout(_sessionTimer);
  _sessionTimer = setTimeout(function() {
    toast('â± Session expired. Please log in again.', 'info');
    setTimeout(doLogout, 2500);
  }, SESSION_DURATION_MS);
}

function sessionValid() {
  return _session && Date.now() < _session.expires;
}

function doLogout() {
  _session = null;
  if (_sessionTimer) { clearTimeout(_sessionTimer); _sessionTimer = null; }
  if (_rtimer)       { clearInterval(_rtimer);       _rtimer = null; }

  // Hide session bar + desktop session info
  document.getElementById('session-bar').classList.remove('show');
  var dtSess = document.getElementById('dt-session');
  if (dtSess) dtSess.style.display = 'none';

  // Reset welcome state for next login
  document.getElementById('lgn-welcome').classList.remove('show');
  document.getElementById('lgn-main').style.display = '';
  for (var i = 0; i < 4; i++)
    document.getElementById('d' + i).classList.remove('filled','error','success');

  showLoginScreen();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP LAUNCH (called after successful login)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function launchApp(auth) {
  // Show session bar on mobile
  document.getElementById('sb-name').textContent = auth.name;
  document.getElementById('sb-role').textContent = auth.role;
  document.getElementById('session-bar').classList.add('show');

  // Show desktop session info
  var dtSess = document.getElementById('dt-session');
  if (dtSess) {
    document.getElementById('dt-session-name').textContent = auth.name;
    document.getElementById('dt-session-role').textContent = auth.role;
    dtSess.style.display = 'flex';
  }

  // Apply tab visibility based on permissions
  applyPermissionUI(auth);

  // Load app data from GAS
  gasGet('getAppData')
    .then(function(d) { initApp(d); })
    .catch(function() {
      toast('âš ï¸ Could not load app data. Check connection.', 'fail');
    });

  // Start dashboard refresh
  refreshDash();
  _rtimer = setInterval(refreshDash, 30000);

  // On desktop: move #scroll into #dt-content
  if (window.innerWidth >= 769) {
    var dtContent = document.getElementById('dt-content');
    var scroll    = document.getElementById('scroll');
    if (dtContent && scroll && !dtContent.contains(scroll)) {
      dtContent.appendChild(scroll);
    }
  }
}

function applyPermissionUI(auth) {
  var perms = auth.permissions;
  var role  = auth.role;

  // Mobile nav tabs
  var tInc = document.getElementById('t-inc');
  var tExp = document.getElementById('t-exp');
  var tRep = document.getElementById('t-rep');

  // Desktop tabs
  var dtInc = document.getElementById('dt-t-inc');
  var dtExp = document.getElementById('dt-t-exp');
  var dtRep = document.getElementById('dt-t-rep');

  // For Admin â€” show everything (no changes needed)
  if (role === 'Admin') return;

  // For Management â€” hide tabs the user has no permissions for
  // (hide income tab if no INC permission AND no EXP permission, etc.)
  // Only hide a tab if the user has NO relevant permissions at all
  var hasAnyReport = perms.REP_YTD || perms.REP_CUR || perms.REP_LST || perms.REP_JRN;

  if (!perms.INC) { tInc.classList.add('hide'); if(dtInc) dtInc.classList.add('hide'); }
  if (!perms.EXP) { tExp.classList.add('hide'); if(dtExp) dtExp.classList.add('hide'); }
  if (!hasAnyReport) { tRep.classList.add('hide'); if(dtRep) dtRep.classList.add('hide'); }

  // If income tab hidden, default to first visible tab
  if (!perms.INC) {
    if (perms.EXP) setTab('Expense');
    else if (hasAnyReport) setTab('Report');
  }

  // Hide report type options the user can't access
  if (!perms.REP_YTD)  document.querySelector('[value="YTD"]')          && (document.querySelector('#sel-rep [value="YTD"]').style.display    = 'none');
  if (!perms.REP_CUR)  document.querySelector('#sel-rep [value="CurrentMonth"]') && (document.querySelector('#sel-rep [value="CurrentMonth"]').style.display = 'none');
  if (!perms.REP_LST)  document.querySelector('#sel-rep [value="LastMonth"]')    && (document.querySelector('#sel-rep [value="LastMonth"]').style.display    = 'none');
  if (!perms.REP_JRN)  document.querySelector('#sel-rep [value="Journal"]')      && (document.querySelector('#sel-rep [value="Journal"]').style.display      = 'none');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT APP (unchanged logic, called after login)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function initApp(d) {
  if (!d) return;
  window._cats = { income: d.incomeCategories || [], expense: d.expenseCategories || [] };
  if (d.legal && d.legal['BUILDING_NAME']) {
    document.getElementById('bldName').textContent    = d.legal['BUILDING_NAME'];
    document.getElementById('dt-bldName').textContent = d.legal['BUILDING_NAME'];
    document.getElementById('lgn-bld-name').textContent = d.legal['BUILDING_NAME'];
  }

  var sel  = document.getElementById('sel-owner');
  var frag = document.createDocumentFragment();
  var ph   = new Option('Ø§Ø®ØªØ± / Select...', '');
  ph.disabled = true; ph.selected = true;
  frag.appendChild(ph);
  (d.owners || []).forEach(function(o) {
    var opt = new Option(o.display, o.name);
    opt.dataset.section    = o.section    || '';
    opt.dataset.contractId = o.contractId || '';
    frag.appendChild(opt);
  });
  sel.innerHTML = ''; sel.appendChild(frag);

  fillCats('income');

  if (d.fiscal && d.fiscal.locked) {
    document.getElementById('lock-banner').style.display = 'block';
    document.getElementById('lock-msg').textContent = d.fiscal.msg || '';
    document.getElementById('form').classList.add('disabled');
  }

  setTab('Income');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CATEGORIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function fillCats(type) {
  var cats  = (window._cats && window._cats[type]) ? window._cats[type] : [];
  var selId = type === 'income' ? 'sel-icat' : 'sel-ecat';
  var sel   = document.getElementById(selId);
  var frag  = document.createDocumentFragment();
  var ph    = new Option('Ø§Ø®ØªØ± / Select...', '');
  ph.disabled = true; ph.selected = true;
  frag.appendChild(ph);
  cats.forEach(function(c) { frag.appendChild(new Option(c, c)); });
  sel.innerHTML = ''; sel.appendChild(frag);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function setTab(type) {
  TAB = type;
  document.getElementById('eType').value = type;

  ['t-inc','t-exp','t-rep'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.className = 'nav-tab';
  });

  ['dt-t-inc','dt-t-exp','dt-t-rep'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.className = 'dt-tab';
  });

  ['f-inc','f-exp','f-rep','f-amt'].forEach(function(id) {
    document.getElementById(id).classList.add('hide');
  });

  var btn = document.getElementById('btn-sub');
  var ico = document.getElementById('btn-ico');
  var txt = document.getElementById('btn-txt');

  if (type === 'Income') {
    document.getElementById('t-inc').classList.add('n-inc');
    if (document.getElementById('dt-t-inc')) document.getElementById('dt-t-inc').classList.add('dt-inc');
    document.getElementById('f-inc').classList.remove('hide');
    document.getElementById('f-amt').classList.remove('hide');
    fillCats('income');
    btn.className = 'btn-sub b-inc';
    ico.textContent = 'ğŸ’°'; txt.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© / Record Payment';

  } else if (type === 'Expense') {
    document.getElementById('t-exp').classList.add('n-exp');
    if (document.getElementById('dt-t-exp')) document.getElementById('dt-t-exp').classList.add('dt-exp');
    document.getElementById('f-exp').classList.remove('hide');
    document.getElementById('f-amt').classList.remove('hide');
    fillCats('expense');
    btn.className = 'btn-sub b-exp';
    ico.textContent = 'ğŸ“‰'; txt.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ / Record Expense';

  } else {
    document.getElementById('t-rep').classList.add('n-rep');
    if (document.getElementById('dt-t-rep')) document.getElementById('dt-t-rep').classList.add('dt-rep');
    document.getElementById('f-rep').classList.remove('hide');
    pickReport('YTD');
    btn.className = 'btn-sub b-rep';
    ico.textContent = 'ğŸ“§'; txt.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± / Send Report';
  }

  document.getElementById('inp-amt').value = '';
  document.getElementById('scroll').scrollTop = 0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REPORT CARDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function pickReport(type) {
  REPORT = type;
  var sel = document.getElementById('sel-rep');
  if (sel) sel.value = type;
  ['rc-ytd','rc-month','rc-journal'].forEach(function(id) {
    document.getElementById(id).classList.remove('on');
  });
  var map = { 'YTD':'rc-ytd', 'CurrentMonth':'rc-month', 'Journal':'rc-journal' };
  if (map[type]) document.getElementById(map[type]).classList.add('on');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function refreshDash() {
  if (!sessionValid()) return;

  var rb   = document.getElementById('rBtn');
  var dtRb = document.getElementById('dt-rBtn');
  rb.classList.add('spin');
  if (dtRb) dtRb.classList.add('spin');

  gasGet('getDashboardStats')
    .then(function(v) {
      var val = v || '$0.00';
      var n = new Date();
      var t = pad(n.getHours()) + ':' + pad(n.getMinutes()) + ':' + pad(n.getSeconds());
      var isNeg = val.indexOf('-') !== -1;
      var amtColor = isNeg ? '#FF4D6A' : '#ffffff';
      document.getElementById('cashAmt').textContent     = val;
      document.getElementById('cashAmt').style.color     = amtColor;
      document.getElementById('dt-cashAmt').textContent  = val;
      document.getElementById('dt-cashAmt').style.color  = amtColor;
      document.getElementById('dashTime').textContent    = t;
      document.getElementById('dt-dashTime').textContent = t;
      rb.classList.remove('spin');
      if (dtRb) dtRb.classList.remove('spin');
    })
    .catch(function() {
      rb.classList.remove('spin');
      if (dtRb) dtRb.classList.remove('spin');
    });

  gasGet('getBuildingHealth')
    .then(function(r) {
      var pct = r && r.pct != null ? r.pct : 0;
      var ico = pct >= 80 ? 'ğŸ’š' : pct >= 50 ? 'ğŸ§¡' : 'â¤ï¸';
      document.getElementById('hpct').textContent     = pct + '%';
      document.getElementById('dt-hpct').textContent  = pct + '%';
      document.getElementById('heart').textContent    = ico;
      document.getElementById('dt-heart').textContent = ico;
    })
    .catch(function() {});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUBMIT (no more PIN field â€” uses session token)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function doSubmit() {
  if (!sessionValid()) {
    toast('â± Session expired. Please log in again.', 'fail');
    setTimeout(doLogout, 1500);
    return;
  }

  var type = TAB;

  if (type !== 'Report') {
    var amt = parseFloat(document.getElementById('inp-amt').value);
    if (!amt || amt <= 0) {
      toast('âŒ Enter a valid amount', 'fail');
      markErr(document.getElementById('inp-amt'));
      return;
    }
    if (type === 'Income' && !document.getElementById('sel-owner').value) {
      toast('âŒ Select an occupant', 'fail');
      markErr(document.getElementById('sel-owner'));
      return;
    }
  }

  var cat = '';
  if (type === 'Income')  cat = document.getElementById('sel-icat').value;
  if (type === 'Expense') cat = document.getElementById('sel-ecat').value;
  if (type !== 'Report' && !cat) {
    toast('âŒ Select a category', 'fail');
    return;
  }

  var btn = document.getElementById('btn-sub');
  btn.disabled = true;
  toast('â³ Processing...', 'info');

  var tmout = setTimeout(function() {
    onFail({ message: 'Timed out. Try again.' });
  }, 30000);

  if (type === 'Report') {
    gasPost({
      action: 'processReportRequest',
      reportType: document.getElementById('sel-rep').value,
      token: _session.token
    })
      .then(function(r) {
        clearTimeout(tmout);
        onOk(r.msg || r);
      })
      .catch(function(e) { clearTimeout(tmout); onFail(e); });

  } else {
    var ownerSel = document.getElementById('sel-owner');
    var selOpt   = ownerSel.selectedIndex >= 0 ? ownerSel.options[ownerSel.selectedIndex] : null;
    var payload  = {
      entryType:  type,
      ownerName:  type === 'Income' ? ownerSel.value : '',
      category:   cat,
      amount:     document.getElementById('inp-amt').value,
      unit:       selOpt ? (selOpt.dataset.section    || '') : '',
      contractId: selOpt ? (selOpt.dataset.contractId || '') : '',
      token:      _session.token
    };

    gasPost({ action: 'processEntry', payload: payload })
      .then(function(r) {
        clearTimeout(tmout);
        onOk(r);
      })
      .catch(function(e) { clearTimeout(tmout); onFail(e); });
  }
}

function onOk(msg) {
  var ok = msg && (msg.includes('âœ…') || msg.includes('success') || msg.includes('Saved'));
  toast(msg, ok ? 'ok' : 'fail');
  document.getElementById('btn-sub').disabled = false;
  if (ok && TAB !== 'Report') {
    document.getElementById('inp-amt').value = '';
    refreshDash();
  }
}

function onFail(e) {
  toast('âŒ ' + (e.message || String(e)), 'fail');
  document.getElementById('btn-sub').disabled = false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function toast(msg, type) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.className   = type || 'info';
  t.classList.add('show');
  if (_ttimer) clearTimeout(_ttimer);
  _ttimer = setTimeout(function() {
    t.classList.remove('show');
  }, type === 'fail' ? 5000 : 3000);
}

function markErr(el) {
  if (!el) return;
  el.classList.add('err');
  setTimeout(function() { el.classList.remove('err'); }, 1800);
}

function pad(n) { return String(n).padStart(2, '0'); }

function watchNet() {
  var dot   = document.getElementById('dot');
  var dtDot = document.getElementById('dt-dot');
  window.addEventListener('online',  function() {
    dot.classList.remove('off');
    if (dtDot) dtDot.classList.remove('off');
    toast('âœ… Back online', 'ok');
  });
  window.addEventListener('offline', function() {
    dot.classList.add('off');
    if (dtDot) dtDot.classList.add('off');
    toast('âš ï¸ No internet', 'fail');
  });
}

// â”€â”€ Desktop keyboard support for PIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('pin-input').addEventListener('input', function(e) {
  var val = this.value.replace(/\D/g, '').slice(0, 4);
  this.value = val;
  _pinBuffer = val;
  updateDots();
  if (_pinBuffer.length === 4) {
    setTimeout(submitPin, 120);
  }
});

document.getElementById('pin-input').addEventListener('keydown', function(e) {
  if (e.key === 'Backspace' && _pinBuffer.length > 0) {
    _pinBuffer = _pinBuffer.slice(0, -1);
    this.value = _pinBuffer;
    updateDots();
  }
});

// â”€â”€ App keyboard shortcuts (only when logged in) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', function(e) {
  if (!sessionValid()) return;
  if (e.altKey && e.key === '1') { e.preventDefault(); setTab('Income'); }
  if (e.altKey && e.key === '2') { e.preventDefault(); setTab('Expense'); }
  if (e.altKey && e.key === '3') { e.preventDefault(); setTab('Report'); }
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    e.preventDefault();
    var b = document.getElementById('btn-sub');
    if (!b.disabled) doSubmit();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FISCAL CLOSE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openFiscal() {
  if (!sessionValid()) return;
  gasGet('previewFiscalClose')
    .then(function(d) {
      _fiscal = d;
      document.getElementById('cy-close').textContent = d.yearClosing;
      document.getElementById('cy-open').textContent  = d.yearOpening;
      document.getElementById('cy-cash').textContent  = '$' + d.cashCarryForward.toFixed(2);
      document.getElementById('cy-units').textContent = d.unitCount;
      document.getElementById('modal').classList.add('open');
    })
    .catch(function(e) { toast('âŒ ' + e.message, 'fail'); });
}

function execClose() {
  if (!document.getElementById('conf-chk').checked) {
    toast('Please confirm first', 'fail');
    return;
  }
  gasPost({ action: 'commitFiscalClose', payload: _fiscal })
    .then(function(msg) {
      toast(msg, 'ok');
      closeModal();
      setTimeout(function() { location.reload(); }, 2000);
    })
    .catch(function(e) { toast('âŒ ' + e.message, 'fail'); });
}

function closeModal() {
  document.getElementById('modal').classList.remove('open');
}

</script>
</body>
</html>
