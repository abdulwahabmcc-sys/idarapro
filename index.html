/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUILDING MANAGER APP - Code.gs  v25.2
   Changes from v25.1:
     - doGet() now acts as API router for GitHub Pages frontend
     - doPost() added to handle form submissions from GitHub Pages frontend
     - All existing functions unchanged
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// ============================================================================
// ARABIC NUMERAL HELPERS
// ============================================================================

function toArabicNumerals(text) {
  var westernToArabic = {'0':'Ù ','1':'Ù¡','2':'Ù¢','3':'Ù£','4':'Ù¤','5':'Ù¥','6':'Ù¦','7':'Ù§','8':'Ù¨','9':'Ù©'};
  return String(text).replace(/[0-9]/g, function(c) { return westernToArabic[c] || c; });
}

function normalizeArabicNumerals(text) {
  if (!text) return text;
  var map = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
  return String(text).replace(/[Ù -Ù©]/g, function(c) { return map[c] || c; });
}

function parseArabicNumber(value) {
  if (value === null || value === undefined || value === '') return 0;
  var n = parseFloat(normalizeArabicNumerals(String(value)));
  return isNaN(n) ? 0 : n;
}

// ============================================================================
// MENU
// ============================================================================

function onOpen() {
  SpreadsheetApp.getUi().createMenu('ğŸ¢ Building Manager')
    .addItem('Launch App', 'showSidebar')
    .addToUi();
}

// ============================================================================
// doGet â€” serves HTML for direct GAS URL, OR returns JSON for API calls
// ============================================================================

function doGet(e) {
  // No action param = serve the Sidebar HTML (direct GAS URL access)
  if (!e || !e.parameter || !e.parameter.action) {
    return HtmlService.createHtmlOutputFromFile('Sidebar')
      .setTitle('347 Portal')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  }

  // API mode â€” GitHub Pages frontend calls with ?action=xxx
  var action = e.parameter.action;
  var result;

  try {
    if (action === 'getAppData') {
      result = { ok: true, data: JSON.parse(getAppData()) };

    } else if (action === 'getDashboardStats') {
      result = { ok: true, data: getDashboardStats() };

    } else if (action === 'getBuildingHealth') {
      result = { ok: true, data: getBuildingHealth() };

    } else if (action === 'previewFiscalClose') {
      result = { ok: true, data: previewFiscalClose() };

    } else {
      result = { ok: false, error: 'Unknown action: ' + action };
    }
  } catch(err) {
    result = { ok: false, error: err.message };
  }

  return ContentService
    .createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

// ============================================================================
// doPost â€” handles form submissions from GitHub Pages frontend
// ============================================================================

function doPost(e) {
  var result;

  try {
    var body   = JSON.parse(e.postData.contents);
    var action = body.action;

    if (action === 'processEntry') {
      result = { ok: true, data: processEntry(body.payload) };

    } else if (action === 'processReportRequest') {
      result = { ok: true, data: processReportRequest(body.reportType, body.pin) };

    } else if (action === 'commitFiscalClose') {
      result = { ok: true, data: commitFiscalClose(body.payload) };

    } else {
      result = { ok: false, error: 'Unknown action: ' + action };
    }
  } catch(err) {
    result = { ok: false, error: err.message };
  }

  return ContentService
    .createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

// ============================================================================
// SIDEBAR (for Google Sheets menu launch)
// ============================================================================

function showSidebar() {
  var html = HtmlService.createHtmlOutputFromFile('Sidebar')
    .setTitle('347 Portal').setWidth(450);
  SpreadsheetApp.getUi().showSidebar(html);
}

// ============================================================================
// DASHBOARD
// ============================================================================

function getDashboardStats() {
  try {
    var ss   = SpreadsheetApp.getActiveSpreadsheet();
    var year = new Date().getFullYear();
    var open = getCashOpeningForYear(year);
    var data = ss.getSheetByName("Entries").getDataRange().getValues();
    var delta = 0;
    for (var i = 1; i < data.length; i++) {
      if (new Date(data[i][0]).getFullYear() === year)
        delta += parseArabicNumber(data[i][10]);
    }
    return "$" + (open + delta).toFixed(2);
  } catch(e) { Logger.log('getDashboardStats: ' + e); return '$0.00'; }
}

function getCashOpeningForYear(year) {
  try {
    var rows = SpreadsheetApp.getActiveSpreadsheet()
      .getSheetByName("YearCash").getRange("A2:B").getValues();
    for (var i = 0; i < rows.length; i++)
      if (rows[i][0] == year) return parseArabicNumber(rows[i][1]);
    return parseArabicNumber(getLegalSettings()['BUILDING_CASH_OPENING']);
  } catch(e) { return 0; }
}

// ============================================================================
// GET CASH BALANCE
// ============================================================================

function getCashBalance() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var today = new Date();
    var currentYear = today.getFullYear();
    var opening = getCashOpeningForYear(currentYear);
    var entries = ss.getSheetByName("Entries").getDataRange().getValues();
    var totalIncome = 0;
    var totalExpense = 0;
    for (var i = 1; i < entries.length; i++) {
      var entryDate = entries[i][0];
      if (!entryDate) continue;
      var year = new Date(entryDate).getFullYear();
      if (year !== currentYear) continue;
      var type = String(entries[i][4]).trim();
      var amount = parseFloat(entries[i][7]) || 0;
      if (type === 'Inflow') { totalIncome += amount; }
      else if (type === 'Outflow') { totalExpense += amount; }
    }
    var cashBalance = opening + totalIncome - totalExpense;
    return '$' + cashBalance.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  } catch(e) {
    Logger.log('getCashBalance error: ' + e);
    return '$0.00';
  }
}

// ============================================================================
// GET BUILDING HEALTH
// ============================================================================

function getBuildingHealth() {
  try {
    var ss      = SpreadsheetApp.getActiveSpreadsheet();
    var year    = new Date().getFullYear();
    var today   = new Date();
    var rules   = getFeeRules(ss);
    var open    = getCashOpeningForYear(year);

    var occData = ss.getSheetByName("Occupancy").getDataRange().getValues();
    var bldData = ss.getSheetByName("Building").getDataRange().getValues();

    var unitDetailsMap = {};
    for (var j = 1; j < bldData.length; j++) {
      var uid = String(bldData[j][0]).trim();
      if (uid) {
        var ampVal  = parseArabicNumber(bldData[j][5]);
        unitDetailsMap[uid] = {
          section:  String(bldData[j][1]).trim(),
          type:     bldData[j][4],
          sqm:      bldData[j][3] || 0,
          amperes:  (ampVal && !isNaN(ampVal) && ampVal > 0) ? ampVal : 0
        };
      }
    }

    var contractMap = {};
    for (var i = 1; i < occData.length; i++) {
      var contractId = String(occData[i][7]).trim();
      var cName      = String(occData[i][0]).trim();
      var section    = String(occData[i][1]).trim();
      var unitId     = String(occData[i][4]).trim();
      var sDate      = occData[i][2] ? new Date(occData[i][2]) : null;
      var eDate      = occData[i][6] ? new Date(occData[i][6]) : null;

      if (!contractId) continue;
      if (eDate && eDate < today) continue;

      var ud = unitDetailsMap[unitId] || { type:'', sqm:0, amperes:0 };
      var dueStart = sDate && sDate > new Date(year,0,1) ? sDate : new Date(year,0,1);
      var dueEnd   = today;

      var due = calculateStandardDues(
        normalizeArabicNumerals(section),
        { type: ud.type, sqm: ud.sqm, amperes: ud.amperes, unitId: unitId, contractId: contractId },
        dueStart, dueEnd, rules
      );

      contractMap[contractId] = { name: cName, section: section, due: due, paid: 0, prev: 0 };
    }

    var opData = ss.getSheetByName("OpeningBalance").getDataRange().getValues();
    for (var i = 1; i < opData.length; i++) {
      var opSec  = normalizeArabicNumerals(String(opData[i][1]).trim());
      var opName = String(opData[i][2]).trim();
      var opYear = opData[i][3];
      var opPrev = parseArabicNumber(opData[i][5]);
      if (opYear != year) continue;
      for (var cId in contractMap) {
        var c = contractMap[cId];
        if (normalizeArabicNumerals(c.section) === opSec && (c.name === opName || opName === '-')) {
          c.prev = opPrev; break;
        }
      }
    }

    var entries = ss.getSheetByName("Entries").getDataRange().getValues();
    for (var i = 1; i < entries.length; i++) {
      var d = new Date(entries[i][0]);
      if (d.getFullYear() !== year) continue;
      if (entries[i][4] !== 'Inflow') continue;
      var cId = String(entries[i][9]).trim();
      var amt = parseArabicNumber(entries[i][10]);
      if (contractMap[cId]) contractMap[cId].paid += amt;
    }

    var total = 0, healthy = 0;
    for (var cId in contractMap) {
      var c = contractMap[cId];
      var bal = c.prev + c.paid - c.due;
      total++;
      if (bal >= 0) healthy++;
    }

    var pct = total > 0 ? Math.round((healthy / total) * 100) : 0;
    Logger.log('getBuildingHealth: ' + healthy + '/' + total + ' = ' + pct + '%');
    return { pct: pct, healthy: healthy, total: total };

  } catch(e) {
    Logger.log('getBuildingHealth error: ' + e);
    return { pct: 0, healthy: 0, total: 0 };
  }
}

// ============================================================================
// GET APP DATA
// ============================================================================

function getAppData() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var incomeCategories = [];
    var expenseCategories = [];
    var activeNames = [];
    var list = [];

    try { incomeCategories = getIncomeCategories(); } catch(e) { incomeCategories = ['Ø³Ù„ÙØ© Ø¹Ù† ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø§Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©']; }
    try { expenseCategories = getExpenseCategories(); } catch(e) { expenseCategories = ['Ø±ÙˆØ§ØªØ¨', 'ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ù„Ø¨Ù†Ø§Ù†', 'Ù…ØµØ§Ø±ÙŠÙ Ù…ØªÙØ±Ù‚Ø©']; }

    try {
      activeNames = ss.getSheetByName("Contacts").getDataRange().getValues()
        .filter(function(r){ return r[4] === 'Active'; })
        .map(function(r){ return String(r[1]).trim(); });
    } catch(e) { activeNames = []; }

    try {
      var occSheet    = ss.getSheetByName("Occupancy");
      var occRows     = occSheet.getDataRange().getDisplayValues();
      var occRowsDate = occSheet.getDataRange().getValues();
      var today       = new Date(); today.setHours(0,0,0,0);

      for (var i = 1; i < occRows.length; i++) {
        var cName      = String(occRows[i][0]).trim();
        var section    = String(occRows[i][1]).trim();
        var sDate      = occRowsDate[i][2] ? new Date(occRowsDate[i][2]) : null;
        var eDate      = occRowsDate[i][6] ? new Date(occRowsDate[i][6]) : null;
        var contractId = String(occRows[i][7]).trim();

        if (!cName || !section) continue;
        if (activeNames.indexOf(cName) === -1) continue;
        if (sDate && sDate > today) continue;
        if (eDate && eDate < today) continue;

        var startDisplay = sDate ? Utilities.formatDate(sDate, "GMT+2", "MM/yyyy") : "";
        var display = startDisplay
          ? cName + ' - ' + section + ' (since ' + startDisplay + ')'
          : cName + ' - ' + section;

        list.push({ display: display, name: cName, section: section, contractId: contractId });
      }

      list.sort(function(a,b){ return parseArabicNumber(a.section) - parseArabicNumber(b.section); });
    } catch(e) { list = []; }

    var result = {
      owners: list,
      incomeCategories: incomeCategories,
      expenseCategories: expenseCategories,
      legal: {},
      fiscal: {}
    };

    try { result.legal = getLegalSettings(); } catch(e) { result.legal = { BUILDING_NAME: 'Ø¹Ù‚Ø§Ø± Ù£Ù¤Ù§ Ø§Ù„Ù…ØµÙŠØ·Ø¨Ø©' }; }
    try { result.fiscal = getFiscalStatus(); } catch(e) { result.fiscal = { locked: false }; }

    Logger.log('getAppData: owners=' + result.owners.length + ', income=' + result.incomeCategories.length + ', expense=' + result.expenseCategories.length);
    return JSON.stringify(result);

  } catch(e) {
    Logger.log('getAppData CRITICAL: ' + e);
    return JSON.stringify({
      owners: [],
      incomeCategories: ['Ø³Ù„ÙØ© Ø¹Ù† ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø§Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©'],
      expenseCategories: ['Ø±ÙˆØ§ØªØ¨', 'ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ù„Ø¨Ù†Ø§Ù†', 'Ù…ØµØ§Ø±ÙŠÙ Ù…ØªÙØ±Ù‚Ø©'],
      legal: { BUILDING_NAME: 'Ø¹Ù‚Ø§Ø± Ù£Ù¤Ù§ Ø§Ù„Ù…ØµÙŠØ·Ø¨Ø©' },
      fiscal: { locked: false }
    });
  }
}

// ============================================================================
// PROCESS ENTRY
// ============================================================================

function processEntry(f) {
  try {
    Logger.log('====== processEntry ======');
    Logger.log('entryType : [' + f.entryType + ']');
    Logger.log('ownerName : [' + f.ownerName + ']');
    Logger.log('unit      : [' + f.unit      + ']');
    Logger.log('contractId: [' + f.contractId + ']');
    Logger.log('category  : [' + f.category  + ']');
    Logger.log('amount    : [' + f.amount    + ']');

    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var a  = validatePin(f.pin);
    if (!a) return "âŒ Invalid PIN";

    var entryType = (f.entryType === 'Income')  ? 'Inflow'  :
                    (f.entryType === 'Expense') ? 'Outflow' : f.entryType;

    var unitSection = '';
    if (entryType === 'Inflow') {
      unitSection = String(f.unit || '').trim();
      if (!unitSection) return "âŒ Error: Unit/section is missing. Please re-select the occupant.";
    }

    var category = f.category;
    if (!category) return "âŒ Error: Category is required. Please select a category.";

    var amount = parseArabicNumber(f.amount);
    var n      = new Date();
    var year   = n.getFullYear();
    var dateOnly = new Date(year, n.getMonth(), n.getDate());

    var trxId = generateTrxId(ss, entryType, year);
    if (!trxId) return "âŒ Error: Could not generate TRX ID. Please ensure year " + year + " is initialized in the YearCash sheet.";

    var sheet = ss.getSheetByName("Entries");
    if (!sheet) return "âŒ Error: Entries sheet not found";

    var lastRow = sheet.getLastRow();
    var newRow  = lastRow + 1;
    var contractId = String(f.contractId || '').trim();
    var netAmount  = (entryType === 'Outflow') ? -Math.abs(amount) : Math.abs(amount);

    sheet.appendRow([
      dateOnly, trxId, "", f.ownerName, entryType,
      category, "", amount, a.name, contractId, netAmount
    ]);

    if (entryType === 'Inflow' && unitSection) {
      var unitCell = sheet.getRange(newRow, 3);
      unitCell.setNumberFormat('@STRING@');
      unitCell.setValue(unitSection);
    }

    Logger.log('âœ… Saved: ' + trxId);
    if (entryType === 'Inflow') return "âœ… Payment recorded successfully ($" + amount + ")";
    else return "âœ… Expense recorded successfully ($" + amount + ")";

  } catch(e) {
    Logger.log('processEntry error: ' + e);
    return "âŒ Error: " + e.message;
  }
}

// ============================================================================
// TRX ID GENERATION
// ============================================================================

function generateTrxId(ss, entryType, year) {
  try {
    var isInflow  = (entryType === 'Inflow');
    var prefix    = isInflow ? 'INC' : 'EXP';
    var colIndex  = isInflow ? 3 : 4;
    var ycSheet   = ss.getSheetByName("YearCash");
    var ycData    = ycSheet.getRange("A2:E").getValues();
    var yearRow   = -1;
    for (var i = 0; i < ycData.length; i++) {
      if (ycData[i][0] == year) { yearRow = i; break; }
    }
    if (yearRow === -1) return null;
    var currentCounter = parseArabicNumber(ycData[yearRow][colIndex]) || 0;
    var newCounter     = currentCounter + 1;
    ycSheet.getRange(yearRow + 2, colIndex + 1).setValue(newCounter);
    var padded = String(newCounter);
    while (padded.length < 5) padded = '0' + padded;
    return prefix + '-' + year + '-' + padded;
  } catch(e) {
    Logger.log('generateTrxId error: ' + e);
    return null;
  }
}

// ============================================================================
// FISCAL STATUS
// ============================================================================

function getFiscalStatus() {
  try {
    var ledger = SpreadsheetApp.getActiveSpreadsheet()
      .getSheetByName("YearCash").getRange("A2:A").getValues()
      .flat().filter(Number);
    var y    = new Date().getFullYear();
    var last = ledger.length ? Math.max.apply(null, ledger) : y - 1;
    return { locked: y > last + 1, currentYear: y, lastClosed: last,
             msg: y > last + 1 ? "âš ï¸ Year " + (last+1) + " is not initialized." : "" };
  } catch(e) { return { locked:false, currentYear:new Date().getFullYear(), lastClosed:0, msg:'' }; }
}

// ============================================================================
// PIN VALIDATION
// ============================================================================

function validatePin(pin) {
  try {
    var data = SpreadsheetApp.getActiveSpreadsheet()
      .getSheetByName("AdminSettings").getDataRange().getDisplayValues();
    for (var i = 1; i < data.length; i++)
      if (data[i][6] === String(pin).trim())
        return { name: data[i][0], email: data[i][4] };
    return null;
  } catch(e) { Logger.log('validatePin: ' + e); return null; }
}

// ============================================================================
// REPORTS
// ============================================================================

function processReportRequest(reportType, pin) { return sendReport(reportType, pin); }

function sendReport(t, p) {
  try {
    var a = validatePin(p);
    if (!a) return { msg: "âŒ Invalid PIN" };
    if (!a.email || String(a.email).trim() === '')
      return { msg: "âŒ No email configured for your account." };

    var now = new Date(), y = now.getFullYear(), m = now.getMonth();
    var start, end, sub, blob;

    if (t === 'YTD') {
      start = new Date(y,0,1); end = now; sub = "Year " + y;
      blob  = createFinancialPDF(start, end, sub, 'YTD', y);
    } else if (t === 'CurrentMonth' || t === 'Monthly') {
      start = new Date(y,m,1); end = now;
      sub   = Utilities.formatDate(start,"GMT+2","MMMM yyyy");
      blob  = createFinancialPDF(start, end, sub, 'MONTHLY', y);
    } else if (t === 'Journal') {
      start = new Date(y,0,1); end = now;
      sub   = "Ø¯ÙØªØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¹Ø§Ù… - " + y;
      blob  = createJournalPDF(start, end, sub, y);
    } else if (t === 'LastMonth') {
      var pM = m===0?11:m-1, pY = m===0?y-1:y;
      start  = new Date(pY,pM,1); end = new Date(pY,pM+1,0);
      sub    = Utilities.formatDate(start,"GMT+2","MMMM yyyy");
      blob   = createFinancialPDF(start, end, sub, 'MONTHLY', y);
    } else {
      return { msg: "âŒ Unknown report type: " + t };
    }

    MailApp.sendEmail({ to: a.email, subject: "Report: "+sub,
      body: "Report attached.\n\nGenerated: "+Utilities.formatDate(new Date(),"GMT+2","dd/MM/yyyy HH:mm"),
      attachments: [blob] });

    return { msg: "âœ… Report sent successfully to " + a.email };
  } catch(e) { Logger.log('sendReport: '+e); return { msg:"âŒ Error: "+e.message }; }
}

// ============================================================================
// JOURNAL PDF
// ============================================================================

function createJournalPDF(reportStart, reportEnd, subTitle, year) {
  try {
    var ss      = SpreadsheetApp.getActiveSpreadsheet();
    var legal   = getLegalSettings();
    var raw     = ss.getSheetByName("Entries").getDataRange().getValues();
    var openBal = getCashOpeningForYear(year);
    var running = openBal;
    var entries = [], totalIn = 0, totalOut = 0;

    for (var i = 1; i < raw.length; i++) {
      var d = new Date(raw[i][0]);
      if (d.getFullYear()===year && d>=reportStart && d<=reportEnd) {
        var net = parseArabicNumber(raw[i][10]);
        running += net;
        var isIn = raw[i][4]==='Inflow';
        if (isIn) totalIn += parseArabicNumber(raw[i][7]);
        else     totalOut += parseArabicNumber(raw[i][7]);
        entries.push({
          date:raw[i][0], unit:raw[i][2], name:raw[i][3],
          type:raw[i][4], cat:raw[i][5],
          contractId:String(raw[i][9]).trim(),
          admin:String(raw[i][8]).trim() || '-',
          amt:parseArabicNumber(raw[i][7]), net:net, bal:running
        });
      }
    }

    var html = getCommonCSS()+'<div class="page">';
    html += '<div style="text-align:center;margin-bottom:20px;"><h2 style="margin:0;">'+legal['JOURNAL_TITLE']+'</h2>';
    html += '<div style="color:#555;">'+legal['JOURNAL_SUBTITLE']+'</div></div>';
    html += '<div class="disclaimer">'+legal['JOURNAL_DISCLAIMER']+'</div>';
    html += '<div class="financial-card"><h3 style="margin-top:0;border-bottom:1px solid #ddd;padding-bottom:5px;">ğŸ’° Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ù„ÙŠ</h3>';
    html += '<table class="no-border-table">';
    html += '<tr><td>Ø±ØµÙŠØ¯ Ù…Ø¯ÙˆÙ‘Ø± Ù…Ù† Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:</td><td style="text-align:left;">$'+openBal.toFixed(2)+'</td></tr>';
    html += '<tr><td>'+legal['JOURNAL_HEAD_IN']+' (+):</td><td style="text-align:left;color:#27ae60;">+ $'+totalIn.toFixed(2)+'</td></tr>';
    html += '<tr><td>'+legal['JOURNAL_HEAD_OUT']+' (-):</td><td style="text-align:left;color:#c0392b;">- $'+totalOut.toFixed(2)+'</td></tr>';
    html += '<tr><td colspan="2"><hr style="border:none;border-top:1px solid #eee;"></td></tr>';
    html += '<tr style="font-size:16px;font-weight:bold;"><td>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</td>';
    html += '<td style="text-align:left;color:'+(running>=0?'#27ae60':'#c0392b')+';">$'+running.toFixed(2)+'</td></tr>';
    html += '</table></div>';
    html += '<h3 style="color:#2c3e50;border-bottom:2px solid #2c3e50;padding-bottom:5px;">ğŸ“– '+legal['JOURNAL_LBL_TABLE']+'</h3>';
    html += '<table><thead><tr>';
    html += '<th class="contract-id-header">Contract ID</th>';
    html += '<th>'+legal['JOURNAL_HEAD_DATE']+'</th>';
    html += '<th>'+legal['JOURNAL_HEAD_DESC']+'</th>';
    html += '<th>'+legal['JOURNAL_HEAD_CAT']+'</th>';
    html += '<th class="amount-header">'+legal['JOURNAL_HEAD_IN']+'</th>';
    html += '<th class="amount-header">'+legal['JOURNAL_HEAD_OUT']+'</th>';
    html += '<th class="amount-header">'+legal['JOURNAL_HEAD_BAL']+'</th>';
    html += '<th>Ø§Ù„Ù…Ø³Ø¬Ù„</th>';
    html += '</tr></thead><tbody>';

    entries.forEach(function(e){
      var isIn = e.type==='Inflow';
      html += '<tr><td class="contract-id">'+e.contractId+'</td>';
      html += '<td>'+formatDate(e.date)+'</td>';
      html += '<td style="text-align:right;">'+(e.unit?e.unit+' - ':'')+e.name+'</td>';
      html += '<td style="text-align:right;">'+(e.cat||'-')+'</td>';
      html += '<td class="amount-col" style="color:#27ae60;">'+(isIn?'$'+e.amt.toFixed(2):'-')+'</td>';
      html += '<td class="amount-col" style="color:#c0392b;">'+(!isIn?'$'+e.amt.toFixed(2):'-')+'</td>';
      html += '<td class="amount-col" style="color:'+(e.bal>=0?'#27ae60':'#c0392b')+';font-weight:bold;">$'+e.bal.toFixed(2)+'</td>';
      html += '<td style="font-size:11px;color:#666;">'+e.admin+'</td></tr>';
    });

    html += '<tr style="background:#f8f9fa;font-weight:bold;border-top:2px solid #2c3e50;"><td colspan="4" style="text-align:right;">'+legal['JOURNAL_LBL_TOTALS']+'</td>';
    html += '<td class="amount-col" style="color:#27ae60;">$'+totalIn.toFixed(2)+'</td>';
    html += '<td class="amount-col" style="color:#c0392b;">$'+totalOut.toFixed(2)+'</td>';
    html += '<td class="amount-col">$'+running.toFixed(2)+'</td><td></td></tr>';
    html += '</tbody></table>'+getFooter(legal,'JOURNAL')+'</div>';
    return createPdfBlob(html,'Journal_Report');
  } catch(e) { Logger.log('createJournalPDF: '+e); throw new Error('Journal PDF failed: '+e.message); }
}

// ============================================================================
// FINANCIAL PDF (Monthly / YTD)
// ============================================================================

function createFinancialPDF(reportStart, reportEnd, subTitle, typePrefix, year) {
  try {
    var ss    = SpreadsheetApp.getActiveSpreadsheet();
    var legal = getLegalSettings();
    var p     = typePrefix + "_";
    var isYTD = (typePrefix === 'YTD');
    var raw   = ss.getSheetByName("Entries").getDataRange().getValues();
    var open  = getCashOpeningForYear(year);
    var rules = getFeeRules(ss);

    var bldData = ss.getSheetByName("Building").getDataRange().getValues();
    var unitDetailsMap = {};
    for (var j=1; j<bldData.length; j++) {
      var uid = String(bldData[j][0]).trim();
      if (uid) {
        var ampVal = parseArabicNumber(bldData[j][5]);
        unitDetailsMap[uid] = {
          section: String(bldData[j][1]).trim(), type: bldData[j][4],
          sqm: bldData[j][3] || 0,
          amperes: (ampVal && !isNaN(ampVal) && ampVal > 0) ? ampVal : 0
        };
      }
    }

    var occData = ss.getSheetByName("Occupancy").getDataRange().getValues();
    var contractMap = {};
    for (var i=1; i<occData.length; i++) {
      var contractId = String(occData[i][7]).trim();
      var cName      = String(occData[i][0]).trim();
      var section    = String(occData[i][1]).trim();
      var unitId     = String(occData[i][4]).trim();
      var sDate      = occData[i][2] ? new Date(occData[i][2]) : null;
      var eDate      = occData[i][6] ? new Date(occData[i][6]) : null;
      if (!contractId) continue;
      var status = 'Active';
      if (eDate && eDate < reportEnd) status = 'Closed';
      var unitDetails = unitDetailsMap[unitId] || {type:'', sqm:0, amperes:0};
      contractMap[contractId] = {
        name: cName, section: section, sectionDisplay: section,
        unitId: unitId, unitType: unitDetails.type, unitSqm: unitDetails.sqm,
        unitAmperes: unitDetails.amperes, contractId: contractId,
        status: status, startDate: sDate, endDate: eDate,
        paid: 0, due: 0, prev: 0
      };
    }

    for (var cId in contractMap) {
      var c = contractMap[cId];
      var cStart = c.startDate || new Date(year,0,1);
      var cEnd = c.endDate || reportEnd;
      if (cStart <= reportEnd && cEnd >= new Date(year,0,1)) {
        var dueStart = cStart > new Date(year,0,1) ? cStart : new Date(year,0,1);
        var dueEnd = cEnd < reportEnd ? cEnd : reportEnd;
        c.due = calculateStandardDues(
          normalizeArabicNumerals(c.section),
          {type: c.unitType, sqm: c.unitSqm, amperes: c.unitAmperes, unitId: c.unitId, contractId: c.contractId},
          dueStart, dueEnd, rules
        );
      }
    }

    var opData = ss.getSheetByName("OpeningBalance").getDataRange().getValues();
    for (var i=1; i<opData.length; i++) {
      var opSec = normalizeArabicNumerals(String(opData[i][1]).trim());
      var opName = String(opData[i][2]).trim();
      var opYear = opData[i][3];
      var opPrev = parseArabicNumber(opData[i][5]);
      if (opYear == year) {
        for (var cId in contractMap) {
          var c = contractMap[cId];
          if (normalizeArabicNumerals(c.section) === opSec && (c.name === opName || opName === '-')) {
            c.prev = opPrev; if (opName !== '-') c.name = opName; break;
          }
        }
      }
    }

    var tInM=0,tOutM=0,tInY=0,tOutY=0,incRows=[],expRows=[];
    for(var i=1;i<raw.length;i++){
      var d=new Date(raw[i][0]);
      var net=parseArabicNumber(raw[i][10]);
      if(d.getFullYear()===year && d<=reportEnd){
        if(raw[i][4]==='Inflow'){
          tInY+=net;
          var cId = String(raw[i][9]).trim();
          if(cId && contractMap[cId]) contractMap[cId].paid += net;
        } else { tOutY+=net; }
        if(d>=reportStart){
          if(raw[i][4]==='Inflow'){tInM+=net; incRows.push(raw[i]);}
          else{tOutM+=Math.abs(net); expRows.push(raw[i]);}
        }
      }
    }
    var cash=open+tInY+tOutY;

    var html=getCommonCSS()+'<div class="page">';
    html+='<div style="text-align:center;margin-bottom:20px;"><h2 style="margin:0;">'+legal[p+'TITLE']+'</h2>';
    html+='<div style="font-weight:bold;color:#555;margin-top:5px;">'+subTitle+'</div></div>';
    html+='<div class="disclaimer">'+legal[p+'DISCLAIMER']+'</div>';
    html+='<div class="financial-card"><h3 style="margin-top:0;border-bottom:1px solid #ddd;padding-bottom:5px;">ğŸ’° '+legal[p+'LBL_FIN_POS']+'</h3>';
    html+='<table class="no-border-table">';
    html+='<tr><td>'+legal[p+'LBL_CARRY_FWD']+' (01/01/'+year+'):</td><td>$'+open.toFixed(2)+'</td></tr>';
    html+='<tr><td>'+legal[p+'LBL_TOTAL_IN']+' (YTD):</td><td style="color:#27ae60;">+ $'+tInY.toFixed(2)+'</td></tr>';
    html+='<tr><td>'+legal[p+'LBL_TOTAL_OUT']+' (YTD):</td><td style="color:#c0392b;">$'+tOutY.toFixed(2)+'</td></tr>';
    html+='<tr><td colspan="2"><hr></td></tr>';
    html+='<tr style="font-size:16px;font-weight:bold;"><td>'+legal[p+'LBL_CASH']+':</td><td style="color:#2980b9;">$'+cash.toFixed(2)+'</td></tr>';
    html+='</table></div>';

    html+='<h3 style="color:#27ae60;border-bottom:2px solid #27ae60;padding-bottom:5px;">ğŸ“¥ '+legal[p+'LBL_TOTAL_IN']+' ($'+tInM.toFixed(2)+')</h3>';
    if(isYTD){
      var cTot={};
      incRows.forEach(function(r){ var cId=String(r[9]).trim(),amt=parseArabicNumber(r[7]); if(!cTot[cId]) cTot[cId]={name:r[3],section:r[2],total:0}; cTot[cId].total+=amt; });
      for(var cId in contractMap){ if(!cTot[cId]) cTot[cId]={name:contractMap[cId].name,section:contractMap[cId].sectionDisplay,total:0}; }
      html+='<table><thead><tr><th class="contract-id-header">Contract ID</th><th>'+legal['YTD_HEAD_UNIT']+'</th><th>'+legal['YTD_HEAD_OCCUPANT']+'</th><th class="amount-header">'+legal['YTD_HEAD_AMT']+'</th></tr></thead><tbody>';
      Object.keys(cTot).sort(function(a,b){ return parseArabicNumber(cTot[a].section)-parseArabicNumber(cTot[b].section); }).forEach(function(cId){
        html+='<tr><td class="contract-id">'+cId+'</td><td>'+(cTot[cId].section||"-")+'</td><td style="text-align:right;">'+cTot[cId].name+'</td><td class="amount-col">$'+cTot[cId].total.toFixed(2)+'</td></tr>';
      });
      html+='</tbody></table>';
    } else {
      var cTotMonth={};
      incRows.forEach(function(r){ var cId=String(r[9]).trim(),amt=parseArabicNumber(r[7]); if(!cTotMonth[cId]) cTotMonth[cId]={name:r[3],section:r[2],total:0}; cTotMonth[cId].total+=amt; });
      for(var cId in contractMap){ if(!cTotMonth[cId]) cTotMonth[cId]={name:contractMap[cId].name,section:contractMap[cId].sectionDisplay,total:0}; }
      html+='<table><thead><tr><th class="contract-id-header">Contract ID</th><th>'+legal['MONTHLY_HEAD_UNIT']+'</th><th>'+legal['MONTHLY_HEAD_OCCUPANT']+'</th><th class="amount-header">'+legal['MONTHLY_HEAD_AMT']+'</th></tr></thead><tbody>';
      Object.keys(cTotMonth).sort(function(a,b){ return parseArabicNumber(cTotMonth[a].section)-parseArabicNumber(cTotMonth[b].section); }).forEach(function(cId){
        html+='<tr><td class="contract-id">'+cId+'</td><td>'+(cTotMonth[cId].section||"-")+'</td><td style="text-align:right;">'+cTotMonth[cId].name+'</td><td class="amount-col">$'+cTotMonth[cId].total.toFixed(2)+'</td></tr>';
      });
      html+='<tr style="background:#e8f5e9;font-weight:bold;border-top:2px solid #27ae60;"><td colspan="3" style="text-align:right;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ù„Ù„ÙØªØ±Ø©</td><td class="amount-col">$'+tInM.toFixed(2)+'</td></tr>';
      html+='<tr style="background:#c8e6c9;font-weight:bold;"><td colspan="3" style="text-align:right;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø­ØªÙ‰ ØªØ§Ø±ÙŠØ®Ù‡ (YTD)</td><td class="amount-col">$'+tInY.toFixed(2)+'</td></tr>';
      html+='</tbody></table>';
    }
    html+='<div class="transition-notice notice-expense">â¬‡ï¸ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© â¬‡ï¸</div><div class="page_break"></div>';

    html+='<h3 style="color:#c0392b;border-bottom:2px solid #c0392b;padding-bottom:5px;">ğŸ“¤ '+legal[p+'LBL_TOTAL_OUT']+' ($'+tOutM.toFixed(2)+')</h3>';
    if(isYTD){
      var cTot={};
      expRows.forEach(function(r){ var c=r[5],amt=parseArabicNumber(r[7]); if(!cTot[c]) cTot[c]=0; cTot[c]+=amt; });
      html+='<table><thead><tr><th>'+legal['YTD_HEAD_CAT']+'</th><th>'+legal['YTD_HEAD_AMT']+'</th></tr></thead><tbody>';
      Object.keys(cTot).sort(function(a,b){return cTot[b]-cTot[a];}).forEach(function(c){ html+='<tr><td style="text-align:right;">'+c+'</td><td>$'+cTot[c].toFixed(2)+'</td></tr>'; });
      html+='</tbody></table>';
    } else {
      html+='<table><thead><tr><th>'+legal['MONTHLY_HEAD_DATE']+'</th><th>'+legal['MONTHLY_HEAD_CAT']+'</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>'+legal['MONTHLY_HEAD_AMT']+'</th><th>'+legal['MONTHLY_HEAD_ADMIN']+'</th></tr></thead><tbody>';
      expRows.forEach(function(r){ html+='<tr><td>'+formatDate(r[0])+'</td><td style="text-align:right;">'+r[5]+'</td><td style="text-align:right;">'+r[6]+'</td><td>$'+parseArabicNumber(r[7]).toFixed(2)+'</td><td>'+r[8]+'</td></tr>'; });
      html+='<tr style="background:#ffebee;font-weight:bold;border-top:2px solid #c0392b;"><td colspan="3" style="text-align:right;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ù„Ù„ÙØªØ±Ø©</td><td>$'+tOutM.toFixed(2)+'</td><td></td></tr>';
      html+='<tr style="background:#ffcdd2;font-weight:bold;"><td colspan="3" style="text-align:right;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø­ØªÙ‰ ØªØ§Ø±ÙŠØ®Ù‡ (YTD)</td><td>$'+Math.abs(tOutY).toFixed(2)+'</td><td></td></tr>';
      html+='</tbody></table>';
    }
    html+='<div class="transition-notice notice-balance">â¬‡ï¸ Ù…Ø³Ø§Ù‡Ù…Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ø£Ø±ØµØ¯Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© â¬‡ï¸</div><div class="page_break"></div>';

    html+='<h3 style="color:#8e44ad;border-bottom:2px solid #8e44ad;padding-bottom:5px;">ğŸ“‹ '+legal[p+'LBL_UNIT_CONTRIB']+'</h3>';
    html+='<table><thead><tr><th class="contract-id-header">Contract ID</th><th>'+legal['MONTHLY_HEAD_UNIT']+'</th><th>'+legal['MONTHLY_HEAD_OCCUPANT']+'</th><th class="amount-header">'+legal['MONTHLY_HEAD_PREV']+'</th><th class="amount-header">'+legal['MONTHLY_HEAD_DUE']+'</th><th class="amount-header">'+legal['MONTHLY_HEAD_AMT']+'</th><th class="amount-header">'+legal['MONTHLY_HEAD_FINAL']+'</th></tr></thead><tbody>';
    Object.keys(contractMap).sort(function(a,b){ return parseArabicNumber(contractMap[a].section)-parseArabicNumber(contractMap[b].section); }).forEach(function(cId){
      var c=contractMap[cId], bal=c.prev+c.paid-c.due, col=bal<0?'#c0392b':'#27ae60';
      html+='<tr><td class="contract-id">'+cId+'</td><td>'+c.sectionDisplay+'</td><td style="text-align:right;">'+c.name+'</td><td class="amount-col">$'+c.prev.toFixed(2)+'</td><td class="amount-col">$'+c.due.toFixed(2)+'</td><td class="amount-col">$'+c.paid.toFixed(2)+'</td><td class="amount-col" style="font-weight:bold;color:'+col+';">$'+bal.toFixed(2)+'</td></tr>';
    });
    html+='</tbody></table>'+getFooter(legal,typePrefix)+'</div>';
    return createPdfBlob(html,typePrefix+'_Report');
  } catch(e) { Logger.log('createFinancialPDF: '+e); throw new Error('PDF failed: '+e.message); }
}

// ============================================================================
// FEE CALCULATION
// ============================================================================

function getUnitOverrides(ss, unitId) {
  try {
    if (!unitId) return [];
    var sheet = ss.getSheetByName("Unit_Fee_Overrides");
    if (!sheet) return [];
    var data = sheet.getDataRange().getValues();
    var overrides = [];
    for (var i = 1; i < data.length; i++) {
      if (String(data[i][0]).trim() !== unitId) continue;
      overrides.push({
        type: String(data[i][1]).trim(),
        value: parseArabicNumber(data[i][2]),
        appliesTo: String(data[i][3]).trim(),
        start: data[i][5] ? new Date(data[i][5]) : null,
        end: data[i][6] ? new Date(data[i][6]) : null
      });
    }
    return overrides;
  } catch(e) { return []; }
}

function calculateStandardDues(u, details, start, end, rules) {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var overrides = getUnitOverrides(ss, details.unitId);
    var total = 0;
    var cursor = new Date(start.getFullYear(), start.getMonth(), 1);

    while (cursor <= end) {
      var monthTotal = 0;
      var monthDeductions = [];
      var cursorMonth = cursor.getMonth();
      var cursorYear  = cursor.getFullYear();
      var daysInMonth = new Date(cursorYear, cursorMonth + 1, 0).getDate();

      rules.forEach(function(rule) {
        var override = overrides.find(function(o) {
          return (o.appliesTo === 'All' || o.appliesTo === rule.name) &&
                 (!o.start || cursor >= o.start) && (!o.end || cursor <= o.end);
        });
        if (override && override.type === 'Exempt') return;
        if (override && override.type === 'Deduction') {
          monthDeductions.push({ amount: override.value || 0, appliesTo: override.appliesTo });
          override = null;
        }

        var applies = false;
        if      (rule.targetType === 'All')           { applies = true; }
        else if (rule.targetType === 'Category')      { applies = (rule.targetValue === details.type); }
        else if (rule.targetType === 'Specific-Unit') { applies = (rule.targetValue === details.unitId); }
        else if (rule.targetType === 'Contract')      { applies = (rule.targetValue === details.contractId); }
        if (!applies) return;

        var ruleStart = rule.start || new Date(2000, 0, 1);
        var ruleEnd   = rule.end   || new Date(2100, 0, 1);
        var monthStart = new Date(cursorYear, cursorMonth, 1);
        var monthEnd   = new Date(cursorYear, cursorMonth, daysInMonth);
        if (!((ruleStart <= monthEnd) && (ruleEnd >= monthStart))) return;

        var amount = 0;
        var feeType = rule.feeType || 'Fixed';
        if      (feeType === 'Fixed')      { amount = rule.baseRate || 0; }
        else if (feeType === 'Per-SqM')    { amount = (rule.baseRate || 0) * (details.sqm     || 0); }
        else if (feeType === 'Per-Ampere') { amount = (rule.baseRate || 0) * (details.amperes || 0); }
        else                               { amount = rule.baseRate || 0; }
        if (isNaN(amount) || !amount) amount = 0;

        if (override) {
          if      (override.type === 'Custom-Rate')      { amount = override.value || 0; }
          else if (override.type === 'Discount-Percent') { amount = amount * (1 - (override.value || 0) / 100); }
        }

        var prorationRule = rule.prorationRule || 'Full-Month';
        if (prorationRule === 'Daily') {
          var ruleStartDay = 1, contractStartDay = 1;
          if (ruleStart.getFullYear() === cursorYear && ruleStart.getMonth() === cursorMonth) ruleStartDay = ruleStart.getDate();
          if (start.getFullYear() === cursorYear && start.getMonth() === cursorMonth) contractStartDay = start.getDate();
          var effectiveStartDay = Math.max(ruleStartDay, contractStartDay);
          var ruleEndDay = daysInMonth, periodEndDay = daysInMonth;
          if (ruleEnd.getFullYear() === cursorYear && ruleEnd.getMonth() === cursorMonth) ruleEndDay = ruleEnd.getDate();
          if (end.getFullYear() === cursorYear && end.getMonth() === cursorMonth) periodEndDay = end.getDate();
          var effectiveEndDay = Math.min(ruleEndDay, periodEndDay);
          var daysToCharge = Math.max(0, effectiveEndDay - effectiveStartDay + 1);
          if (daysToCharge < daysInMonth) amount = amount * (daysToCharge / daysInMonth);
        }

        monthTotal += amount;
      });

      var allDeduction = monthDeductions.find(function(d) { return d.appliesTo === 'All'; });
      if (allDeduction) { monthTotal -= allDeduction.amount; if (monthTotal < 0) monthTotal = 0; }

      total += monthTotal;
      cursor.setMonth(cursor.getMonth() + 1);
    }
    return total;
  } catch(e) { Logger.log('calculateStandardDues error: ' + e); return 0; }
}

function getFeeRules(ss) {
  try {
    var d = ss.getSheetByName("Fee_Settings").getDataRange().getValues();
    var r = [];
    for (var i = 1; i < d.length; i++) {
      var chargeName = String(d[i][0]).trim();
      if (!chargeName) continue;
      r.push({
        name:          chargeName,
        frequency:     String(d[i][1]).trim(),
        status:        String(d[i][2]).trim(),
        targetType:    String(d[i][3]).trim(),
        targetValue:   String(d[i][4]).trim(),
        feeType:       String(d[i][5]).trim() || 'Fixed',
        baseRate:      parseArabicNumber(d[i][6]),
        variableRate:  parseArabicNumber(d[i][7]) || 0,
        meterRef:      String(d[i][8]).trim(),
        start:         d[i][9]  ? new Date(d[i][9])  : null,
        end:           d[i][10] ? new Date(d[i][10]) : null,
        prorationRule: String(d[i][11]).trim() || 'Full-Month',
        category:      String(d[i][12]).trim(),
        notes:         String(d[i][13]).trim()
      });
    }
    return r;
  } catch(e) { Logger.log('getFeeRules error: ' + e); return []; }
}

// ============================================================================
// LEGAL SETTINGS
// ============================================================================

function getLegalSettings() {
  try {
    var l={};
    SpreadsheetApp.getActiveSpreadsheet()
      .getSheetByName("Legal_Settings").getDataRange().getValues()
      .forEach(function(r){ if(r[0]) l[r[0]]=r[1]; });
    return l;
  } catch(e){ return {}; }
}

// ============================================================================
// CATEGORY HELPERS
// ============================================================================

function getIncomeCategories() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName("Income_Category") || ss.getSheetByName("Income_Categories");
    if (!sheet) return getCategoriesLegacy();
    var data = sheet.getDataRange().getValues();
    var categories = [];
    for (var i = 1; i < data.length; i++) {
      var name = String(data[i][1]).trim();
      var status = String(data[i][4]).trim();
      if (name && (!status || status === 'Active')) categories.push(name);
    }
    return categories.length > 0 ? categories : ['Ø³Ù„ÙØ© Ø¹Ù† ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø§Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©'];
  } catch(e) { return ['Ø³Ù„ÙØ© Ø¹Ù† ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø§Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©']; }
}

function getExpenseCategories() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName("Expense_Category") || ss.getSheetByName("Expense_Categories");
    if (!sheet) return getCategoriesLegacy();
    var data = sheet.getDataRange().getValues();
    var categories = [];
    for (var i = 1; i < data.length; i++) {
      var name = String(data[i][1]).trim();
      var status = String(data[i][4]).trim();
      if (name && (!status || status === 'Active')) categories.push(name);
    }
    return categories.length > 0 ? categories : ['Ø±ÙˆØ§ØªØ¨', 'ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ù„Ø¨Ù†Ø§Ù†', 'Ù…ØµØ§Ø±ÙŠÙ Ù…ØªÙØ±Ù‚Ø©'];
  } catch(e) { return ['Ø±ÙˆØ§ØªØ¨', 'ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ù„Ø¨Ù†Ø§Ù†', 'Ù…ØµØ§Ø±ÙŠÙ Ù…ØªÙØ±Ù‚Ø©']; }
}

function getCategoriesLegacy() {
  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Category_Master");
    if (!sheet) return [];
    var data = sheet.getDataRange().getValues();
    var categories = [];
    for (var i = 1; i < data.length; i++) {
      var name = String(data[i][0]).trim();
      if (name) categories.push(name);
    }
    return categories;
  } catch(e) { return []; }
}

function clearCategoryCache() {
  try {
    var cache = CacheService.getScriptCache();
    cache.remove('income_categories');
    cache.remove('expense_categories');
    return 'Cache cleared!';
  } catch(e) { return 'Error: ' + e; }
}

// ============================================================================
// UTILITIES
// ============================================================================

function formatDate(d){ return Utilities.formatDate(new Date(d),"GMT+2","dd/MM/yyyy"); }

function createPdfBlob(h,n){
  return Utilities.newBlob(h,"text/html",n+".html").getAs("application/pdf").setName(n+".pdf");
}

function getFooter(l, prefix) {
  var h='<div style="font-size:10px;margin-top:20px;">';
  for(var i=1;i<=10;i++) if(l[prefix+'_NOTE_'+i]) h+='('+i+') '+l[prefix+'_NOTE_'+i]+'<br>';
  return h+'</div>';
}

function getCommonCSS(){
  return '<style>' +
    'body{font-family:Arial,sans-serif;direction:rtl;padding:20px;color:#333;line-height:1.4;}' +
    '.page{padding:10px;}' +
    '.disclaimer{background:#fff3cd;padding:10px;border:1px solid #ffeeba;border-radius:4px;font-size:11px;text-align:center;margin-bottom:20px;}' +
    '.financial-card{border:1px solid #ddd;padding:15px;border-radius:8px;margin-bottom:20px;}' +
    '.no-border-table,.no-border-table td{border:none!important;width:100%;}' +
    'table{width:100%;border-collapse:collapse;margin-top:10px;font-size:11px;}' +
    'th{background:#f8f9fa;border:1px solid #ddd;padding:8px;text-align:center;word-wrap:break-word;}' +
    'td{border:1px solid #ddd;padding:8px;text-align:center;}' +
    'td.contract-id{white-space:nowrap;font-size:9px;color:#666;width:130px;overflow:hidden;text-overflow:ellipsis;}' +
    'th.contract-id-header{width:130px;}' +
    'td.amount-col{width:65px;text-align:center;}' +
    'th.amount-header{width:65px;}' +
    '.page_break{page-break-before:always;}' +
    '.transition-notice{text-align:center;padding:15px;font-size:13px;font-weight:bold;border-radius:8px;margin:20px 0;border:2px solid;}' +
    '.notice-expense{color:#c0392b;background:#ffebee;border-color:#e74c3c;}' +
    '.notice-balance{color:#8e44ad;background:#f3e5f5;border-color:#9b59b6;}' +
    '</style>';
}
