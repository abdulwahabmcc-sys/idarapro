<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>idaraBUILDING</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">

  <style>
    :root {
      --navy:   #1B2A4A;
      --burg:   #9B2335;
      --forest: #1A6B3C;
      --gold:   #C9A84C;
      --bg:     #F0EFEB;
      --surf:   #FFFFFF;
      --bdr:    rgba(27,42,74,0.10);
      --muted:  rgba(27,42,74,0.45);
      --font:   'Cairo', sans-serif;
      --mono:   'DM Mono', monospace;
      --nav-h:  72px; /* tabs 52px + brand ~20px */
    }

    *, *::before, *::after {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      margin: 0; padding: 0;
    }

    /* â”€â”€ VIEWPORT SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--navy);
      -webkit-font-smoothing: antialiased;
      direction: rtl;
      display: flex;
      flex-direction: column;
    }

    /* â”€â”€ SCROLL ZONE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #scroll {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 14px 14px 16px;
    }

    #scroll::-webkit-scrollbar { display: none; }
    #scroll { scrollbar-width: none; }

    /* â”€â”€ FIXED BOTTOM NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #nav {
      flex-shrink: 0;
      background: var(--surf);
      border-top: 1px solid var(--bdr);
      box-shadow: 0 -4px 16px rgba(27,42,74,0.08);
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    /* tab row */
    .nav-tabs {
      display: flex;
      align-items: stretch;
      height: 52px;
    }

    .nav-tab {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1px;
      cursor: pointer;
      border: none;
      background: none;
      font-family: var(--font);
      transition: background 0.15s;
      padding: 0;
      position: relative;
    }

    .nav-tab:active { background: rgba(27,42,74,0.04); }

    .nav-tab::before {
      content: '';
      position: absolute;
      top: 0; left: 20%; right: 20%;
      height: 2.5px;
      border-radius: 0 0 3px 3px;
      background: transparent;
      transition: background 0.2s;
    }

    .nav-tab.n-inc::before { background: var(--forest); }
    .nav-tab.n-exp::before { background: var(--burg); }
    .nav-tab.n-rep::before { background: var(--navy); }

    .nav-ico { font-size: 20px; line-height: 1; }
    .nav-ar  { font-size: 10px; font-weight: 700; color: var(--muted); line-height: 1; }
    .nav-en  { font-size: 7px; font-weight: 500; color: var(--muted); opacity: 0.7; line-height: 1; }

    .nav-tab.n-inc .nav-ar, .nav-tab.n-inc .nav-en { color: var(--forest); opacity: 1; }
    .nav-tab.n-exp .nav-ar, .nav-tab.n-exp .nav-en { color: var(--burg);   opacity: 1; }
    .nav-tab.n-rep .nav-ar, .nav-tab.n-rep .nav-en { color: var(--navy);   opacity: 1; }

    /* brand row â€” sits below tabs */
    .nav-brand {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0px;
      padding: 3px 0 calc(3px + env(safe-area-inset-bottom));
      border-top: 1px solid var(--bdr);
      background: rgba(27,42,74,0.02);
    }

    .nb-wrap {
      display: flex;
      align-items: baseline;
      direction: ltr;
      gap: 0;
    }

    .nb-idara {
      font-family: var(--font);
      font-size: 11px; font-weight: 700;
      color: var(--navy);
    }

    .nb-sep { display: none; }

    .nb-pro {
      font-family: var(--font);
      font-size: 11px; font-weight: 700;
      color: var(--burg);
    }

    .nb-tag b {
      font-family: var(--mono);
      font-weight: 500;
      color: var(--navy);
      opacity: 0.7;
    }

    .nb-tag {
      font-size: 6.5px;
      color: var(--muted);
      letter-spacing: 0.3px;
      line-height: 1;
    }

    /* â”€â”€ LOADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #loader {
      position: fixed; inset: 0;
      background: var(--bg);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 20px; z-index: 9999;
      transition: opacity 0.4s ease;
    }

    #loader.out { opacity: 0; pointer-events: none; }

    .ldr-brand { font-size: 30px; font-weight: 700; color: var(--navy); direction: ltr; }
    .ldr-brand b { font-family: var(--font); font-size: 30px; font-weight: 700; color: var(--burg); }
    .ldr-track { width: 72px; height: 2px; background: var(--bdr); border-radius: 2px; overflow: hidden; }
    .ldr-bar { height: 100%; width: 40%; background: linear-gradient(90deg, var(--burg), var(--gold)); border-radius: 2px; animation: sweep 1s ease-in-out infinite; }
    @keyframes sweep { 0% { transform: translateX(200%); } 100% { transform: translateX(-300%); } }
    .ldr-hint { font-size: 11px; color: var(--muted); }

    .ldr-platform {
      font-size: 10px;
      color: var(--muted);
      direction: ltr;
      margin-top: -12px;
      letter-spacing: 0.2px;
    }

    .ldr-platform span {
      font-family: var(--mono);
      font-size: 9px;
      font-weight: 500;
      color: var(--navy);
      opacity: 0.6;
    }

    /* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast {
      position: fixed;
      bottom: calc(var(--nav-h) + env(safe-area-inset-bottom) + 10px);
      left: 16px; right: 16px;
      padding: 13px 16px;
      border-radius: 12px;
      font-size: 14px; font-weight: 600;
      color: #fff; text-align: center;
      z-index: 8000;
      opacity: 0; transform: translateY(8px);
      pointer-events: none;
      transition: all 0.25s ease;
      box-shadow: 0 6px 20px rgba(0,0,0,0.18);
    }

    #toast.show { opacity: 1; transform: translateY(0); }
    #toast.ok   { background: var(--forest); }
    #toast.fail { background: var(--burg); }
    #toast.info { background: var(--navy); }

    /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
    .bld-name { font-size: 15px; font-weight: 700; color: var(--navy); line-height: 1.2; }
    .bld-sub { font-size: 9px; color: var(--muted); margin-top: 1px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--forest); box-shadow: 0 0 0 3px rgba(26,107,60,0.15); flex-shrink: 0; transition: all 0.3s; }
    .dot.off { background: var(--burg); box-shadow: 0 0 0 3px rgba(155,35,53,0.15); }

    /* â”€â”€ DASHBOARD CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dash-card { background: var(--navy); border-radius: 20px; padding: 22px 20px 18px; margin-bottom: 16px; position: relative; overflow: hidden; box-shadow: 0 10px 28px rgba(27,42,74,0.22); }
    .dash-card::before { content: ''; position: absolute; top: -45px; left: -45px; width: 160px; height: 160px; border-radius: 50%; background: rgba(201,168,76,0.07); pointer-events: none; }
    .dash-card::after  { content: ''; position: absolute; bottom: -45px; right: -25px; width: 150px; height: 150px; border-radius: 50%; background: rgba(155,35,53,0.09); pointer-events: none; }
    .d-top { display: flex; justify-content: space-between; align-items: flex-start; position: relative; z-index: 1; }
    .d-lbl-en { font-size: 9px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; color: rgba(255,255,255,0.4); }
    .d-lbl-ar { font-size: 11px; color: rgba(255,255,255,0.3); margin-top: 2px; }
    .d-heart { display: flex; flex-direction: column; align-items: center; gap: 2px; cursor: pointer; position: relative; z-index: 1; }
    .d-heart-ico { font-size: 20px; line-height: 1; animation: hb 2s ease-in-out infinite; }
    @keyframes hb { 0%,100% { transform: scale(1); } 15% { transform: scale(1.22); } 30% { transform: scale(1); } 45% { transform: scale(1.12); } }
    .d-heart-pct { font-family: var(--mono); font-size: 11px; color: rgba(255,255,255,0.75); }
    .d-amount { font-family: var(--mono); font-size: clamp(30px, 9vw, 44px); font-weight: 500; color: #fff; direction: ltr; text-align: right; letter-spacing: -1px; line-height: 1; margin: 10px 0 6px; position: relative; z-index: 1; }
    .d-line { height: 1px; background: linear-gradient(90deg, var(--gold), transparent); opacity: 0.45; border-radius: 1px; position: relative; z-index: 1; }
    .d-foot { display: flex; justify-content: space-between; align-items: center; margin-top: 9px; position: relative; z-index: 1; }
    .d-time { font-family: var(--mono); font-size: 9px; color: rgba(255,255,255,0.28); }
    .d-refresh { width: 28px; height: 28px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.5); font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s; flex-shrink: 0; }
    .d-refresh:active { opacity: 0.6; }
    .d-refresh.spin { animation: spin 0.7s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card { background: var(--surf); border-radius: 16px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--bdr); box-shadow: 0 1px 4px rgba(27,42,74,0.05); }

    /* â”€â”€ LABELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .lbl { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; }
    .l-ar { font-size: 13px; font-weight: 700; color: var(--navy); }
    .l-en { font-size: 9px; color: var(--muted); direction: ltr; }

    /* â”€â”€ INPUTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .inp { width: 100%; height: 54px; border: 1.5px solid var(--bdr); border-radius: 12px; background: var(--bg); font-family: var(--font); font-size: 16px; font-weight: 600; color: var(--navy); padding: 0 14px; outline: none; -webkit-appearance: none; appearance: none; transition: border-color 0.2s, box-shadow 0.2s; text-align: right; }
    .inp:focus { border-color: var(--navy); background: var(--surf); box-shadow: 0 0 0 3px rgba(27,42,74,0.07); }
    .inp.err { border-color: var(--burg); animation: shake 0.3s ease; }
    @keyframes shake { 0%,100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

    select.inp { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%231B2A4A' opacity='.35'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: left 14px center; padding-left: 36px; cursor: pointer; font-size: 15px; }

    .inp-amt { font-family: var(--mono); font-size: 28px; font-weight: 400; height: 62px; text-align: center; direction: ltr; letter-spacing: -0.5px; }
    .inp-amt::placeholder { color: rgba(27,42,74,0.18); }
    .inp-pin { font-family: var(--mono); font-size: 22px; letter-spacing: 10px; text-align: center; direction: ltr; height: 56px; }
    .inp-pin.vfy { border-color: var(--gold);   box-shadow: 0 0 0 3px rgba(201,168,76,0.13); }
    .inp-pin.ok  { border-color: var(--forest); box-shadow: 0 0 0 3px rgba(26,107,60,0.12); }
    .inp-pin.bad { border-color: var(--burg);   box-shadow: 0 0 0 3px rgba(155,35,53,0.12); }

    /* â”€â”€ REPORT QUICK CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .r-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin-bottom: 12px; }
    .rcard { background: var(--surf); border: 1.5px solid var(--bdr); border-radius: 12px; padding: 12px 6px; text-align: center; cursor: pointer; transition: all 0.18s ease; display: flex; flex-direction: column; align-items: center; gap: 3px; }
    .rcard:active { transform: scale(0.95); }
    .rcard.on { background: var(--navy); border-color: var(--navy); }
    .rcard.on .r-icon, .rcard.on .r-title, .rcard.on .r-sub { color: #fff; }
    .r-icon  { font-size: 18px; }
    .r-title { font-size: 11px; font-weight: 700; color: var(--navy); }
    .r-sub   { font-size: 8px; color: var(--muted); }

    /* â”€â”€ SUBMIT BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-sub { width: 100%; height: 58px; border: none; border-radius: 12px; font-family: var(--font); font-size: 17px; font-weight: 700; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 12px; -webkit-appearance: none; transition: opacity 0.2s, transform 0.15s; }
    .btn-sub:active:not(:disabled) { opacity: 0.85; transform: scale(0.98); }
    .btn-sub:disabled { opacity: 0.3; cursor: not-allowed; }
    .b-inc { background: var(--forest); box-shadow: 0 4px 14px rgba(26,107,60,0.28); }
    .b-exp { background: var(--burg);   box-shadow: 0 4px 14px rgba(155,35,53,0.26); }
    .b-rep { background: var(--navy);   box-shadow: 0 4px 14px rgba(27,42,74,0.24); }

    /* â”€â”€ LOCK BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #lock-banner { display: none; padding: 14px; background: rgba(155,35,53,0.07); border: 1px solid rgba(155,35,53,0.22); border-radius: 12px; font-size: 13px; color: var(--burg); text-align: center; margin-bottom: 12px; }
    .lock-btn { width: 100%; margin-top: 8px; padding: 10px; background: var(--burg); color: #fff; border: none; border-radius: 10px; font-family: var(--font); font-size: 14px; font-weight: 700; cursor: pointer; }

    /* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #modal { display: none; position: fixed; inset: 0; background: rgba(27,42,74,0.45); z-index: 7000; align-items: flex-end; backdrop-filter: blur(3px); }
    #modal.open { display: flex; }
    .m-sheet { background: var(--surf); border-radius: 24px 24px 0 0; padding: 24px 20px calc(36px + env(safe-area-inset-bottom)); width: 100%; animation: shup 0.3s ease; }
    @keyframes shup { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .m-title { font-size: 16px; font-weight: 700; text-align: center; margin-bottom: 16px; }
    .m-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--bdr); font-size: 13px; }
    .m-row:last-of-type { border: none; }
    .m-val { font-family: var(--mono); font-weight: 500; color: var(--forest); }
    .m-confirm { display: flex; align-items: center; gap: 10px; background: var(--bg); border-radius: 10px; padding: 12px; margin: 12px 0; cursor: pointer; font-size: 13px; }
    .m-confirm input { transform: scale(1.2); accent-color: var(--navy); }
    .m-ok { width: 100%; height: 50px; background: var(--forest); color: #fff; border: none; border-radius: 12px; font-family: var(--font); font-size: 15px; font-weight: 700; cursor: pointer; margin-bottom: 10px; }
    .m-cancel { width: 100%; height: 44px; background: var(--bg); color: var(--muted); border: none; border-radius: 12px; font-family: var(--font); font-size: 13px; font-weight: 600; cursor: pointer; }

    .hide     { display: none !important; }
    .disabled { opacity: 0.35; pointer-events: none; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DESKTOP LAYOUT  â‰¥ 769px
       Mobile layout above is completely untouched
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @media (min-width: 769px) {

      html, body { height: 100%; overflow: hidden; }

      body { flex-direction: column; background: #E8E7E2; }

      /* TOP BAR â€” Minimal Corporate */
      #dt-topbar {
        flex-shrink: 0; height: 64px;
        background: #ffffff;
        display: flex !important;
        align-items: center;
        justify-content: space-between;
        padding: 0 36px;
        border-bottom: 3px solid var(--gold);
        box-shadow: 0 1px 8px rgba(27,42,74,0.07);
      }

      /* LEFT: brand */
      .dt-topbrand { display: flex; align-items: center; gap: 12px; direction: ltr; }
      .dt-brand-mark { display: flex; align-items: baseline; gap: 0; }
      .dt-b-idara { font-family: var(--font); font-size: 18px; font-weight: 700; color: var(--navy); letter-spacing: -0.3px; }
      .dt-b-pro   { font-family: var(--font); font-size: 18px; font-weight: 700; color: var(--burg); letter-spacing: -0.3px; }
      .dt-b-divider { width: 1px; height: 22px; background: #D0CEC8; margin: 0 12px; }
      .dt-b-platform { font-size: 9px; color: #aaa; letter-spacing: 0.3px; direction: ltr; line-height: 1.4; }
      .dt-b-platform span { font-weight: 600; color: #888; }

      /* RIGHT: building identity */
      .dt-bld { display: flex; flex-direction: column; align-items: flex-end; }
      .dt-bld-name { font-size: 15px; font-weight: 700; color: var(--navy); line-height: 1.2; direction: rtl; }
      .dt-bld-sub  { font-size: 9px; color: #aaa; letter-spacing: 0.5px; text-transform: uppercase; }

      /* Status dot */
      .dt-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--forest); box-shadow: 0 0 0 3px rgba(26,107,60,0.2); transition: all 0.3s; }
      .dt-dot.off { background: var(--burg); box-shadow: 0 0 0 3px rgba(155,35,53,0.2); }

      /* MAIN AREA */
      #dt-main {
        flex: 1; min-height: 0;
        display: flex !important;
        overflow: hidden;
      }

      /* LEFT PANEL â€” dashboard */
      #dt-sidebar {
        width: 320px; flex-shrink: 0;
        display: flex !important;
        flex-direction: column;
        gap: 16px;
        padding: 24px 20px;
        overflow-y: auto;
        background: #E0DFD9;
        border-left: 1px solid rgba(27,42,74,0.08);
      }
      #dt-sidebar::-webkit-scrollbar { display: none; }

      .dt-sidebar-label {
        font-size: 9px; font-weight: 700;
        letter-spacing: 2px; text-transform: uppercase;
        color: var(--muted); margin-bottom: -8px;
      }

      /* RIGHT PANEL â€” form */
      #dt-content {
        flex: 1; min-width: 0;
        display: flex !important;
        flex-direction: column;
        overflow: hidden;
        background: var(--bg);
      }

      /* Tab bar */
      #dt-tabs {
        flex-shrink: 0; height: 54px;
        background: var(--surf);
        border-bottom: 1px solid var(--bdr);
        display: flex !important;
        align-items: stretch;
        padding: 0 28px;
        gap: 4px;
        box-shadow: 0 1px 4px rgba(27,42,74,0.05);
      }

      .dt-tab {
        display: flex; align-items: center; gap: 8px;
        padding: 0 22px; border: none; background: none;
        font-family: var(--font); font-size: 13px; font-weight: 700;
        color: var(--muted); cursor: pointer;
        border-bottom: 2.5px solid transparent;
        transition: all 0.18s;
      }
      .dt-tab:hover { color: var(--navy); background: rgba(27,42,74,0.025); }
      .dt-tab.dt-inc { border-bottom-color: var(--forest); color: var(--forest); }
      .dt-tab.dt-exp { border-bottom-color: var(--burg);   color: var(--burg);   }
      .dt-tab.dt-rep { border-bottom-color: var(--navy);   color: var(--navy);   }
      .dt-tab-ico { font-size: 16px; }

      /* Form scroll */
      #dt-form-scroll {
        flex: 1; min-height: 0;
        overflow-y: auto;
        padding: 28px 36px;
      }
      #dt-form-scroll::-webkit-scrollbar { width: 4px; }
      #dt-form-scroll::-webkit-scrollbar-thumb { background: var(--bdr); border-radius: 4px; }
      #dt-form-scroll .card,
      #dt-form-scroll .r-grid,
      #dt-form-scroll #f-rep > .card { max-width: 520px; }

      /* HIDE mobile nav, restructure scroll for desktop */
      #nav    { display: none !important; }

      /* On desktop, #scroll becomes the form panel inside dt-content */
      #scroll {
        display: block !important;
        overflow-y: auto;
        padding: 28px 36px;
        flex: 1;
        min-height: 0;
      }

      /* Hide mobile-only elements inside scroll on desktop */
      #scroll .header  { display: none; }
      #scroll .dash-card { display: none; }
      #scroll #lock-banner { max-width: 520px; }
      #scroll .card    { max-width: 520px; }
      #scroll .r-grid  { max-width: 520px; }
      #scroll #f-rep > .card { max-width: 520px; }

      /* dt-content wraps dt-tabs + scroll */
      #dt-content { flex-direction: column; }

      /* dt-form-scroll not needed â€” scroll takes its place */
      #dt-form-scroll { display: none; }

      /* desktop dash card */
      .dash-card { margin-bottom: 0; border-radius: 16px; }

      /* Toast repositioned */
      #toast {
        bottom: 28px; left: 50%; right: auto;
        width: 360px;
        transform: translateX(-50%) translateY(8px);
      }
      #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

      /* Modal centered */
      #modal { align-items: center; justify-content: center; }
      .m-sheet {
        border-radius: 20px; max-width: 460px;
        padding: 32px 28px;
        animation: fadeUp 0.25s ease;
      }
      @keyframes fadeUp {
        from { opacity: 0; transform: translateY(16px); }
        to   { opacity: 1; transform: translateY(0); }
      }
    }

    /* Always hide desktop chrome on mobile */
    #dt-topbar, #dt-main { display: none; }

  </style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
  <div class="ldr-brand">idara<b>BUILDING</b></div>
  <div class="ldr-platform">a platform of <span>idara360</span></div>
  <div class="ldr-track"><div class="ldr-bar"></div></div>
  <div class="ldr-hint">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ / Loading...</div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<!-- SCROLL ZONE -->
<div id="scroll">

  <div class="header">
    <div>
      <div class="bld-name" id="bldName">...</div>
      <div class="bld-sub">Building Management</div>
    </div>
    <div class="dot" id="dot"></div>
  </div>

  <div class="dash-card">
    <div class="d-top">
      <div>
        <div class="d-lbl-en">CASH ON HAND</div>
        <div class="d-lbl-ar">Ø§Ù„Ù†Ù‚Ø¯ Ø§Ù„Ù…ØªÙˆÙØ±</div>
      </div>
      <div class="d-heart" onclick="refreshDash()">
        <span class="d-heart-ico" id="heart">ğŸ’š</span>
        <span class="d-heart-pct" id="hpct">â€”%</span>
      </div>
    </div>
    <div class="d-amount" id="cashAmt">Loading...</div>
    <div class="d-line"></div>
    <div class="d-foot">
      <div class="d-time" id="dashTime">â€”</div>
      <button class="d-refresh" id="rBtn" onclick="refreshDash()">â†»</button>
    </div>
  </div>

  <div id="lock-banner">
    <strong>âš ï¸ Fiscal Year Mismatch</strong><br>
    <span id="lock-msg"></span>
    <button class="lock-btn" onclick="openFiscal()">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ù†Ø© / Close Year</button>
  </div>

  <form id="form" onsubmit="event.preventDefault(); doSubmit();">
    <input type="hidden" id="eType" value="Income">

    <div class="card" id="f-inc">
      <div class="lbl"><span class="l-ar">Ø´Ø§ØºÙ„ Ø§Ù„Ù‚Ø³Ù…</span><span class="l-en">Occupant of Unit</span></div>
      <select class="inp" id="sel-owner"><option value="" disabled selected>Ø§Ø®ØªØ± / Select...</option></select>
      <div class="lbl" style="margin-top:12px;"><span class="l-ar">Ø§Ù„ÙØ¦Ø©</span><span class="l-en">Category</span></div>
      <select class="inp" id="sel-icat"><option value="" disabled selected>Ø§Ø®ØªØ± / Select...</option></select>
    </div>

    <div class="card hide" id="f-exp">
      <div class="lbl"><span class="l-ar">ÙØ¦Ø© Ø§Ù„Ù…ØµØ±ÙˆÙ</span><span class="l-en">Expense Category</span></div>
      <select class="inp" id="sel-ecat"><option value="" disabled selected>Ø§Ø®ØªØ± / Select...</option></select>
    </div>

    <div class="hide" id="f-rep">
      <div class="r-grid">
        <div class="rcard on" id="rc-ytd" onclick="pickReport('YTD')">
          <span class="r-icon">ğŸ“Š</span><span class="r-title">YTD</span><span class="r-sub">ØªØ±Ø§ÙƒÙ…ÙŠ</span>
        </div>
        <div class="rcard" id="rc-month" onclick="pickReport('CurrentMonth')">
          <span class="r-icon">ğŸ“…</span><span class="r-title">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</span><span class="r-sub">This Month</span>
        </div>
        <div class="rcard" id="rc-journal" onclick="pickReport('Journal')">
          <span class="r-icon">ğŸ“–</span><span class="r-title">Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</span><span class="r-sub">Journal</span>
        </div>
      </div>
      <div class="card">
        <div class="lbl"><span class="l-ar">Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</span><span class="l-en">Report Type</span></div>
        <select class="inp" id="sel-rep" onchange="pickReport(this.value)">
          <option value="YTD">YTD â€” ØªØ±Ø§ÙƒÙ…ÙŠ Ø³Ù†ÙˆÙŠ</option>
          <option value="CurrentMonth">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± / This Month</option>
          <option value="LastMonth">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ / Last Month</option>
          <option value="Journal">Ø¯ÙØªØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ© / Journal</option>
        </select>
      </div>
    </div>

    <div class="card" id="f-amt">
      <div class="lbl"><span class="l-ar">Ø§Ù„Ù…Ø¨Ù„Øº</span><span class="l-en">Amount $</span></div>
      <input type="number" step="0.01" min="0" class="inp inp-amt" id="inp-amt" placeholder="0.00" inputmode="decimal">
    </div>

    <div class="card">
      <div class="lbl"><span class="l-ar">Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„</span><span class="l-en">PIN</span></div>
      <input type="password" class="inp inp-pin" id="inp-pin" pattern="[0-9]{4}" inputmode="numeric" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" autocomplete="off">
      <button type="submit" class="btn-sub b-inc" id="btn-sub">
        <span id="btn-ico">ğŸ’°</span>
        <span id="btn-txt">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© / Record Payment</span>
      </button>
    </div>

  </form>

</div><!-- /scroll -->

<!-- FIXED BOTTOM NAV -->
<nav id="nav">

  <!-- TAB ROW -->
  <div class="nav-tabs">
    <button class="nav-tab n-inc" id="t-inc" onclick="setTab('Income')">
      <span class="nav-ico">ğŸ’°</span>
      <span class="nav-ar">Ù‚Ø¨Ø¶</span>
      <span class="nav-en">Income</span>
    </button>
    <button class="nav-tab" id="t-exp" onclick="setTab('Expense')">
      <span class="nav-ico">ğŸ“‰</span>
      <span class="nav-ar">Ù…ØµØ±ÙˆÙ</span>
      <span class="nav-en">Expense</span>
    </button>
    <button class="nav-tab" id="t-rep" onclick="setTab('Report')">
      <span class="nav-ico">ğŸ“„</span>
      <span class="nav-ar">ØªÙ‚Ø§Ø±ÙŠØ±</span>
      <span class="nav-en">Reports</span>
    </button>
  </div>

  <!-- BRAND ROW -->
  <div class="nav-brand">
    <div class="nb-wrap">
      <span class="nb-idara">idara</span>
      <span class="nb-sep"></span>
      <span class="nb-pro">BUILDING</span>
    </div>
    <div class="nb-tag">a platform of <b>idara360</b></div>
  </div>

</nav>

<!-- FISCAL MODAL -->
<div id="modal">
  <div class="m-sheet">
    <div class="m-title">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© / Year-End Closing</div>
    <div class="m-row"><span>Closing Year</span><span class="m-val" id="cy-close">â€”</span></div>
    <div class="m-row"><span>New Year</span><span class="m-val" id="cy-open">â€”</span></div>
    <div class="m-row"><span>Cash Carry Forward</span><span class="m-val" id="cy-cash">â€”</span></div>
    <div class="m-row"><span>Units</span><span class="m-val" id="cy-units">â€”</span></div>
    <label class="m-confirm">
      <input type="checkbox" id="conf-chk">
      I verify these balances are correct
    </label>
    <button class="m-ok" onclick="execClose()">Execute & Close</button>
    <button class="m-cancel" onclick="closeModal()">Cancel / Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â• DESKTOP CHROME (hidden on mobile) â•â•â•â•â•â•â•â•â•â•â• -->

<!-- TOP BAR -->
<div id="dt-topbar">
  <!-- LEFT: Brand -->
  <div class="dt-topbrand">
    <div class="dt-brand-mark">
      <span class="dt-b-idara">idara</span><span class="dt-b-pro">BUILDING</span>
    </div>
    <div class="dt-b-divider"></div>
    <div class="dt-b-platform">a platform of <span>idara360</span></div>
    <div class="dt-dot" id="dt-dot"></div>
  </div>
  <!-- RIGHT: Building identity -->
  <div class="dt-bld">
    <div class="dt-bld-name" id="dt-bldName">...</div>
    <div class="dt-bld-sub">Building Management</div>
  </div>
</div>

<!-- MAIN AREA -->
<div id="dt-main">

  <!-- LEFT: Dashboard -->
  <div id="dt-sidebar">
    <div class="dt-sidebar-label">Overview</div>
    <div class="dash-card" id="dt-dash">
      <div class="d-top">
        <div>
          <div class="d-lbl-en">CASH ON HAND</div>
          <div class="d-lbl-ar">Ø§Ù„Ù†Ù‚Ø¯ Ø§Ù„Ù…ØªÙˆÙØ±</div>
        </div>
        <div class="d-heart" onclick="refreshDash()">
          <span class="d-heart-ico" id="dt-heart">ğŸ’š</span>
          <span class="d-heart-pct" id="dt-hpct">â€”%</span>
        </div>
      </div>
      <div class="d-amount" id="dt-cashAmt">Loading...</div>
      <div class="d-line"></div>
      <div class="d-foot">
        <div class="d-time" id="dt-dashTime">â€”</div>
        <button class="d-refresh" id="dt-rBtn" onclick="refreshDash()">â†»</button>
      </div>
    </div>
  </div>

  <!-- RIGHT: Form -->
  <div id="dt-content">

    <!-- Tab bar -->
    <div id="dt-tabs">
      <button class="dt-tab dt-inc" id="dt-t-inc" onclick="setTab('Income')">
        <span class="dt-tab-ico">ğŸ’°</span> Ù‚Ø¨Ø¶ / Income
      </button>
      <button class="dt-tab" id="dt-t-exp" onclick="setTab('Expense')">
        <span class="dt-tab-ico">ğŸ“‰</span> Ù…ØµØ±ÙˆÙ / Expense
      </button>
      <button class="dt-tab" id="dt-t-rep" onclick="setTab('Report')">
        <span class="dt-tab-ico">ğŸ“„</span> ØªÙ‚Ø§Ø±ÙŠØ± / Reports
      </button>
    </div>

    </div><!-- /dt-content -->
</div><!-- /dt-main -->
<!-- â•â•â•â•â•â•â•â•â•â•â• END DESKTOP CHROME â•â•â•â•â•â•â•â•â•â•â• -->

<script>
var TAB    = 'Income';
var REPORT = 'YTD';
var _fiscal = null;
var _rtimer = null;
var _ttimer = null;
var GAS = 'https://script.google.com/macros/s/AKfycbxAXi3phO9lrfi9cWmbIVID-kwnbWSogVB7wM3PwvNi40y8uOgmmrHdU-EqIHz_rkXv/exec';

function gasGet(action) {
  return fetch(GAS + '?action=' + action)
    .then(function(r) { return r.json(); })
    .then(function(r) { if (!r.ok) throw new Error(r.error); return r.data; });
}

function gasPost(body) {
  return fetch(GAS, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' },
    body: JSON.stringify(body)
  })
    .then(function(r) { return r.json(); })
    .then(function(r) { if (!r.ok) throw new Error(r.error); return r.data; });
}

window.onload = function() {
  gasGet('getAppData')
    .then(function(d) { initApp(d); })
    .catch(bootErr);
  refreshDash();
  watchNet();
  _rtimer = setInterval(refreshDash, 30000);
};

function bootErr() {
  hideLo();
  toast('âš ï¸ Connection failed. Please reload.', 'fail');
}

function hideLo() {
  var lo = document.getElementById('loader');
  if (!lo) return;
  lo.classList.add('out');
  setTimeout(function() { lo.style.display = 'none'; }, 500);
}

function initApp(d) {
  if (!d) { bootErr(); return; }
  window._cats = { income: d.incomeCategories || [], expense: d.expenseCategories || [] };
  if (d.legal && d.legal['BUILDING_NAME']) {
    document.getElementById('bldName').textContent    = d.legal['BUILDING_NAME'];
    document.getElementById('dt-bldName').textContent = d.legal['BUILDING_NAME'];
  }

  var sel  = document.getElementById('sel-owner');
  var frag = document.createDocumentFragment();
  var ph   = new Option('Ø§Ø®ØªØ± / Select...', '');
  ph.disabled = true; ph.selected = true;
  frag.appendChild(ph);
  (d.owners || []).forEach(function(o) {
    var opt = new Option(o.display, o.name);
    opt.dataset.section    = o.section    || '';
    opt.dataset.contractId = o.contractId || '';
    frag.appendChild(opt);
  });
  sel.innerHTML = ''; sel.appendChild(frag);

  fillCats('income');

  if (d.fiscal && d.fiscal.locked) {
    document.getElementById('lock-banner').style.display = 'block';
    document.getElementById('lock-msg').textContent = d.fiscal.msg || '';
    document.getElementById('dt-lock-banner').style.display = 'block';
    document.getElementById('dt-lock-msg').textContent = d.fiscal.msg || '';
    document.getElementById('form').classList.add('disabled');
  }

  setTab('Income');

  // Sync desktop dot with mobile dot
  var dtDot = document.getElementById('dt-dot');
  window.addEventListener('online',  function() { if(dtDot) dtDot.classList.remove('off'); });
  window.addEventListener('offline', function() { if(dtDot) dtDot.classList.add('off'); });

  // On desktop: physically move #scroll into #dt-content so CSS layout works
  if (window.innerWidth >= 769) {
    var dtContent = document.getElementById('dt-content');
    var scroll    = document.getElementById('scroll');
    if (dtContent && scroll) {
      dtContent.appendChild(scroll);
    }
  }



  hideLo();
}

function fillCats(type) {
  var cats  = (window._cats && window._cats[type]) ? window._cats[type] : [];
  var selId = type === 'income' ? 'sel-icat' : 'sel-ecat';
  var sel   = document.getElementById(selId);
  var frag  = document.createDocumentFragment();
  var ph    = new Option('Ø§Ø®ØªØ± / Select...', '');
  ph.disabled = true; ph.selected = true;
  frag.appendChild(ph);
  cats.forEach(function(c) { frag.appendChild(new Option(c, c)); });
  sel.innerHTML = ''; sel.appendChild(frag);
}

function setTab(type) {
  TAB = type;
  document.getElementById('eType').value = type;

  ['t-inc','t-exp','t-rep'].forEach(function(id) {
    document.getElementById(id).className = 'nav-tab';
  });

  // Sync desktop tabs
  ['dt-t-inc','dt-t-exp','dt-t-rep'].forEach(function(id) {
    document.getElementById(id).className = 'dt-tab';
  });

  ['f-inc','f-exp','f-rep','f-amt'].forEach(function(id) {
    document.getElementById(id).classList.add('hide');
  });

  var btn = document.getElementById('btn-sub');
  var ico = document.getElementById('btn-ico');
  var txt = document.getElementById('btn-txt');

  if (type === 'Income') {
    document.getElementById('t-inc').classList.add('n-inc');
    document.getElementById('dt-t-inc').classList.add('dt-inc');
    document.getElementById('f-inc').classList.remove('hide');
    document.getElementById('f-amt').classList.remove('hide');
    fillCats('income');
    btn.className = 'btn-sub b-inc';
    ico.textContent = 'ğŸ’°'; txt.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© / Record Payment';

  } else if (type === 'Expense') {
    document.getElementById('t-exp').classList.add('n-exp');
    document.getElementById('dt-t-exp').classList.add('dt-exp');
    document.getElementById('f-exp').classList.remove('hide');
    document.getElementById('f-amt').classList.remove('hide');
    fillCats('expense');
    btn.className = 'btn-sub b-exp';
    ico.textContent = 'ğŸ“‰'; txt.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ / Record Expense';

  } else {
    document.getElementById('t-rep').classList.add('n-rep');
    document.getElementById('dt-t-rep').classList.add('dt-rep');
    document.getElementById('f-rep').classList.remove('hide');
    pickReport('YTD');
    btn.className = 'btn-sub b-rep';
    ico.textContent = 'ğŸ“§'; txt.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± / Send Report';
  }

  document.getElementById('inp-amt').value = '';
  document.getElementById('inp-pin').value = '';
  resetPin();
  document.getElementById('scroll').scrollTop = 0;
}

function pickReport(type) {
  REPORT = type;
  var sel = document.getElementById('sel-rep');
  if (sel) sel.value = type;
  ['rc-ytd','rc-month','rc-journal'].forEach(function(id) {
    document.getElementById(id).classList.remove('on');
  });
  var map = { 'YTD':'rc-ytd', 'CurrentMonth':'rc-month', 'Journal':'rc-journal' };
  if (map[type]) document.getElementById(map[type]).classList.add('on');
}

function refreshDash() {
  var rb = document.getElementById('rBtn');
  rb.classList.add('spin');
  var dtRb = document.getElementById('dt-rBtn');
  if (dtRb) dtRb.classList.add('spin');
  gasGet('getDashboardStats')
    .then(function(v) {
      var val = v || '$0.00';
      var n = new Date();
      var t = pad(n.getHours()) + ':' + pad(n.getMinutes()) + ':' + pad(n.getSeconds());
      var isNeg = val.indexOf('-') !== -1;
      var amtColor = isNeg ? '#FF4D6A' : '#ffffff';
      document.getElementById('cashAmt').textContent    = val;
      document.getElementById('cashAmt').style.color    = amtColor;
      document.getElementById('dt-cashAmt').textContent = val;
      document.getElementById('dt-cashAmt').style.color = amtColor;
      document.getElementById('dashTime').textContent   = t;
      document.getElementById('dt-dashTime').textContent = t;
      rb.classList.remove('spin');
      document.getElementById('dt-rBtn').classList.remove('spin');
    })
    .catch(function() {
      rb.classList.remove('spin');
      document.getElementById('dt-rBtn').classList.remove('spin');
    });

  gasGet('getBuildingHealth')
    .then(function(r) {
      var pct = r && r.pct != null ? r.pct : 0;
      var ico = pct >= 80 ? 'ğŸ’š' : pct >= 50 ? 'ğŸ§¡' : 'â¤ï¸';
      document.getElementById('hpct').textContent    = pct + '%';
      document.getElementById('dt-hpct').textContent = pct + '%';
      document.getElementById('heart').textContent    = ico;
      document.getElementById('dt-heart').textContent = ico;
    })
    .catch(function() {});
}

function pad(n) { return String(n).padStart(2, '0'); }

function doSubmit() {
  var type  = TAB;
  var pinEl = document.getElementById('inp-pin');
  var pin   = pinEl.value;

  if (!pin || pin.length !== 4) { toast('âŒ PIN must be 4 digits', 'fail'); markErr(pinEl); return; }

  if (type !== 'Report') {
    var amt = parseFloat(document.getElementById('inp-amt').value);
    if (!amt || amt <= 0) { toast('âŒ Enter a valid amount', 'fail'); markErr(document.getElementById('inp-amt')); return; }
    if (type === 'Income' && !document.getElementById('sel-owner').value) { toast('âŒ Select an occupant', 'fail'); markErr(document.getElementById('sel-owner')); return; }
  }

  var cat = '';
  if (type === 'Income')  cat = document.getElementById('sel-icat').value;
  if (type === 'Expense') cat = document.getElementById('sel-ecat').value;
  if (type !== 'Report' && !cat) { toast('âŒ Select a category', 'fail'); return; }

  var btn = document.getElementById('btn-sub');
  btn.disabled = true;
  pinEl.classList.add('vfy');
  toast('ğŸ” Verifying...', 'info');

  var tmout = setTimeout(function() { onFail({ message: 'Timed out. Try again.' }); }, 30000);

  if (type === 'Report') {
    gasPost({ action: 'processReportRequest', reportType: document.getElementById('sel-rep').value, pin: pin })
      .then(function(r) {
        clearTimeout(tmout);
        pinEl.classList.remove('vfy'); pinEl.classList.add('ok');
        setTimeout(function() { resetPin(); onOk(r.msg || r); }, 500);
      })
      .catch(function(e) { clearTimeout(tmout); pinFail(e); });

  } else {
    var ownerSel = document.getElementById('sel-owner');
    var selOpt   = ownerSel.selectedIndex >= 0 ? ownerSel.options[ownerSel.selectedIndex] : null;
    var payload  = {
      entryType:  type,
      ownerName:  type === 'Income' ? ownerSel.value : '',
      category:   cat,
      amount:     document.getElementById('inp-amt').value,
      unit:       selOpt ? (selOpt.dataset.section    || '') : '',
      contractId: selOpt ? (selOpt.dataset.contractId || '') : '',
      pin:        pin
    };

    gasPost({ action: 'processEntry', payload: payload })
      .then(function(r) {
        clearTimeout(tmout);
        pinEl.classList.remove('vfy'); pinEl.classList.add('ok');
        setTimeout(function() { resetPin(); onOk(r); }, 500);
      })
      .catch(function(e) { clearTimeout(tmout); pinFail(e); });
  }
}

function onOk(msg) {
  var ok = msg && (msg.includes('âœ…') || msg.includes('success') || msg.includes('Saved'));
  toast(msg, ok ? 'ok' : 'fail');
  document.getElementById('btn-sub').disabled = false;
  if (ok && TAB !== 'Report') {
    document.getElementById('inp-amt').value = '';
    document.getElementById('inp-pin').value = '';
    resetPin(); refreshDash();
  } else {
    document.getElementById('inp-pin').value = '';
    resetPin();
  }
}

function onFail(e) {
  toast('âŒ ' + (e.message || String(e)), 'fail');
  document.getElementById('btn-sub').disabled = false;
  resetPin();
}

function pinFail(e) {
  var pinEl = document.getElementById('inp-pin');
  pinEl.classList.remove('vfy', 'ok');
  pinEl.classList.add('bad');
  pinEl.value = ''; pinEl.focus();
  toast('âŒ Wrong PIN. Try again.', 'fail');
  document.getElementById('btn-sub').disabled = false;
  setTimeout(resetPin, 3000);
}

function toast(msg, type) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.className   = type || 'info';
  t.classList.add('show');
  if (_ttimer) clearTimeout(_ttimer);
  _ttimer = setTimeout(function() { t.classList.remove('show'); }, type === 'fail' ? 5000 : 3000);
}

function markErr(el) {
  if (!el) return;
  el.classList.add('err');
  setTimeout(function() { el.classList.remove('err'); }, 1800);
}

function resetPin() {
  var p = document.getElementById('inp-pin');
  if (p) p.classList.remove('vfy', 'ok', 'bad', 'err');
  var b = document.getElementById('btn-sub');
  if (b) b.disabled = false;
}

function watchNet() {
  var dot = document.getElementById('dot');
  window.addEventListener('online',  function() { dot.classList.remove('off'); toast('âœ… Back online', 'ok'); });
  window.addEventListener('offline', function() { dot.classList.add('off');    toast('âš ï¸ No internet', 'fail'); });
}

function openFiscal() {
  gasGet('previewFiscalClose')
    .then(function(d) {
      _fiscal = d;
      document.getElementById('cy-close').textContent = d.yearClosing;
      document.getElementById('cy-open').textContent  = d.yearOpening;
      document.getElementById('cy-cash').textContent  = '$' + d.cashCarryForward.toFixed(2);
      document.getElementById('cy-units').textContent = d.unitCount;
      document.getElementById('modal').classList.add('open');
    })
    .catch(function(e) { toast('âŒ ' + e.message, 'fail'); });
}

function execClose() {
  if (!document.getElementById('conf-chk').checked) { toast('Please confirm first', 'fail'); return; }
  gasPost({ action: 'commitFiscalClose', payload: _fiscal })
    .then(function(msg) { toast(msg, 'ok'); closeModal(); setTimeout(function() { location.reload(); }, 2000); })
    .catch(function(e) { toast('âŒ ' + e.message, 'fail'); });
}

function closeModal() { document.getElementById('modal').classList.remove('open'); }

document.addEventListener('keydown', function(e) {
  if (e.altKey && e.key === '1') { e.preventDefault(); setTab('Income'); }
  if (e.altKey && e.key === '2') { e.preventDefault(); setTab('Expense'); }
  if (e.altKey && e.key === '3') { e.preventDefault(); setTab('Report'); }
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    e.preventDefault();
    var b = document.getElementById('btn-sub');
    if (!b.disabled) doSubmit();
  }
});
</script>
</body>
</html>
