<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>idaraBUILDING</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">

  <style>
    :root {
      --navy:   #1B2A4A;
      --burg:   #9B2335;
      --forest: #1A6B3C;
      --gold:   #C9A84C;
      --bg:     #F0EFEB;
      --surf:   #FFFFFF;
      --bdr:    rgba(27,42,74,0.10);
      --muted:  rgba(27,42,74,0.45);
      --font:   'Cairo', sans-serif;
      --mono:   'DM Mono', monospace;
      --nav-h:  72px;
    }

    *, *::before, *::after {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      margin: 0; padding: 0;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--navy);
      -webkit-font-smoothing: antialiased;
      direction: rtl;
      display: flex;
      flex-direction: column;
    }

    /* ══════════════════════════════════════════════
       LOGIN SCREEN
    ══════════════════════════════════════════════ */
    #login-screen {
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 24px 24px calc(24px + env(safe-area-inset-bottom));
      gap: 0;
    }

    #login-screen.out {
      animation: loginOut 0.4s ease forwards;
    }

    @keyframes loginOut {
      to { opacity: 0; transform: scale(1.03); pointer-events: none; }
    }

    /* Brand */
    .lgn-brand {
      text-align: center;
      margin-bottom: 6px;
    }

    .lgn-brand-mark {
      display: flex;
      align-items: baseline;
      justify-content: center;
      direction: ltr;
    }

    .lgn-b-idara {
      font-family: var(--font);
      font-size: 28px;
      font-weight: 700;
      color: var(--navy);
      letter-spacing: -0.5px;
    }

    .lgn-b-building {
      font-family: var(--font);
      font-size: 28px;
      font-weight: 700;
      color: var(--burg);
      letter-spacing: -0.5px;
    }

    .lgn-b-tag {
      font-size: 9px;
      color: var(--muted);
      letter-spacing: 0.3px;
      margin-top: 3px;
      direction: ltr;
    }

    /* Building name */
    .lgn-bld {
      font-size: 14px;
      font-weight: 700;
      color: var(--navy);
      text-align: center;
      direction: rtl;
      margin-bottom: 32px;
      min-height: 20px;
    }

    /* Gold divider */
    .lgn-divider {
      width: 48px;
      height: 2px;
      background: var(--gold);
      border-radius: 2px;
      margin: 10px auto 28px;
    }

    /* Prompt */
    .lgn-prompt {
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      text-align: center;
      margin-bottom: 20px;
      direction: rtl;
    }

    /* PIN dots */
    .lgn-dots {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-bottom: 28px;
    }

    .lgn-dot {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid var(--bdr);
      background: transparent;
      transition: all 0.15s ease;
    }

    .lgn-dot.filled {
      background: var(--navy);
      border-color: var(--navy);
      transform: scale(1.1);
    }

    .lgn-dot.error {
      background: var(--burg);
      border-color: var(--burg);
    }

    .lgn-dot.success {
      background: var(--forest);
      border-color: var(--forest);
    }

    /* Dots shake on error */
    .lgn-dots.shake {
      animation: dotShake 0.4s ease;
    }

    @keyframes dotShake {
      0%,100% { transform: translateX(0); }
      20%     { transform: translateX(-8px); }
      40%     { transform: translateX(8px); }
      60%     { transform: translateX(-5px); }
      80%     { transform: translateX(5px); }
    }

    /* Hidden real input — captures keyboard on desktop */
    #pin-input {
      position: absolute;
      opacity: 0;
      width: 1px;
      height: 1px;
      pointer-events: none;
    }

    /* Numpad */
    .lgn-pad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      width: 100%;
      max-width: 300px;
      margin-bottom: 20px;
    }

    .pad-btn {
      height: 64px;
      border-radius: 16px;
      border: 1.5px solid var(--bdr);
      background: var(--surf);
      font-family: var(--mono);
      font-size: 22px;
      font-weight: 500;
      color: var(--navy);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1px;
      transition: all 0.12s ease;
      box-shadow: 0 1px 4px rgba(27,42,74,0.06);
      -webkit-user-select: none;
      user-select: none;
    }

    .pad-btn:active {
      transform: scale(0.92);
      background: var(--bg);
      box-shadow: none;
    }

    .pad-btn .pad-letters {
      font-family: var(--font);
      font-size: 7px;
      color: var(--muted);
      letter-spacing: 1px;
      line-height: 1;
    }

    .pad-btn.pad-zero {
      grid-column: 2;
    }

    .pad-btn.pad-back {
      grid-column: 3;
      font-size: 20px;
      color: var(--muted);
      border-color: transparent;
      background: transparent;
      box-shadow: none;
    }

    .pad-btn.pad-back:active {
      background: var(--bg);
    }

    /* Status messages */
    .lgn-status {
      min-height: 20px;
      font-size: 12px;
      font-weight: 600;
      text-align: center;
      color: var(--burg);
      direction: rtl;
    }

    /* Attempt counter */
    .lgn-attempts {
      font-size: 11px;
      color: var(--muted);
      text-align: center;
      margin-top: 6px;
      min-height: 16px;
    }

    /* Verifying spinner */
    #lgn-verifying {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      min-height: 52px;
    }

    #lgn-verifying.show { display: flex; }

    .lgn-wave {
      display: flex;
      align-items: flex-end;
      gap: 5px;
      height: 24px;
    }

    .lgn-wave span {
      display: block;
      width: 5px;
      border-radius: 3px;
      background: var(--navy);
      animation: waveBar 1.1s ease-in-out infinite;
    }

    .lgn-wave span:nth-child(1) { height: 8px;  animation-delay: 0s; }
    .lgn-wave span:nth-child(2) { height: 16px; animation-delay: 0.15s; }
    .lgn-wave span:nth-child(3) { height: 24px; animation-delay: 0.3s; }
    .lgn-wave span:nth-child(4) { height: 16px; animation-delay: 0.45s; }
    .lgn-wave span:nth-child(5) { height: 8px;  animation-delay: 0.6s; }

    @keyframes waveBar {
      0%, 100% { transform: scaleY(0.4); opacity: 0.35; }
      50%       { transform: scaleY(1);   opacity: 1; }
    }

    .lgn-verif-txt {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      letter-spacing: 0.5px;
    }

    /* Lockout overlay (inside login screen) */
    #lockout-banner {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 20px;
      background: rgba(155,35,53,0.07);
      border: 1px solid rgba(155,35,53,0.22);
      border-radius: 16px;
      width: 100%;
      max-width: 300px;
      text-align: center;
    }

    #lockout-banner.show { display: flex; }

    .lo-icon { font-size: 28px; }

    .lo-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--burg);
    }

    .lo-msg {
      font-size: 12px;
      color: var(--muted);
      direction: rtl;
    }

    .lo-timer {
      font-family: var(--mono);
      font-size: 20px;
      font-weight: 500;
      color: var(--burg);
    }

    /* Welcome toast inside login (success) */
    .lgn-welcome {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      text-align: center;
    }

    .lgn-welcome.show { display: flex; }

    .lgn-welcome-icon { font-size: 36px; }
    .lgn-welcome-name {
      font-size: 18px;
      font-weight: 700;
      color: var(--navy);
    }
    .lgn-welcome-role {
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 0.5px;
    }

    /* Session info bar — shown in main app */
    #session-bar {
      display: none;
      flex-shrink: 0;
      background: var(--navy);
      padding: 6px 14px;
      align-items: center;
      justify-content: space-between;
    }

    #session-bar.show { display: flex; }

    .sb-name {
      font-size: 10px;
      font-weight: 700;
      color: rgba(255,255,255,0.7);
    }

    .sb-role {
      font-family: var(--mono);
      font-size: 8px;
      color: var(--gold);
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .sb-logout {
      font-size: 10px;
      color: rgba(255,255,255,0.4);
      cursor: pointer;
      padding: 4px 8px;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 6px;
      direction: ltr;
      transition: all 0.15s;
    }

    .sb-logout:active { color: rgba(255,255,255,0.8); }

    .sb-gear {
      display: none; /* shown only for Admin via JS */
      font-size: 16px;
      cursor: pointer;
      padding: 4px 7px;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 6px;
      transition: all 0.15s;
      line-height: 1.4;
    }

    .sb-gear:active { background: rgba(255,255,255,0.1); }

    /* ══════════════════════════════════════════════
       SETTINGS PANEL
    ══════════════════════════════════════════════ */
    #settings-panel {
      position: fixed;
      inset: 0;
      z-index: 9000;
      display: flex;
      flex-direction: column;
      background: var(--bg);
      transform: translateY(100%);
      transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
    }

    #settings-panel.open {
      transform: translateY(0);
    }

    /* Settings top bar */
    .stg-topbar {
      flex-shrink: 0;
      background: var(--navy);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-top: calc(12px + env(safe-area-inset-top));
    }

    .stg-title {
      font-size: 15px;
      font-weight: 700;
      color: #fff;
      direction: rtl;
    }

    .stg-title span {
      font-family: var(--mono);
      font-size: 9px;
      color: var(--gold);
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-right: 8px;
      display: block;
      margin-top: 1px;
    }

    .stg-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      color: rgba(255,255,255,0.7);
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.15s;
    }

    .stg-close:active { background: rgba(255,255,255,0.18); }

    /* Settings scroll area */
    .stg-scroll {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 16px 14px calc(32px + env(safe-area-inset-bottom));
    }

    .stg-scroll::-webkit-scrollbar { display: none; }

    /* Section card */
    .stg-section {
      background: var(--surf);
      border-radius: 16px;
      border: 1px solid var(--bdr);
      margin-bottom: 12px;
      overflow: hidden;
    }

    /* Section header — tap to expand */
    .stg-sec-hdr {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 15px 16px;
      cursor: pointer;
      transition: background 0.15s;
      user-select: none;
      -webkit-user-select: none;
    }

    .stg-sec-hdr:active { background: rgba(27,42,74,0.03); }

    .stg-sec-ico {
      font-size: 22px;
      flex-shrink: 0;
      width: 38px;
      height: 38px;
      background: var(--bg);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stg-sec-info { flex: 1; min-width: 0; }

    .stg-sec-title {
      font-size: 13px;
      font-weight: 700;
      color: var(--navy);
      direction: rtl;
    }

    .stg-sec-sub {
      font-size: 10px;
      color: var(--muted);
      margin-top: 1px;
      direction: ltr;
    }

    .stg-sec-arr {
      font-size: 12px;
      color: var(--muted);
      transition: transform 0.25s ease;
      flex-shrink: 0;
    }

    .stg-section.expanded .stg-sec-arr {
      transform: rotate(90deg);
    }

    /* Section body */
    .stg-sec-body {
      display: none;
      padding: 0 16px 16px;
      border-top: 1px solid var(--bdr);
    }

    .stg-section.expanded .stg-sec-body {
      display: block;
    }

    /* Field rows inside sections */
    .stg-field {
      margin-top: 14px;
    }

    .stg-field-lbl {
      font-size: 10px;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 0.5px;
      text-transform: uppercase;
      margin-bottom: 5px;
      direction: ltr;
    }

    .stg-field .inp {
      margin: 0;
    }

    /* Read-only display value */
    .stg-val {
      font-size: 14px;
      font-weight: 600;
      color: var(--navy);
      padding: 10px 0 4px;
      direction: rtl;
      border-bottom: 1px solid var(--bdr);
    }

    /* Save button inside section */
    .stg-save {
      width: 100%;
      height: 46px;
      border: none;
      border-radius: 10px;
      background: var(--navy);
      color: #fff;
      font-family: var(--font);
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 16px;
      transition: opacity 0.2s;
    }

    .stg-save:active { opacity: 0.8; }

    /* User table */
    .stg-user-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid var(--bdr);
    }

    .stg-user-row:last-child { border: none; }

    .stg-user-avatar {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: var(--navy);
      color: #fff;
      font-size: 13px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .stg-user-info { flex: 1; min-width: 0; }

    .stg-user-name {
      font-size: 13px;
      font-weight: 700;
      color: var(--navy);
      direction: rtl;
    }

    .stg-user-meta {
      font-size: 9px;
      color: var(--muted);
      direction: ltr;
      letter-spacing: 0.3px;
    }

    .stg-user-badge {
      font-family: var(--mono);
      font-size: 8px;
      font-weight: 500;
      padding: 2px 7px;
      border-radius: 4px;
      letter-spacing: 0.5px;
      flex-shrink: 0;
    }

    .badge-admin  { background: rgba(27,42,74,0.10); color: var(--navy); }
    .badge-mgmt   { background: rgba(201,168,76,0.18); color: #8a6e1a; }
    .badge-occ    { background: rgba(26,107,60,0.12); color: var(--forest); }
    .badge-off    { background: rgba(155,35,53,0.10); color: var(--burg); }

    .stg-user-actions {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    .stg-user-btn {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 6px;
      border: 1px solid var(--bdr);
      background: var(--bg);
      color: var(--navy);
      cursor: pointer;
      font-family: var(--font);
      font-weight: 600;
      transition: all 0.12s;
    }

    .stg-user-btn:active { background: var(--navy); color: #fff; }
    .stg-user-btn.danger { color: var(--burg); border-color: rgba(155,35,53,0.2); }
    .stg-user-btn.danger:active { background: var(--burg); color: #fff; }

    /* Add user button */
    .stg-add-btn {
      width: 100%;
      height: 42px;
      border: 1.5px dashed var(--bdr);
      border-radius: 10px;
      background: transparent;
      color: var(--muted);
      font-family: var(--font);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
      transition: all 0.15s;
    }

    .stg-add-btn:hover { border-color: var(--navy); color: var(--navy); }

    /* Permission grid inside user add/edit */
    .perm-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-top: 10px;
    }

    .perm-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: var(--bg);
      border-radius: 8px;
      border: 1px solid var(--bdr);
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      color: var(--navy);
      direction: ltr;
      transition: all 0.12s;
    }

    .perm-item input[type=checkbox] {
      accent-color: var(--navy);
      transform: scale(1.1);
    }

    /* Year-end specific */
    .stg-ye-status {
      background: var(--bg);
      border-radius: 10px;
      padding: 12px 14px;
      margin-top: 12px;
      font-size: 12px;
      direction: rtl;
    }

    .stg-ye-status strong {
      font-size: 14px;
      color: var(--navy);
      display: block;
      margin-bottom: 4px;
    }

    .stg-danger-btn {
      width: 100%;
      height: 46px;
      border: none;
      border-radius: 10px;
      background: var(--burg);
      color: #fff;
      font-family: var(--font);
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 12px;
      transition: opacity 0.2s;
    }

    .stg-danger-btn:active { opacity: 0.8; }

    /* List wrapper — uniform loading state */
    .stg-list-wrap {
      margin-top: 4px;
      min-height: 40px;
    }

    .stg-loading {
      font-size: 12px;
      color: var(--muted);
      padding: 12px 0;
      direction: rtl;
    }

    .stg-empty {
      font-size: 12px;
      color: var(--muted);
      padding: 12px 0;
      direction: rtl;
      font-style: italic;
    }

    .stg-err {
      font-size: 12px;
      color: var(--burg);
      padding: 12px 0;
    }

    /* Category row — two-line with status badge */
    .stg-cat-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 9px 0;
      border-bottom: 1px solid var(--bdr);
    }

    .stg-cat-row:last-child { border: none; }

    .stg-cat-info { flex: 1; min-width: 0; }

    .stg-cat-ar {
      font-size: 12px;
      font-weight: 700;
      color: var(--navy);
      direction: rtl;
    }

    .stg-cat-en {
      font-size: 10px;
      color: var(--muted);
      direction: ltr;
      margin-top: 1px;
    }

    .stg-cat-code {
      font-family: var(--mono);
      font-size: 8px;
      color: var(--muted);
      margin-top: 2px;
      direction: ltr;
    }

    .stg-cat-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      flex-shrink: 0;
    }

    /* Meter reading row */
    .stg-meter-row {
      padding: 9px 0;
      border-bottom: 1px solid var(--bdr);
    }

    .stg-meter-row:last-child { border: none; }

    .stg-meter-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .stg-meter-unit {
      font-size: 12px;
      font-weight: 700;
      color: var(--navy);
    }

    .stg-meter-date {
      font-family: var(--mono);
      font-size: 9px;
      color: var(--muted);
    }

    .stg-meter-vals {
      display: flex;
      gap: 12px;
      margin-top: 4px;
    }

    .stg-meter-val {
      font-size: 10px;
      color: var(--muted);
      direction: ltr;
    }

    .stg-meter-val strong {
      font-family: var(--mono);
      color: var(--navy);
    }

    /* YearCash table */
    .stg-yc-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
      gap: 4px;
      padding: 8px 0;
      border-bottom: 1px solid var(--bdr);
      align-items: center;
    }

    .stg-yc-row:last-child { border: none; }

    .stg-yc-hdr {
      font-size: 8px;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 0.5px;
      text-transform: uppercase;
      direction: ltr;
    }

    .stg-yc-val {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--navy);
      direction: ltr;
    }

    .stg-yc-cnt {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--muted);
      direction: ltr;
    }

    /* Desktop settings — panel appears in content area not overlay */
    @media (min-width: 769px) {
      #settings-panel {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
        z-index: 100;
      }

      #settings-panel.open {
        transform: translateX(0);
      }

      .stg-topbar {
        padding-top: 12px;
      }

      .stg-scroll {
        padding: 24px 36px 40px;
        max-width: 640px;
      }
    }

    /* ══════════════════════════════════════════════
       SCROLL ZONE
    ══════════════════════════════════════════════ */
    #scroll {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 14px 14px 16px;
    }

    #scroll::-webkit-scrollbar { display: none; }
    #scroll { scrollbar-width: none; }

    /* ══════════════════════════════════════════════
       FIXED BOTTOM NAV
    ══════════════════════════════════════════════ */
    #nav {
      flex-shrink: 0;
      background: var(--surf);
      border-top: 1px solid var(--bdr);
      box-shadow: 0 -4px 16px rgba(27,42,74,0.08);
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    .nav-tabs {
      display: flex;
      align-items: stretch;
      height: 52px;
    }

    .nav-tab {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1px;
      cursor: pointer;
      border: none;
      background: none;
      font-family: var(--font);
      transition: background 0.15s;
      padding: 0;
      position: relative;
    }

    .nav-tab:active { background: rgba(27,42,74,0.04); }

    .nav-tab::before {
      content: '';
      position: absolute;
      top: 0; left: 20%; right: 20%;
      height: 2.5px;
      border-radius: 0 0 3px 3px;
      background: transparent;
      transition: background 0.2s;
    }

    .nav-tab.n-inc::before { background: var(--forest); }
    .nav-tab.n-exp::before { background: var(--burg); }
    .nav-tab.n-rep::before { background: var(--navy); }

    .nav-ico { font-size: 20px; line-height: 1; }
    .nav-ar  { font-size: 10px; font-weight: 700; color: var(--muted); line-height: 1; }
    .nav-en  { font-size: 7px; font-weight: 500; color: var(--muted); opacity: 0.7; line-height: 1; }

    .nav-tab.n-inc .nav-ar, .nav-tab.n-inc .nav-en { color: var(--forest); opacity: 1; }
    .nav-tab.n-exp .nav-ar, .nav-tab.n-exp .nav-en { color: var(--burg);   opacity: 1; }
    .nav-tab.n-rep .nav-ar, .nav-tab.n-rep .nav-en { color: var(--navy);   opacity: 1; }

    .nav-brand {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0px;
      padding: 3px 0 calc(3px + env(safe-area-inset-bottom));
      border-top: 1px solid var(--bdr);
      background: rgba(27,42,74,0.02);
    }

    .nb-wrap { display: flex; align-items: baseline; direction: ltr; gap: 0; }
    .nb-idara { font-family: var(--font); font-size: 11px; font-weight: 700; color: var(--navy); }
    .nb-sep { display: none; }
    .nb-pro { font-family: var(--font); font-size: 11px; font-weight: 700; color: var(--burg); }
    .nb-tag { font-size: 6.5px; color: var(--muted); letter-spacing: 0.3px; line-height: 1; }
    .nb-tag b { font-family: var(--mono); font-weight: 500; color: var(--navy); opacity: 0.7; }

    /* ══════════════════════════════════════════════
       LOADER
    ══════════════════════════════════════════════ */
    #loader {
      position: fixed; inset: 0;
      background: var(--bg);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 20px; z-index: 9999;
      transition: opacity 0.4s ease;
    }

    #loader.out { opacity: 0; pointer-events: none; }

    .ldr-brand { font-size: 30px; font-weight: 700; color: var(--navy); direction: ltr; }
    .ldr-brand b { font-family: var(--font); font-size: 30px; font-weight: 700; color: var(--burg); }
    .ldr-track { width: 72px; height: 2px; background: var(--bdr); border-radius: 2px; overflow: hidden; }
    .ldr-bar { height: 100%; width: 40%; background: linear-gradient(90deg, var(--burg), var(--gold)); border-radius: 2px; animation: sweep 1s ease-in-out infinite; }
    @keyframes sweep { 0% { transform: translateX(200%); } 100% { transform: translateX(-300%); } }
    .ldr-hint { font-size: 11px; color: var(--muted); }
    .ldr-platform { font-size: 10px; color: var(--muted); direction: ltr; margin-top: -12px; letter-spacing: 0.2px; }
    .ldr-platform span { font-family: var(--mono); font-size: 9px; font-weight: 500; color: var(--navy); opacity: 0.6; }

    /* ══════════════════════════════════════════════
       TOAST
    ══════════════════════════════════════════════ */
    #toast {
      position: fixed;
      bottom: calc(var(--nav-h) + env(safe-area-inset-bottom) + 10px);
      left: 16px; right: 16px;
      padding: 13px 16px;
      border-radius: 12px;
      font-size: 14px; font-weight: 600;
      color: #fff; text-align: center;
      z-index: 8000;
      opacity: 0; transform: translateY(8px);
      pointer-events: none;
      transition: all 0.25s ease;
      box-shadow: 0 6px 20px rgba(0,0,0,0.18);
    }

    #toast.show { opacity: 1; transform: translateY(0); }
    #toast.ok   { background: var(--forest); }
    #toast.fail { background: var(--burg); }
    #toast.info { background: var(--navy); }

    /* ══════════════════════════════════════════════
       HEADER
    ══════════════════════════════════════════════ */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
    .bld-name { font-size: 15px; font-weight: 700; color: var(--navy); line-height: 1.2; }
    .bld-sub { font-size: 9px; color: var(--muted); margin-top: 1px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--forest); box-shadow: 0 0 0 3px rgba(26,107,60,0.15); flex-shrink: 0; transition: all 0.3s; }
    .dot.off { background: var(--burg); box-shadow: 0 0 0 3px rgba(155,35,53,0.15); }

    /* ══════════════════════════════════════════════
       DASHBOARD CARD
    ══════════════════════════════════════════════ */
    .dash-card { background: var(--navy); border-radius: 20px; padding: 22px 20px 18px; margin-bottom: 16px; position: relative; overflow: hidden; box-shadow: 0 10px 28px rgba(27,42,74,0.22); }
    .dash-card::before { content: ''; position: absolute; top: -45px; left: -45px; width: 160px; height: 160px; border-radius: 50%; background: rgba(201,168,76,0.07); pointer-events: none; }
    .dash-card::after  { content: ''; position: absolute; bottom: -45px; right: -25px; width: 150px; height: 150px; border-radius: 50%; background: rgba(155,35,53,0.09); pointer-events: none; }
    .d-top { display: flex; justify-content: space-between; align-items: flex-start; position: relative; z-index: 1; }
    .d-lbl-en { font-size: 9px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; color: rgba(255,255,255,0.4); }
    .d-lbl-ar { font-size: 11px; color: rgba(255,255,255,0.3); margin-top: 2px; }
    .d-heart { display: flex; flex-direction: column; align-items: center; gap: 2px; cursor: pointer; position: relative; z-index: 1; }
    .d-heart-ico { font-size: 20px; line-height: 1; animation: hb 2s ease-in-out infinite; }
    @keyframes hb { 0%,100% { transform: scale(1); } 15% { transform: scale(1.22); } 30% { transform: scale(1); } 45% { transform: scale(1.12); } }
    .d-heart-pct { font-family: var(--mono); font-size: 11px; color: rgba(255,255,255,0.75); }
    .d-amount { font-family: var(--mono); font-size: clamp(30px, 9vw, 44px); font-weight: 500; color: #fff; direction: ltr; text-align: right; letter-spacing: -1px; line-height: 1; margin: 10px 0 6px; position: relative; z-index: 1; }
    .d-line { height: 1px; background: linear-gradient(90deg, var(--gold), transparent); opacity: 0.45; border-radius: 1px; position: relative; z-index: 1; }
    .d-foot { display: flex; justify-content: space-between; align-items: center; margin-top: 9px; position: relative; z-index: 1; }
    .d-time { font-family: var(--mono); font-size: 9px; color: rgba(255,255,255,0.28); }
    .d-refresh { width: 28px; height: 28px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.5); font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s; flex-shrink: 0; }
    .d-refresh:active { opacity: 0.6; }
    .d-refresh.spin { animation: spin 0.7s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ══════════════════════════════════════════════
       CARD, LABELS, INPUTS
    ══════════════════════════════════════════════ */
    .card { background: var(--surf); border-radius: 16px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--bdr); box-shadow: 0 1px 4px rgba(27,42,74,0.05); }
    .lbl { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; }
    .l-ar { font-size: 13px; font-weight: 700; color: var(--navy); }
    .l-en { font-size: 9px; color: var(--muted); direction: ltr; }
    .inp { width: 100%; height: 54px; border: 1.5px solid var(--bdr); border-radius: 12px; background: var(--bg); font-family: var(--font); font-size: 16px; font-weight: 600; color: var(--navy); padding: 0 14px; outline: none; -webkit-appearance: none; appearance: none; transition: border-color 0.2s, box-shadow 0.2s; text-align: right; }
    .inp:focus { border-color: var(--navy); background: var(--surf); box-shadow: 0 0 0 3px rgba(27,42,74,0.07); }
    .inp.err { border-color: var(--burg); animation: shake 0.3s ease; }
    @keyframes shake { 0%,100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    select.inp { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%231B2A4A' opacity='.35'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: left 14px center; padding-left: 36px; cursor: pointer; font-size: 15px; }
    .inp-amt { font-family: var(--mono); font-size: 28px; font-weight: 400; height: 62px; text-align: center; direction: ltr; letter-spacing: -0.5px; }
    .inp-amt::placeholder { color: rgba(27,42,74,0.18); }

    /* ══════════════════════════════════════════════
       REPORT CARDS
    ══════════════════════════════════════════════ */
    .r-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin-bottom: 12px; }
    .rcard { background: var(--surf); border: 1.5px solid var(--bdr); border-radius: 12px; padding: 12px 6px; text-align: center; cursor: pointer; transition: all 0.18s ease; display: flex; flex-direction: column; align-items: center; gap: 3px; }
    .rcard:active { transform: scale(0.95); }
    .rcard.on { background: var(--navy); border-color: var(--navy); }
    .rcard.on .r-icon, .rcard.on .r-title, .rcard.on .r-sub { color: #fff; }
    .r-icon  { font-size: 18px; }
    .r-title { font-size: 11px; font-weight: 700; color: var(--navy); }
    .r-sub   { font-size: 8px; color: var(--muted); }

    /* ══════════════════════════════════════════════
       SUBMIT BUTTON
    ══════════════════════════════════════════════ */
    .btn-sub { width: 100%; height: 58px; border: none; border-radius: 12px; font-family: var(--font); font-size: 17px; font-weight: 700; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 12px; -webkit-appearance: none; transition: opacity 0.2s, transform 0.15s; }
    .btn-sub:active:not(:disabled) { opacity: 0.85; transform: scale(0.98); }
    .btn-sub:disabled { opacity: 0.3; cursor: not-allowed; }
    .b-inc { background: var(--forest); box-shadow: 0 4px 14px rgba(26,107,60,0.28); }
    .b-exp { background: var(--burg);   box-shadow: 0 4px 14px rgba(155,35,53,0.26); }
    .b-rep { background: var(--navy);   box-shadow: 0 4px 14px rgba(27,42,74,0.24); }

    /* Button processing state */
    .btn-sub.processing {
      opacity: 1 !important;
      cursor: not-allowed;
      pointer-events: none;
    }

    .btn-wave {
      display: none;
      align-items: flex-end;
      gap: 4px;
      height: 20px;
    }

    .btn-sub.processing .btn-wave { display: flex; }
    .btn-sub.processing .btn-label { display: none; }

    .btn-wave span {
      display: block;
      width: 4px;
      border-radius: 3px;
      background: rgba(255,255,255,0.9);
      animation: btnWave 1.1s ease-in-out infinite;
    }

    .btn-wave span:nth-child(1) { height: 6px;  animation-delay: 0s; }
    .btn-wave span:nth-child(2) { height: 12px; animation-delay: 0.15s; }
    .btn-wave span:nth-child(3) { height: 18px; animation-delay: 0.3s; }
    .btn-wave span:nth-child(4) { height: 12px; animation-delay: 0.45s; }
    .btn-wave span:nth-child(5) { height: 6px;  animation-delay: 0.6s; }

    @keyframes btnWave {
      0%, 100% { transform: scaleY(0.35); opacity: 0.4; }
      50%       { transform: scaleY(1);   opacity: 1; }
    }

    .btn-proc-txt {
      font-size: 13px;
      font-weight: 600;
      color: rgba(255,255,255,0.85);
      letter-spacing: 0.3px;
    }

    .btn-label {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ══════════════════════════════════════════════
       LOCK BANNER
    ══════════════════════════════════════════════ */
    #lock-banner { display: none; padding: 14px; background: rgba(155,35,53,0.07); border: 1px solid rgba(155,35,53,0.22); border-radius: 12px; font-size: 13px; color: var(--burg); text-align: center; margin-bottom: 12px; }
    .lock-btn { width: 100%; margin-top: 8px; padding: 10px; background: var(--burg); color: #fff; border: none; border-radius: 10px; font-family: var(--font); font-size: 14px; font-weight: 700; cursor: pointer; }

    /* ══════════════════════════════════════════════
       MODAL
    ══════════════════════════════════════════════ */
    #modal { display: none; position: fixed; inset: 0; background: rgba(27,42,74,0.45); z-index: 7000; align-items: flex-end; backdrop-filter: blur(3px); }
    #modal.open { display: flex; }
    .m-sheet { background: var(--surf); border-radius: 24px 24px 0 0; padding: 24px 20px calc(36px + env(safe-area-inset-bottom)); width: 100%; animation: shup 0.3s ease; }
    @keyframes shup { from { transform: translateY(100%); } to { transform: translateY(0); } }

    /* ── Contract form sheet ── */
    #contract-sheet-wrap {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(27,42,74,0.55);
      z-index: 9500;
      align-items: flex-end;
      backdrop-filter: blur(3px);
    }
    #contract-sheet-wrap.open { display: flex; }

    #contract-sheet {
      background: var(--surf);
      border-radius: 24px 24px 0 0;
      width: 100%;
      max-height: 92vh;
      overflow-y: auto;
      padding: 24px 20px calc(32px + env(safe-area-inset-bottom));
      animation: shup 0.3s ease;
    }

    #contract-sheet::-webkit-scrollbar { display: none; }

    .cs-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--navy);
      margin-bottom: 4px;
      direction: rtl;
    }

    .cs-sub {
      font-size: 10px;
      color: var(--muted);
      direction: ltr;
      margin-bottom: 18px;
    }

    .cs-field {
      margin-bottom: 14px;
    }

    .cs-lbl {
      font-size: 10px;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 0.5px;
      text-transform: uppercase;
      margin-bottom: 5px;
      direction: ltr;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .cs-lbl .req { color: var(--burg); }

    /* Contract ID preview box */
    .cs-preview {
      background: var(--bg);
      border: 1.5px solid var(--bdr);
      border-radius: 10px;
      padding: 10px 14px;
      font-family: var(--mono);
      font-size: 13px;
      font-weight: 500;
      color: var(--navy);
      letter-spacing: 0.5px;
      direction: ltr;
      min-height: 42px;
      display: flex;
      align-items: center;
    }

    .cs-preview.empty { color: var(--muted); font-size: 11px; font-family: var(--font); }

    /* Status pill */
    .cs-status-pill {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      margin-top: 4px;
    }

    .cs-status-pill.active   { background: rgba(26,107,60,0.1);  color: var(--forest); }
    .cs-status-pill.inactive { background: rgba(155,35,53,0.1);  color: var(--burg); }
    .cs-status-pill.empty    { background: var(--bg); color: var(--muted); }

    /* Warning box */
    .cs-warn {
      display: none;
      background: rgba(201,168,76,0.12);
      border: 1px solid rgba(201,168,76,0.4);
      border-radius: 10px;
      padding: 12px 14px;
      margin-bottom: 14px;
      font-size: 12px;
      color: #7a5c0a;
      direction: rtl;
      line-height: 1.5;
    }

    .cs-warn.show { display: block; }

    .cs-warn strong { display: block; margin-bottom: 4px; font-size: 13px; }

    /* Confirm checkbox */
    .cs-confirm {
      display: none;
      align-items: center;
      gap: 10px;
      background: var(--bg);
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 14px;
      font-size: 12px;
      color: var(--navy);
      cursor: pointer;
    }

    .cs-confirm.show { display: flex; }
    .cs-confirm input { accent-color: var(--burg); transform: scale(1.15); }

    /* Buttons */
    .cs-btns { display: flex; gap: 10px; margin-top: 6px; }

    .cs-submit {
      flex: 1;
      height: 50px;
      border: none;
      border-radius: 12px;
      background: var(--forest);
      color: #fff;
      font-family: var(--font);
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .cs-submit:disabled { opacity: 0.3; cursor: not-allowed; }
    .cs-submit:active:not(:disabled) { opacity: 0.8; }

    .cs-cancel {
      height: 50px;
      padding: 0 22px;
      border: 1.5px solid var(--bdr);
      border-radius: 12px;
      background: transparent;
      color: var(--muted);
      font-family: var(--font);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }

    @media (min-width: 769px) {
      #contract-sheet-wrap { align-items: center; justify-content: center; }
      #contract-sheet {
        border-radius: 20px;
        max-width: 500px;
        max-height: 88vh;
        padding: 32px 28px 32px;
        animation: fadeUp 0.25s ease;
      }
    }
    .m-title { font-size: 16px; font-weight: 700; text-align: center; margin-bottom: 16px; }
    .m-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--bdr); font-size: 13px; }
    .m-row:last-of-type { border: none; }
    .m-val { font-family: var(--mono); font-weight: 500; color: var(--forest); }
    .m-confirm { display: flex; align-items: center; gap: 10px; background: var(--bg); border-radius: 10px; padding: 12px; margin: 12px 0; cursor: pointer; font-size: 13px; }
    .m-confirm input { transform: scale(1.2); accent-color: var(--navy); }
    .m-ok { width: 100%; height: 50px; background: var(--forest); color: #fff; border: none; border-radius: 12px; font-family: var(--font); font-size: 15px; font-weight: 700; cursor: pointer; margin-bottom: 10px; }
    .m-cancel { width: 100%; height: 44px; background: var(--bg); color: var(--muted); border: none; border-radius: 12px; font-family: var(--font); font-size: 13px; font-weight: 600; cursor: pointer; }

    .hide     { display: none !important; }
    .disabled { opacity: 0.35; pointer-events: none; }

    /* ══════════════════════════════════════════════
       DESKTOP LAYOUT  ≥ 769px
    ══════════════════════════════════════════════ */
    @media (min-width: 769px) {

      html, body { height: 100%; overflow: hidden; }
      body { flex-direction: column; background: #E8E7E2; }

      #dt-topbar {
        flex-shrink: 0; height: 64px;
        background: #ffffff;
        display: flex !important;
        align-items: center;
        justify-content: space-between;
        padding: 0 36px;
        border-bottom: 3px solid var(--gold);
        box-shadow: 0 1px 8px rgba(27,42,74,0.07);
      }

      .dt-topbrand { display: flex; align-items: center; gap: 12px; direction: ltr; }
      .dt-brand-mark { display: flex; align-items: baseline; gap: 0; }
      .dt-b-idara { font-family: var(--font); font-size: 18px; font-weight: 700; color: var(--navy); letter-spacing: -0.3px; }
      .dt-b-pro   { font-family: var(--font); font-size: 18px; font-weight: 700; color: var(--burg); letter-spacing: -0.3px; }
      .dt-b-divider { width: 1px; height: 22px; background: #D0CEC8; margin: 0 12px; }
      .dt-b-platform { font-size: 9px; color: #aaa; letter-spacing: 0.3px; direction: ltr; line-height: 1.4; }
      .dt-b-platform span { font-weight: 600; color: #888; }

      .dt-bld { display: flex; flex-direction: column; align-items: flex-end; }
      .dt-bld-name { font-size: 15px; font-weight: 700; color: var(--navy); line-height: 1.2; direction: rtl; }
      .dt-bld-sub  { font-size: 9px; color: #aaa; letter-spacing: 0.5px; text-transform: uppercase; }

      /* Session info in topbar */
      .dt-session {
        display: flex;
        align-items: center;
        gap: 10px;
        direction: ltr;
      }

      .dt-session-name {
        font-size: 11px;
        font-weight: 700;
        color: var(--navy);
      }

      .dt-session-role {
        font-family: var(--mono);
        font-size: 8px;
        color: var(--muted);
        letter-spacing: 1px;
        text-transform: uppercase;
        padding: 2px 6px;
        border: 1px solid var(--bdr);
        border-radius: 4px;
      }

      .dt-logout {
        font-size: 10px;
        color: var(--muted);
        cursor: pointer;
        padding: 4px 10px;
        border: 1px solid var(--bdr);
        border-radius: 6px;
        transition: all 0.15s;
        font-family: var(--font);
      }

      .dt-logout:hover { color: var(--burg); border-color: var(--burg); }

      .dt-gear {
        font-size: 16px;
        cursor: pointer;
        padding: 4px 8px;
        border: 1px solid var(--bdr);
        border-radius: 6px;
        transition: all 0.15s;
        line-height: 1.4;
      }

      .dt-gear:hover { border-color: var(--navy); background: var(--bg); }

      .dt-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--forest); box-shadow: 0 0 0 3px rgba(26,107,60,0.2); transition: all 0.3s; }
      .dt-dot.off { background: var(--burg); box-shadow: 0 0 0 3px rgba(155,35,53,0.2); }

      #dt-main {
        flex: 1; min-height: 0;
        display: flex !important;
        overflow: hidden;
      }

      #dt-sidebar {
        width: 320px; flex-shrink: 0;
        display: flex !important;
        flex-direction: column;
        gap: 16px;
        padding: 24px 20px;
        overflow-y: auto;
        background: #E0DFD9;
        border-left: 1px solid rgba(27,42,74,0.08);
      }
      #dt-sidebar::-webkit-scrollbar { display: none; }

      .dt-sidebar-label { font-size: 9px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); margin-bottom: -8px; }

      #dt-content {
        flex: 1; min-width: 0;
        display: flex !important;
        flex-direction: column;
        overflow: hidden;
        background: var(--bg);
      }

      #dt-tabs {
        flex-shrink: 0; height: 54px;
        background: var(--surf);
        border-bottom: 1px solid var(--bdr);
        display: flex !important;
        align-items: stretch;
        padding: 0 28px;
        gap: 4px;
        box-shadow: 0 1px 4px rgba(27,42,74,0.05);
      }

      .dt-tab { display: flex; align-items: center; gap: 8px; padding: 0 22px; border: none; background: none; font-family: var(--font); font-size: 13px; font-weight: 700; color: var(--muted); cursor: pointer; border-bottom: 2.5px solid transparent; transition: all 0.18s; }
      .dt-tab:hover { color: var(--navy); background: rgba(27,42,74,0.025); }
      .dt-tab.dt-inc { border-bottom-color: var(--forest); color: var(--forest); }
      .dt-tab.dt-exp { border-bottom-color: var(--burg);   color: var(--burg);   }
      .dt-tab.dt-rep { border-bottom-color: var(--navy);   color: var(--navy);   }
      .dt-tab-ico { font-size: 16px; }

      #dt-form-scroll { display: none; }

      #nav    { display: none !important; }

      #scroll {
        display: block !important;
        overflow-y: auto;
        padding: 28px 36px;
        flex: 1;
        min-height: 0;
      }

      #scroll .header     { display: none; }
      #scroll .dash-card  { display: none; }
      #scroll #lock-banner { max-width: 520px; }
      #scroll .card    { max-width: 520px; }
      #scroll .r-grid  { max-width: 520px; }
      #scroll #f-rep > .card { max-width: 520px; }

      .dash-card { margin-bottom: 0; border-radius: 16px; }

      #session-bar { display: none !important; } /* desktop uses topbar instead */

      #toast {
        bottom: 28px; left: 50%; right: auto;
        width: 360px;
        transform: translateX(-50%) translateY(8px);
      }
      #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

      #modal { align-items: center; justify-content: center; }
      .m-sheet {
        border-radius: 20px; max-width: 460px;
        padding: 32px 28px;
        animation: fadeUp 0.25s ease;
      }
      @keyframes fadeUp {
        from { opacity: 0; transform: translateY(16px); }
        to   { opacity: 1; transform: translateY(0); }
      }

      /* Login screen — larger on desktop */
      #login-screen {
        padding: 40px;
      }

      .lgn-pad {
        max-width: 280px;
      }
    }

    #dt-topbar, #dt-main { display: none; }
  </style>
</head>
<body>

<!-- ══════════════════════════════════════════════
     LOADER
══════════════════════════════════════════════ -->
<div id="loader">
  <div class="ldr-brand">idara<b>BUILDING</b></div>
  <div class="ldr-platform">a platform of <span>idara360</span></div>
  <div class="ldr-track"><div class="ldr-bar"></div></div>
  <div class="ldr-hint">جاري التحميل / Loading...</div>
</div>

<!-- ══════════════════════════════════════════════
     LOGIN SCREEN
══════════════════════════════════════════════ -->
<div id="login-screen">

  <!-- Brand -->
  <div class="lgn-brand">
    <div class="lgn-brand-mark">
      <span class="lgn-b-idara">idara</span><span class="lgn-b-building">BUILDING</span>
    </div>
    <div class="lgn-b-tag">a platform of idara360</div>
  </div>

  <div class="lgn-divider"></div>

  <!-- Building name (filled after GAS call) -->
  <div class="lgn-bld" id="lgn-bld-name"></div>

  <!-- Welcome state (shown briefly after correct PIN) -->
  <div class="lgn-welcome" id="lgn-welcome">
    <div class="lgn-welcome-icon">✅</div>
    <div class="lgn-welcome-name" id="lgn-welcome-name"></div>
    <div class="lgn-welcome-role" id="lgn-welcome-role"></div>
  </div>

  <!-- Normal login state -->
  <div id="lgn-main">
    <div class="lgn-prompt">أدخل رمز الدخول / Enter PIN</div>

    <!-- PIN dots -->
    <div class="lgn-dots" id="lgn-dots">
      <div class="lgn-dot" id="d0"></div>
      <div class="lgn-dot" id="d1"></div>
      <div class="lgn-dot" id="d2"></div>
      <div class="lgn-dot" id="d3"></div>
    </div>

    <!-- Hidden input for desktop keyboard -->
    <input type="password" id="pin-input" inputmode="numeric"
           maxlength="4" autocomplete="off" pattern="[0-9]*">

    <!-- Numpad -->
    <div class="lgn-pad" id="lgn-pad">
      <button class="pad-btn" onclick="padPress('1')">1<span class="pad-letters"></span></button>
      <button class="pad-btn" onclick="padPress('2')">2<span class="pad-letters">ABC</span></button>
      <button class="pad-btn" onclick="padPress('3')">3<span class="pad-letters">DEF</span></button>
      <button class="pad-btn" onclick="padPress('4')">4<span class="pad-letters">GHI</span></button>
      <button class="pad-btn" onclick="padPress('5')">5<span class="pad-letters">JKL</span></button>
      <button class="pad-btn" onclick="padPress('6')">6<span class="pad-letters">MNO</span></button>
      <button class="pad-btn" onclick="padPress('7')">7<span class="pad-letters">PQRS</span></button>
      <button class="pad-btn" onclick="padPress('8')">8<span class="pad-letters">TUV</span></button>
      <button class="pad-btn" onclick="padPress('9')">9<span class="pad-letters">WXYZ</span></button>
      <div></div><!-- empty cell -->
      <button class="pad-btn pad-zero" onclick="padPress('0')">0</button>
      <button class="pad-btn pad-back" onclick="padBack()">⌫</button>
    </div>

    <!-- Verifying spinner (shown during GAS call) -->
    <div id="lgn-verifying">
      <div class="lgn-wave">
        <span></span><span></span><span></span><span></span><span></span>
      </div>
      <div class="lgn-verif-txt">جاري التحقق / Verifying...</div>
    </div>

    <!-- Status + attempts (shown on wrong PIN / error) -->
    <div class="lgn-status" id="lgn-status"></div>
    <div class="lgn-attempts" id="lgn-attempts"></div>
  </div>

  <!-- Lockout banner -->
  <div id="lockout-banner">
    <div class="lo-icon">🔒</div>
    <div class="lo-title">تم تجميد الحساب / Account Locked</div>
    <div class="lo-msg">محاولات خاطئة متعددة<br>Too many failed attempts</div>
    <div class="lo-timer" id="lo-timer">30:00</div>
    <div class="lo-msg" style="font-size:10px;">يُرجى الانتظار / Please wait</div>
  </div>

</div>
<!-- /login-screen -->

<!-- ══════════════════════════════════════════════
     TOAST
══════════════════════════════════════════════ -->
<div id="toast"></div>

<!-- ══════════════════════════════════════════════
     SESSION BAR (mobile — shown below session start)
══════════════════════════════════════════════ -->
<div id="session-bar">
  <div>
    <div class="sb-name" id="sb-name"></div>
    <div class="sb-role" id="sb-role"></div>
  </div>
  <div style="display:flex;align-items:center;gap:8px;direction:ltr;">
    <div class="sb-gear" id="sb-gear" onclick="openSettings()">⚙️</div>
    <div class="sb-logout" onclick="doLogout()">خروج / Logout</div>
  </div>
</div>

<!-- ══════════════════════════════════════════════
     SCROLL ZONE
══════════════════════════════════════════════ -->
<div id="scroll">

  <div class="header">
    <div>
      <div class="bld-name" id="bldName">...</div>
      <div class="bld-sub">Building Management</div>
    </div>
    <div class="dot" id="dot"></div>
  </div>

  <div class="dash-card">
    <div class="d-top">
      <div>
        <div class="d-lbl-en">CASH ON HAND</div>
        <div class="d-lbl-ar">النقد المتوفر</div>
      </div>
      <div class="d-heart" onclick="refreshDash()">
        <span class="d-heart-ico" id="heart">💚</span>
        <span class="d-heart-pct" id="hpct">—%</span>
      </div>
    </div>
    <div class="d-amount" id="cashAmt">Loading...</div>
    <div class="d-line"></div>
    <div class="d-foot">
      <div class="d-time" id="dashTime">—</div>
      <button class="d-refresh" id="rBtn" onclick="refreshDash()">↻</button>
    </div>
  </div>

  <div id="lock-banner">
    <strong>⚠️ Fiscal Year Mismatch</strong><br>
    <span id="lock-msg"></span>
    <button class="lock-btn" onclick="openFiscal()">إغلاق السنة / Close Year</button>
  </div>

  <form id="form" onsubmit="event.preventDefault(); doSubmit();">
    <input type="hidden" id="eType" value="Income">

    <div class="card" id="f-inc">
      <div class="lbl"><span class="l-ar">شاغل القسم</span><span class="l-en">Occupant of Unit</span></div>
      <select class="inp" id="sel-owner"><option value="" disabled selected>اختر / Select...</option></select>
      <div class="lbl" style="margin-top:12px;"><span class="l-ar">الفئة</span><span class="l-en">Category</span></div>
      <select class="inp" id="sel-icat"><option value="" disabled selected>اختر / Select...</option></select>
    </div>

    <div class="card hide" id="f-exp">
      <div class="lbl"><span class="l-ar">فئة المصروف</span><span class="l-en">Expense Category</span></div>
      <select class="inp" id="sel-ecat"><option value="" disabled selected>اختر / Select...</option></select>
    </div>

    <div class="hide" id="f-rep">
      <div class="r-grid">
        <div class="rcard on" id="rc-ytd" onclick="pickReport('YTD')">
          <span class="r-icon">📊</span><span class="r-title">YTD</span><span class="r-sub">تراكمي</span>
        </div>
        <div class="rcard" id="rc-month" onclick="pickReport('CurrentMonth')">
          <span class="r-icon">📅</span><span class="r-title">هذا الشهر</span><span class="r-sub">This Month</span>
        </div>
        <div class="rcard" id="rc-journal" onclick="pickReport('Journal')">
          <span class="r-icon">📖</span><span class="r-title">اليومية</span><span class="r-sub">Journal</span>
        </div>
      </div>
      <div class="card">
        <div class="lbl"><span class="l-ar">نوع التقرير</span><span class="l-en">Report Type</span></div>
        <select class="inp" id="sel-rep" onchange="pickReport(this.value)">
          <option value="YTD">YTD — تراكمي سنوي</option>
          <option value="CurrentMonth">هذا الشهر / This Month</option>
          <option value="LastMonth">الشهر الماضي / Last Month</option>
          <option value="Journal">دفتر اليومية / Journal</option>
        </select>
      </div>
    </div>

    <div class="card" id="f-amt">
      <div class="lbl"><span class="l-ar">المبلغ</span><span class="l-en">Amount $</span></div>
      <input type="number" step="0.01" min="0" class="inp inp-amt" id="inp-amt" placeholder="0.00" inputmode="decimal">
    </div>

    <!-- Submit button — no more PIN field -->
    <div class="card">
      <button type="submit" class="btn-sub b-inc" id="btn-sub">
        <!-- Processing state -->
        <div class="btn-wave">
          <span></span><span></span><span></span><span></span><span></span>
        </div>
        <span class="btn-proc-txt" id="btn-proc-txt"></span>
        <!-- Normal label -->
        <span class="btn-label" id="btn-label">
          <span id="btn-ico">💰</span>
          <span id="btn-txt">تسجيل الدفعة / Record Payment</span>
        </span>
      </button>
    </div>

  </form>

</div><!-- /scroll -->

<!-- ══════════════════════════════════════════════
     FIXED BOTTOM NAV
══════════════════════════════════════════════ -->
<nav id="nav">
  <div class="nav-tabs">
    <button class="nav-tab n-inc" id="t-inc" onclick="setTab('Income')">
      <span class="nav-ico">💰</span>
      <span class="nav-ar">قبض</span>
      <span class="nav-en">Income</span>
    </button>
    <button class="nav-tab" id="t-exp" onclick="setTab('Expense')">
      <span class="nav-ico">📉</span>
      <span class="nav-ar">مصروف</span>
      <span class="nav-en">Expense</span>
    </button>
    <button class="nav-tab" id="t-rep" onclick="setTab('Report')">
      <span class="nav-ico">📄</span>
      <span class="nav-ar">تقارير</span>
      <span class="nav-en">Reports</span>
    </button>
  </div>
  <div class="nav-brand">
    <div class="nb-wrap">
      <span class="nb-idara">idara</span>
      <span class="nb-sep"></span>
      <span class="nb-pro">BUILDING</span>
    </div>
    <div class="nb-tag">a platform of <b>idara360</b></div>
  </div>
</nav>

<!-- ══════════════════════════════════════════════
     FISCAL MODAL
══════════════════════════════════════════════ -->
<div id="modal">
  <div class="m-sheet">
    <div class="m-title">إغلاق السنة المالية / Year-End Closing</div>
    <div class="m-row"><span>Closing Year</span><span class="m-val" id="cy-close">—</span></div>
    <div class="m-row"><span>New Year</span><span class="m-val" id="cy-open">—</span></div>
    <div class="m-row"><span>Cash Carry Forward</span><span class="m-val" id="cy-cash">—</span></div>
    <div class="m-row"><span>Units</span><span class="m-val" id="cy-units">—</span></div>
    <label class="m-confirm">
      <input type="checkbox" id="conf-chk">
      I verify these balances are correct
    </label>
    <button class="m-ok" onclick="execClose()">Execute &amp; Close</button>
    <button class="m-cancel" onclick="closeModal()">Cancel / إلغاء</button>
  </div>
</div>

<!-- ══════════════════════════════════════════════
     DESKTOP CHROME
══════════════════════════════════════════════ -->
<div id="dt-topbar">
  <div class="dt-topbrand">
    <div class="dt-brand-mark">
      <span class="dt-b-idara">idara</span><span class="dt-b-pro">BUILDING</span>
    </div>
    <div class="dt-b-divider"></div>
    <div class="dt-b-platform">a platform of <span>idara360</span></div>
    <div class="dt-dot" id="dt-dot"></div>
  </div>
  <!-- Session info (shown after login) -->
  <div class="dt-session" id="dt-session" style="display:none;">
    <div>
      <div class="dt-session-name" id="dt-session-name"></div>
      <div class="dt-session-role" id="dt-session-role"></div>
    </div>
    <div class="dt-gear" id="dt-gear" onclick="openSettings()" style="display:none;">⚙️</div>
    <div class="dt-logout" onclick="doLogout()">خروج / Logout</div>
  </div>
  <div class="dt-bld">
    <div class="dt-bld-name" id="dt-bldName">...</div>
    <div class="dt-bld-sub">Building Management</div>
  </div>
</div>

<div id="dt-main">
  <div id="dt-sidebar">
    <div class="dt-sidebar-label">Overview</div>
    <div class="dash-card" id="dt-dash">
      <div class="d-top">
        <div>
          <div class="d-lbl-en">CASH ON HAND</div>
          <div class="d-lbl-ar">النقد المتوفر</div>
        </div>
        <div class="d-heart" onclick="refreshDash()">
          <span class="d-heart-ico" id="dt-heart">💚</span>
          <span class="d-heart-pct" id="dt-hpct">—%</span>
        </div>
      </div>
      <div class="d-amount" id="dt-cashAmt">Loading...</div>
      <div class="d-line"></div>
      <div class="d-foot">
        <div class="d-time" id="dt-dashTime">—</div>
        <button class="d-refresh" id="dt-rBtn" onclick="refreshDash()">↻</button>
      </div>
    </div>
  </div>

  <div id="dt-content">
    <div id="dt-tabs">
      <button class="dt-tab dt-inc" id="dt-t-inc" onclick="setTab('Income')">
        <span class="dt-tab-ico">💰</span> قبض / Income
      </button>
      <button class="dt-tab" id="dt-t-exp" onclick="setTab('Expense')">
        <span class="dt-tab-ico">📉</span> مصروف / Expense
      </button>
      <button class="dt-tab" id="dt-t-rep" onclick="setTab('Report')">
        <span class="dt-tab-ico">📄</span> تقارير / Reports
      </button>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════════
     JAVASCRIPT
══════════════════════════════════════════════ -->
<script>

// ── Constants ────────────────────────────────────────────────────────────────
var GAS = 'https://script.google.com/macros/s/AKfycbxAXi3phO9lrfi9cWmbIVID-kwnbWSogVB7wM3PwvNi40y8uOgmmrHdU-EqIHz_rkXv/exec';
var SESSION_DURATION_MS = 8 * 60 * 60 * 1000;  // 8 hours
var MAX_ATTEMPTS        = 5;
var LOCKOUT_DURATION_MS = 30 * 60 * 1000;       // 30 minutes

// ── State ────────────────────────────────────────────────────────────────────
var TAB     = 'Income';
var REPORT  = 'YTD';
var _fiscal = null;
var _rtimer = null;
var _ttimer = null;
var _sessionTimer = null;

// Login state
var _pinBuffer    = '';
var _attempts     = 0;
var _lockedUntil  = 0;
var _lockTimer    = null;

// Session (in-memory only)
// { token, name, role, permissions, expires }
var _session = null;

// ── GAS helpers ──────────────────────────────────────────────────────────────
function gasGet(action, token) {
  var url = GAS + '?action=' + encodeURIComponent(action);
  if (token) url += '&token=' + encodeURIComponent(token);
  return fetch(url)
    .then(function(r) { return r.json(); })
    .then(function(r) { if (!r.ok) throw new Error(r.error); return r.data; });
}

function gasPost(body) {
  return fetch(GAS, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' },
    body: JSON.stringify(body)
  })
    .then(function(r) { return r.json(); })
    .then(function(r) { if (!r.ok) throw new Error(r.error); return r.data; });
}

// ══════════════════════════════════════════════════════════════════════════════
// BOOT
// ══════════════════════════════════════════════════════════════════════════════
window.onload = function() {
  // Fetch building name for login screen (lightweight getAppData call)
  gasGet('getBuildingName')
    .then(function(name) {
      if (name) {
        document.getElementById('lgn-bld-name').textContent = name;
        document.getElementById('dt-bldName').textContent   = name;
      }
    })
    .catch(function() {});

  // Show login screen, focus hidden input for desktop keyboard
  showLoginScreen();
  hideLo();
  watchNet();
};

function hideLo() {
  var lo = document.getElementById('loader');
  if (!lo) return;
  lo.classList.add('out');
  setTimeout(function() { lo.style.display = 'none'; }, 500);
}

// ══════════════════════════════════════════════════════════════════════════════
// LOGIN SCREEN
// ══════════════════════════════════════════════════════════════════════════════

function showLoginScreen() {
  var ls = document.getElementById('login-screen');
  ls.style.display = 'flex';
  ls.classList.remove('out');
  _pinBuffer = '';
  _attempts  = 0;
  updateDots();
  setLoginStatus('');

  // Focus hidden input so desktop keyboard works
  setTimeout(function() {
    document.getElementById('pin-input').focus();
  }, 100);

  // Check if still locked out
  if (_lockedUntil > Date.now()) {
    showLockout();
  }
}

function hideLoginScreen() {
  var ls = document.getElementById('login-screen');
  ls.classList.add('out');
  setTimeout(function() { ls.style.display = 'none'; }, 420);
}

// ── PIN buffer management ────────────────────────────────────────────────────
function padPress(digit) {
  if (_lockedUntil > Date.now()) return;
  if (_pinBuffer.length >= 4) return;
  _pinBuffer += digit;
  updateDots();
  // Sync hidden input (for consistency)
  document.getElementById('pin-input').value = _pinBuffer;
  if (_pinBuffer.length === 4) {
    setTimeout(submitPin, 120); // tiny delay so last dot fills visually
  }
}

function padBack() {
  if (_lockedUntil > Date.now()) return;
  if (_pinBuffer.length === 0) return;
  _pinBuffer = _pinBuffer.slice(0, -1);
  updateDots();
  document.getElementById('pin-input').value = _pinBuffer;
}

function updateDots() {
  for (var i = 0; i < 4; i++) {
    var dot = document.getElementById('d' + i);
    dot.classList.remove('filled', 'error', 'success');
    if (i < _pinBuffer.length) dot.classList.add('filled');
  }
}

function setDotsError() {
  for (var i = 0; i < 4; i++)
    document.getElementById('d' + i).classList.add('error');
  document.getElementById('lgn-dots').classList.add('shake');
  setTimeout(function() {
    document.getElementById('lgn-dots').classList.remove('shake');
  }, 500);
}

function setDotsSuccess() {
  for (var i = 0; i < 4; i++) {
    document.getElementById('d' + i).classList.remove('filled');
    document.getElementById('d' + i).classList.add('success');
  }
}

function setLoginStatus(msg) {
  document.getElementById('lgn-status').textContent = msg;
}

function setAttemptsMsg(msg) {
  document.getElementById('lgn-attempts').textContent = msg;
}

// ── PIN submission ───────────────────────────────────────────────────────────
function submitPin() {
  if (_lockedUntil > Date.now()) return;

  var pin = _pinBuffer;
  _pinBuffer = '';
  updateDots();

  // Show verifying spinner, hide status text
  disablePad(true);
  showVerifying(true);
  setLoginStatus('');

  gasPost({ action: 'login', pin: pin })
    .then(function(auth) {
      showVerifying(false);
      disablePad(false);
      if (!auth) {
        onWrongPin();
        return;
      }
      onLoginSuccess(auth);
    })
    .catch(function(e) {
      showVerifying(false);
      disablePad(false);
      setLoginStatus('⚠️ Connection error. Try again.');
      setTimeout(function() { setLoginStatus(''); }, 3000);
    });
}

function disablePad(state) {
  var btns = document.querySelectorAll('.pad-btn');
  btns.forEach(function(b) { b.disabled = state; });
}

function showVerifying(state) {
  var el = document.getElementById('lgn-verifying');
  if (state) {
    el.classList.add('show');
  } else {
    el.classList.remove('show');
  }
}

function setBtnProcessing(state) {
  var btn  = document.getElementById('btn-sub');
  var proc = document.getElementById('btn-proc-txt');
  if (state) {
    // Set contextual message based on current tab
    var msgs = {
      'Income':  'جاري الحفظ / Saving...',
      'Expense': 'جاري الحفظ / Saving...',
      'Report':  'جاري الإرسال / Sending...'
    };
    proc.textContent = msgs[TAB] || 'جاري المعالجة / Processing...';
    btn.classList.add('processing');
    btn.disabled = true;
  } else {
    btn.classList.remove('processing');
    btn.disabled = false;
    proc.textContent = '';
  }
}

// ── Wrong PIN ────────────────────────────────────────────────────────────────
function onWrongPin() {
  _attempts++;
  setDotsError();

  var remaining = MAX_ATTEMPTS - _attempts;

  if (remaining <= 0) {
    // Lockout
    _lockedUntil = Date.now() + LOCKOUT_DURATION_MS;
    _attempts = 0;
    setTimeout(showLockout, 600);
    return;
  }

  var msg = 'رمز خاطئ / Wrong PIN';
  if (remaining <= 2) {
    msg += ' — ' + remaining + ' attempt' + (remaining === 1 ? '' : 's') + ' remaining';
  }
  setLoginStatus(msg);
  setAttemptsMsg('');

  // Clear dots after shake
  setTimeout(function() {
    for (var i = 0; i < 4; i++)
      document.getElementById('d' + i).classList.remove('error', 'filled');
    setLoginStatus('');
  }, 1200);
}

// ── Lockout ──────────────────────────────────────────────────────────────────
function showLockout() {
  document.getElementById('lgn-main').style.display  = 'none';
  document.getElementById('lockout-banner').classList.add('show');
  startLockoutCountdown();
}

function startLockoutCountdown() {
  if (_lockTimer) clearInterval(_lockTimer);
  _lockTimer = setInterval(function() {
    var remaining = Math.max(0, _lockedUntil - Date.now());
    var mins = Math.floor(remaining / 60000);
    var secs = Math.floor((remaining % 60000) / 1000);
    document.getElementById('lo-timer').textContent =
      pad(mins) + ':' + pad(secs);

    if (remaining <= 0) {
      clearInterval(_lockTimer);
      _lockTimer = null;
      _lockedUntil = 0;
      hideLockout();
    }
  }, 1000);
}

function hideLockout() {
  document.getElementById('lgn-main').style.display  = '';
  document.getElementById('lockout-banner').classList.remove('show');
  setLoginStatus('');
  setAttemptsMsg('');
  updateDots();
}

// ── Login success ────────────────────────────────────────────────────────────
function onLoginSuccess(auth) {
  setDotsSuccess();
  _attempts = 0;

  // Brief welcome message
  document.getElementById('lgn-main').style.display = 'none';
  var welcome = document.getElementById('lgn-welcome');
  welcome.classList.add('show');
  document.getElementById('lgn-welcome-name').textContent =
    'أهلاً، ' + auth.name + ' / Welcome';
  document.getElementById('lgn-welcome-role').textContent =
    auth.role.toUpperCase();

  // Start session
  startSession(auth);

  // Transition to main app after welcome flash
  setTimeout(function() {
    hideLoginScreen();
    launchApp(auth);
  }, 900);
}

// ══════════════════════════════════════════════════════════════════════════════
// SESSION MANAGEMENT
// ══════════════════════════════════════════════════════════════════════════════

function startSession(auth) {
  var now = Date.now();
  _session = {
    token:       auth.name + '_' + now,
    name:        auth.name,
    role:        auth.role,
    permissions: auth.permissions,
    expires:     now + SESSION_DURATION_MS
  };

  // Auto-expire
  if (_sessionTimer) clearTimeout(_sessionTimer);
  _sessionTimer = setTimeout(function() {
    toast('⏱ Session expired. Please log in again.', 'info');
    setTimeout(doLogout, 2500);
  }, SESSION_DURATION_MS);
}

function sessionValid() {
  return _session && Date.now() < _session.expires;
}

function doLogout() {
  _session = null;
  if (_sessionTimer) { clearTimeout(_sessionTimer); _sessionTimer = null; }
  if (_rtimer)       { clearInterval(_rtimer);       _rtimer = null; }

  // Hide session bar + desktop session info
  document.getElementById('session-bar').classList.remove('show');
  showGear(false);
  var dtSess = document.getElementById('dt-session');
  if (dtSess) dtSess.style.display = 'none';

  // Reset welcome state for next login
  document.getElementById('lgn-welcome').classList.remove('show');
  document.getElementById('lgn-main').style.display = '';
  for (var i = 0; i < 4; i++)
    document.getElementById('d' + i).classList.remove('filled','error','success');

  showLoginScreen();
}

// ══════════════════════════════════════════════════════════════════════════════
// APP LAUNCH (called after successful login)
// ══════════════════════════════════════════════════════════════════════════════

function launchApp(auth) {
  // Show session bar on mobile
  document.getElementById('sb-name').textContent = auth.name;
  document.getElementById('sb-role').textContent = auth.role;
  document.getElementById('session-bar').classList.add('show');

  // Show desktop session info
  var dtSess = document.getElementById('dt-session');
  if (dtSess) {
    document.getElementById('dt-session-name').textContent = auth.name;
    document.getElementById('dt-session-role').textContent = auth.role;
    dtSess.style.display = 'flex';
  }

  // Show gear icon only for Admin
  showGear(auth.role === 'Admin');

  // Apply tab visibility based on permissions
  applyPermissionUI(auth);

  // Load app data from GAS
  gasGet('getAppData')
    .then(function(d) { initApp(d); })
    .catch(function() {
      toast('⚠️ Could not load app data. Check connection.', 'fail');
    });

  // Start dashboard refresh
  refreshDash();
  _rtimer = setInterval(refreshDash, 30000);

  // On desktop: move #scroll into #dt-content
  if (window.innerWidth >= 769) {
    var dtContent = document.getElementById('dt-content');
    var scroll    = document.getElementById('scroll');
    if (dtContent && scroll && !dtContent.contains(scroll)) {
      dtContent.appendChild(scroll);
    }
  }
}

function applyPermissionUI(auth) {
  var perms = auth.permissions;
  var role  = auth.role;

  // Mobile nav tabs
  var tInc = document.getElementById('t-inc');
  var tExp = document.getElementById('t-exp');
  var tRep = document.getElementById('t-rep');

  // Desktop tabs
  var dtInc = document.getElementById('dt-t-inc');
  var dtExp = document.getElementById('dt-t-exp');
  var dtRep = document.getElementById('dt-t-rep');

  // For Admin — show everything (no changes needed)
  if (role === 'Admin') return;

  // For Management — hide tabs the user has no permissions for
  // (hide income tab if no INC permission AND no EXP permission, etc.)
  // Only hide a tab if the user has NO relevant permissions at all
  var hasAnyReport = perms.REP_YTD || perms.REP_CUR || perms.REP_LST || perms.REP_JRN;

  if (!perms.INC) { tInc.classList.add('hide'); if(dtInc) dtInc.classList.add('hide'); }
  if (!perms.EXP) { tExp.classList.add('hide'); if(dtExp) dtExp.classList.add('hide'); }
  if (!hasAnyReport) { tRep.classList.add('hide'); if(dtRep) dtRep.classList.add('hide'); }

  // If income tab hidden, default to first visible tab
  if (!perms.INC) {
    if (perms.EXP) setTab('Expense');
    else if (hasAnyReport) setTab('Report');
  }

  // Hide report type options the user can't access
  if (!perms.REP_YTD)  document.querySelector('[value="YTD"]')          && (document.querySelector('#sel-rep [value="YTD"]').style.display    = 'none');
  if (!perms.REP_CUR)  document.querySelector('#sel-rep [value="CurrentMonth"]') && (document.querySelector('#sel-rep [value="CurrentMonth"]').style.display = 'none');
  if (!perms.REP_LST)  document.querySelector('#sel-rep [value="LastMonth"]')    && (document.querySelector('#sel-rep [value="LastMonth"]').style.display    = 'none');
  if (!perms.REP_JRN)  document.querySelector('#sel-rep [value="Journal"]')      && (document.querySelector('#sel-rep [value="Journal"]').style.display      = 'none');
}

// ══════════════════════════════════════════════════════════════════════════════
// INIT APP (unchanged logic, called after login)
// ══════════════════════════════════════════════════════════════════════════════

function initApp(d) {
  if (!d) return;
  window._cats = { income: d.incomeCategories || [], expense: d.expenseCategories || [] };
  if (d.legal && d.legal['BUILDING_NAME']) {
    document.getElementById('bldName').textContent    = d.legal['BUILDING_NAME'];
    document.getElementById('dt-bldName').textContent = d.legal['BUILDING_NAME'];
    document.getElementById('lgn-bld-name').textContent = d.legal['BUILDING_NAME'];
  }

  var sel  = document.getElementById('sel-owner');
  var frag = document.createDocumentFragment();
  var ph   = new Option('اختر / Select...', '');
  ph.disabled = true; ph.selected = true;
  frag.appendChild(ph);
  (d.owners || []).forEach(function(o) {
    var opt = new Option(o.display, o.name);
    opt.dataset.section    = o.section    || '';
    opt.dataset.contractId = o.contractId || '';
    frag.appendChild(opt);
  });
  sel.innerHTML = ''; sel.appendChild(frag);

  fillCats('income');

  if (d.fiscal && d.fiscal.locked) {
    document.getElementById('lock-banner').style.display = 'block';
    document.getElementById('lock-msg').textContent = d.fiscal.msg || '';
    document.getElementById('form').classList.add('disabled');
  }

  setTab('Income');
}

// ══════════════════════════════════════════════════════════════════════════════
// CATEGORIES
// ══════════════════════════════════════════════════════════════════════════════

function fillCats(type) {
  var cats  = (window._cats && window._cats[type]) ? window._cats[type] : [];
  var selId = type === 'income' ? 'sel-icat' : 'sel-ecat';
  var sel   = document.getElementById(selId);
  var frag  = document.createDocumentFragment();
  var ph    = new Option('اختر / Select...', '');
  ph.disabled = true; ph.selected = true;
  frag.appendChild(ph);
  cats.forEach(function(c) { frag.appendChild(new Option(c, c)); });
  sel.innerHTML = ''; sel.appendChild(frag);
}

// ══════════════════════════════════════════════════════════════════════════════
// TABS
// ══════════════════════════════════════════════════════════════════════════════

function setTab(type) {
  TAB = type;
  document.getElementById('eType').value = type;

  ['t-inc','t-exp','t-rep'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.className = 'nav-tab';
  });

  ['dt-t-inc','dt-t-exp','dt-t-rep'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.className = 'dt-tab';
  });

  ['f-inc','f-exp','f-rep','f-amt'].forEach(function(id) {
    document.getElementById(id).classList.add('hide');
  });

  var btn = document.getElementById('btn-sub');
  var ico = document.getElementById('btn-ico');
  var txt = document.getElementById('btn-txt');

  if (type === 'Income') {
    document.getElementById('t-inc').classList.add('n-inc');
    if (document.getElementById('dt-t-inc')) document.getElementById('dt-t-inc').classList.add('dt-inc');
    document.getElementById('f-inc').classList.remove('hide');
    document.getElementById('f-amt').classList.remove('hide');
    fillCats('income');
    btn.className = 'btn-sub b-inc';
    ico.textContent = '💰'; txt.textContent = 'تسجيل الدفعة / Record Payment';

  } else if (type === 'Expense') {
    document.getElementById('t-exp').classList.add('n-exp');
    if (document.getElementById('dt-t-exp')) document.getElementById('dt-t-exp').classList.add('dt-exp');
    document.getElementById('f-exp').classList.remove('hide');
    document.getElementById('f-amt').classList.remove('hide');
    fillCats('expense');
    btn.className = 'btn-sub b-exp';
    ico.textContent = '📉'; txt.textContent = 'تسجيل مصروف / Record Expense';

  } else {
    document.getElementById('t-rep').classList.add('n-rep');
    if (document.getElementById('dt-t-rep')) document.getElementById('dt-t-rep').classList.add('dt-rep');
    document.getElementById('f-rep').classList.remove('hide');
    pickReport('YTD');
    btn.className = 'btn-sub b-rep';
    ico.textContent = '📧'; txt.textContent = 'إرسال التقرير / Send Report';
  }

  document.getElementById('inp-amt').value = '';
  document.getElementById('scroll').scrollTop = 0;
}

// ══════════════════════════════════════════════════════════════════════════════
// REPORT CARDS
// ══════════════════════════════════════════════════════════════════════════════

function pickReport(type) {
  REPORT = type;
  var sel = document.getElementById('sel-rep');
  if (sel) sel.value = type;
  ['rc-ytd','rc-month','rc-journal'].forEach(function(id) {
    document.getElementById(id).classList.remove('on');
  });
  var map = { 'YTD':'rc-ytd', 'CurrentMonth':'rc-month', 'Journal':'rc-journal' };
  if (map[type]) document.getElementById(map[type]).classList.add('on');
}

// ══════════════════════════════════════════════════════════════════════════════
// DASHBOARD
// ══════════════════════════════════════════════════════════════════════════════

function refreshDash() {
  if (!sessionValid()) return;

  var rb   = document.getElementById('rBtn');
  var dtRb = document.getElementById('dt-rBtn');
  rb.classList.add('spin');
  if (dtRb) dtRb.classList.add('spin');

  gasGet('getDashboardStats')
    .then(function(v) {
      var val = v || '$0.00';
      var n = new Date();
      var t = pad(n.getHours()) + ':' + pad(n.getMinutes()) + ':' + pad(n.getSeconds());
      var isNeg = val.indexOf('-') !== -1;
      var amtColor = isNeg ? '#FF4D6A' : '#ffffff';
      document.getElementById('cashAmt').textContent     = val;
      document.getElementById('cashAmt').style.color     = amtColor;
      document.getElementById('dt-cashAmt').textContent  = val;
      document.getElementById('dt-cashAmt').style.color  = amtColor;
      document.getElementById('dashTime').textContent    = t;
      document.getElementById('dt-dashTime').textContent = t;
      rb.classList.remove('spin');
      if (dtRb) dtRb.classList.remove('spin');
    })
    .catch(function() {
      rb.classList.remove('spin');
      if (dtRb) dtRb.classList.remove('spin');
    });

  gasGet('getBuildingHealth')
    .then(function(r) {
      var pct = r && r.pct != null ? r.pct : 0;
      var ico = pct >= 80 ? '💚' : pct >= 50 ? '🧡' : '❤️';
      document.getElementById('hpct').textContent     = pct + '%';
      document.getElementById('dt-hpct').textContent  = pct + '%';
      document.getElementById('heart').textContent    = ico;
      document.getElementById('dt-heart').textContent = ico;
    })
    .catch(function() {});
}

// ══════════════════════════════════════════════════════════════════════════════
// SUBMIT (no more PIN field — uses session token)
// ══════════════════════════════════════════════════════════════════════════════

function doSubmit() {
  if (!sessionValid()) {
    toast('⏱ Session expired. Please log in again.', 'fail');
    setTimeout(doLogout, 1500);
    return;
  }

  var type = TAB;

  if (type !== 'Report') {
    var amt = parseFloat(document.getElementById('inp-amt').value);
    if (!amt || amt <= 0) {
      toast('❌ Enter a valid amount', 'fail');
      markErr(document.getElementById('inp-amt'));
      return;
    }
    if (type === 'Income' && !document.getElementById('sel-owner').value) {
      toast('❌ Select an occupant', 'fail');
      markErr(document.getElementById('sel-owner'));
      return;
    }
  }

  var cat = '';
  if (type === 'Income')  cat = document.getElementById('sel-icat').value;
  if (type === 'Expense') cat = document.getElementById('sel-ecat').value;
  if (type !== 'Report' && !cat) {
    toast('❌ Select a category', 'fail');
    return;
  }

  var btn = document.getElementById('btn-sub');
  setBtnProcessing(true);

  var tmout = setTimeout(function() {
    onFail({ message: 'Timed out. Try again.' });
  }, 30000);

  if (type === 'Report') {
    gasPost({
      action: 'processReportRequest',
      reportType: document.getElementById('sel-rep').value,
      token: _session.token
    })
      .then(function(r) {
        clearTimeout(tmout);
        onOk(r.msg || r);
      })
      .catch(function(e) { clearTimeout(tmout); onFail(e); });

  } else {
    var ownerSel = document.getElementById('sel-owner');
    var selOpt   = ownerSel.selectedIndex >= 0 ? ownerSel.options[ownerSel.selectedIndex] : null;
    var payload  = {
      entryType:  type,
      ownerName:  type === 'Income' ? ownerSel.value : '',
      category:   cat,
      amount:     document.getElementById('inp-amt').value,
      unit:       selOpt ? (selOpt.dataset.section    || '') : '',
      contractId: selOpt ? (selOpt.dataset.contractId || '') : '',
      token:      _session.token
    };

    gasPost({ action: 'processEntry', payload: payload })
      .then(function(r) {
        clearTimeout(tmout);
        onOk(r);
      })
      .catch(function(e) { clearTimeout(tmout); onFail(e); });
  }
}

function onOk(msg) {
  var ok = msg && (msg.includes('✅') || msg.includes('success') || msg.includes('Saved'));
  setBtnProcessing(false);
  toast(msg, ok ? 'ok' : 'fail');
  if (ok && TAB !== 'Report') {
    document.getElementById('inp-amt').value = '';
    refreshDash();
  }
}

function onFail(e) {
  setBtnProcessing(false);
  toast('❌ ' + (e.message || String(e)), 'fail');
}

// ══════════════════════════════════════════════════════════════════════════════
// HELPERS
// ══════════════════════════════════════════════════════════════════════════════

function toast(msg, type) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.className   = type || 'info';
  t.classList.add('show');
  if (_ttimer) clearTimeout(_ttimer);
  _ttimer = setTimeout(function() {
    t.classList.remove('show');
  }, type === 'fail' ? 5000 : 3000);
}

function markErr(el) {
  if (!el) return;
  el.classList.add('err');
  setTimeout(function() { el.classList.remove('err'); }, 1800);
}

function pad(n) { return String(n).padStart(2, '0'); }

function watchNet() {
  var dot   = document.getElementById('dot');
  var dtDot = document.getElementById('dt-dot');
  window.addEventListener('online',  function() {
    dot.classList.remove('off');
    if (dtDot) dtDot.classList.remove('off');
    toast('✅ Back online', 'ok');
  });
  window.addEventListener('offline', function() {
    dot.classList.add('off');
    if (dtDot) dtDot.classList.add('off');
    toast('⚠️ No internet', 'fail');
  });
}

// ── Desktop keyboard support for PIN ─────────────────────────────────────────
document.getElementById('pin-input').addEventListener('input', function(e) {
  var val = this.value.replace(/\D/g, '').slice(0, 4);
  this.value = val;
  _pinBuffer = val;
  updateDots();
  if (_pinBuffer.length === 4) {
    setTimeout(submitPin, 120);
  }
});

document.getElementById('pin-input').addEventListener('keydown', function(e) {
  if (e.key === 'Backspace' && _pinBuffer.length > 0) {
    _pinBuffer = _pinBuffer.slice(0, -1);
    this.value = _pinBuffer;
    updateDots();
  }
});

// ── App keyboard shortcuts (only when logged in) ──────────────────────────────
document.addEventListener('keydown', function(e) {
  if (!sessionValid()) return;
  if (e.altKey && e.key === '1') { e.preventDefault(); setTab('Income'); }
  if (e.altKey && e.key === '2') { e.preventDefault(); setTab('Expense'); }
  if (e.altKey && e.key === '3') { e.preventDefault(); setTab('Report'); }
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    e.preventDefault();
    var b = document.getElementById('btn-sub');
    if (!b.disabled) doSubmit();
  }
});

// ══════════════════════════════════════════════════════════════════════════════
// FISCAL CLOSE
// ══════════════════════════════════════════════════════════════════════════════

function openFiscal() {
  if (!sessionValid()) return;
  gasGet('previewFiscalClose')
    .then(function(d) {
      _fiscal = d;
      document.getElementById('cy-close').textContent = d.yearClosing;
      document.getElementById('cy-open').textContent  = d.yearOpening;
      document.getElementById('cy-cash').textContent  = '$' + d.cashCarryForward.toFixed(2);
      document.getElementById('cy-units').textContent = d.unitCount;
      document.getElementById('modal').classList.add('open');
    })
    .catch(function(e) { toast('❌ ' + e.message, 'fail'); });
}

function execClose() {
  if (!document.getElementById('conf-chk').checked) {
    toast('Please confirm first', 'fail');
    return;
  }
  gasPost({ action: 'commitFiscalClose', payload: _fiscal })
    .then(function(msg) {
      toast(msg, 'ok');
      closeModal();
      setTimeout(function() { location.reload(); }, 2000);
    })
    .catch(function(e) { toast('❌ ' + e.message, 'fail'); });
}

function closeModal() {
  document.getElementById('modal').classList.remove('open');
}

// ══════════════════════════════════════════════════════════════════════════════
// SETTINGS PANEL — 14 sections
// ══════════════════════════════════════════════════════════════════════════════

function openSettings() {
  if (!sessionValid()) return;
  if (_session.role !== 'Admin') return;
  document.getElementById('settings-panel').classList.add('open');
}

function closeSettings() {
  document.getElementById('settings-panel').classList.remove('open');
}

function toggleSection(id) {
  var sec = document.getElementById(id);
  var wasExpanded = sec.classList.contains('expanded');
  document.querySelectorAll('.stg-section').forEach(function(s) {
    s.classList.remove('expanded');
  });
  if (!wasExpanded) {
    sec.classList.add('expanded');
    var map = {
      'stg-building':  'building',
      'stg-units':     'units',
      'stg-occ':       'occupancy',
      'stg-contacts':  'contacts',
      'stg-fees':      'fees',
      'stg-overrides': 'overrides',
      'stg-utility':   'utility',
      'stg-meters':    'meters',
      'stg-incat':     'incat',
      'stg-excat':     'excat',
      'stg-balances':  'balances',
      'stg-users':     'users',
      'stg-yearcash':  'yearcash',
      'stg-yearend':   'yearend'
    };
    if (map[id]) stgLoad(map[id]);
  }
}

// ── Generic loader dispatcher ─────────────────────────────────────────────────
function stgLoad(name) {
  if (!sessionValid()) return;
  var fn = {
    building:  loadBuildingProfile,
    units:     loadUnits,
    occupancy: loadOccupancy,
    contacts:  loadContacts,
    fees:      loadFees,
    overrides: loadOverrides,
    utility:   loadUtility,
    meters:    loadMeters,
    incat:     function() { loadCategories('income'); },
    excat:     function() { loadCategories('expense'); },
    balances:  loadBalances,
    users:     loadUsers,
    yearcash:  loadYearCash,
    yearend:   loadYearEnd
  };
  if (fn[name]) fn[name]();
}

// ── Shared helpers ────────────────────────────────────────────────────────────
function stgListEl(id) { return document.getElementById(id); }

function stgLoading(el) {
  el.innerHTML = '<div class="stg-loading">جاري التحميل... / Loading...</div>';
}

function stgEmpty(el, msg) {
  el.innerHTML = '<div class="stg-empty">' + (msg || 'No records found') + '</div>';
}

function stgError(el) {
  el.innerHTML = '<div class="stg-err">⚠️ Failed to load. Check connection.</div>';
}

// ── ①  Building Profile ───────────────────────────────────────────────────────
function loadBuildingProfile() {
  gasGet('getSettingsBuilding', _session && _session.token)
    .then(function(d) {
      if (!d) return;
      document.getElementById('stg-bld-name').value     = d.buildingName || '';
      document.getElementById('stg-bld-addr').value     = d.address      || '';
      document.getElementById('stg-fiscal-month').value = d.fiscalMonth  || '1';
      document.getElementById('stg-opening-cash').value = d.openingCash  || '';
    }).catch(function() {});
}

// ── ②  Units ─────────────────────────────────────────────────────────────────
function loadUnits() {
  var el = stgListEl('stg-units-list'); stgLoading(el);
  gasGet('getSettingsUnits', _session && _session.token)
    .then(function(rows) {
      if (!rows || !rows.length) { stgEmpty(el, 'لا توجد وحدات / No units found'); return; }
      el.innerHTML = rows.map(function(u) {
        return '<div class="stg-user-row">' +
          '<div class="stg-user-avatar" style="background:var(--forest);font-size:10px;">' + escHtml(u.section || u.unitId || '—') + '</div>' +
          '<div class="stg-user-info">' +
            '<div class="stg-user-name">' + escHtml(u.unitId || '—') + ' — ' + escHtml(u.section || '') + '</div>' +
            '<div class="stg-user-meta">' + (u.type || '') + (u.floor ? ' · ' + u.floor : '') + (u.sqm ? ' · ' + u.sqm + ' m²' : '') + (u.amps ? ' · ' + u.amps + 'A' : '') + '</div>' +
          '</div>' +
          '<div class="stg-user-actions"><button class="stg-user-btn" onclick="editUnit(\'' + escHtml(u.unitId) + '\')">تعديل</button></div>' +
        '</div>';
      }).join('');
    }).catch(function() { stgError(el); });
}

// ── ③  Occupancy ──────────────────────────────────────────────────────────────
var _occShowAll = false;
var _occAllRows = [];

function toggleOccAll() {
  _occShowAll = !_occShowAll;
  var btn = document.getElementById('occ-toggle');
  if (btn) btn.textContent = _occShowAll ? 'Active Only / نشطة فقط' : 'عرض الكل / Show All';
  renderOccupancy();
}

function loadOccupancy() {
  var el = stgListEl('stg-occ-list'); stgLoading(el);
  _occShowAll = false;
  var btn = document.getElementById('occ-toggle');
  if (btn) btn.textContent = 'عرض الكل / Show All';

  gasGet('getSettingsOccupancy', _session && _session.token)
    .then(function(rows) {
      _occAllRows = rows || [];
      renderOccupancy();
    }).catch(function() { stgError(el); });
}

function renderOccupancy() {
  var el = stgListEl('stg-occ-list');
  var rows = _occShowAll
    ? _occAllRows
    : _occAllRows.filter(function(c) { return String(c.status).toLowerCase() === 'active'; });

  var cntEl = document.getElementById('occ-count');
  if (cntEl) {
    var activeCount = _occAllRows.filter(function(c) { return String(c.status).toLowerCase() === 'active'; }).length;
    cntEl.textContent = activeCount + ' active · ' + _occAllRows.length + ' total';
  }

  if (!rows.length) {
    stgEmpty(el, _occShowAll ? 'لا توجد عقود / No contracts' : 'لا توجد عقود نشطة / No active contracts');
    return;
  }

  el.innerHTML = rows.map(function(c) {
    var isActive = String(c.status).toLowerCase() === 'active';
    var rowStyle = isActive ? '' : 'opacity:0.55;';
    var dot = isActive
      ? '<span style="font-size:9px;color:var(--forest);font-weight:700;flex-shrink:0;white-space:nowrap;">● Active</span>'
      : '<span style="font-size:9px;color:var(--burg);font-weight:700;flex-shrink:0;white-space:nowrap;">● Inactive</span>';
    var endInfo = c.endDate ? ' → ' + c.endDate : '';
    return '<div class="stg-user-row" style="' + rowStyle + '">' +
      '<div class="stg-user-avatar" style="font-size:10px;background:' + (isActive ? 'var(--navy)' : 'var(--muted)') + ';">' +
        escHtml(c.section || '—') +
      '</div>' +
      '<div class="stg-user-info">' +
        '<div class="stg-user-name">' + escHtml(c.name || '—') + '</div>' +
        '<div class="stg-user-meta">' +
          escHtml(c.role || '') + ' · ' + escHtml(c.contractId || '') +
          '<br>' + (c.startDate || '') + endInfo +
        '</div>' +
      '</div>' +
      dot +
    '</div>';
  }).join('');
}

// ── ④  Contacts ───────────────────────────────────────────────────────────────
function loadContacts() {
  var el = stgListEl('stg-contacts-list'); stgLoading(el);
  gasGet('getSettingsContacts', _session && _session.token)
    .then(function(rows) {
      if (!rows || !rows.length) { stgEmpty(el, 'لا توجد جهات اتصال / No contacts'); return; }
      el.innerHTML = rows.map(function(c) {
        var isActive = String(c.status).toLowerCase() === 'active';
        var badgeColor = isActive ? 'var(--forest)' : 'var(--burg)';
        return '<div class="stg-user-row">' +
          '<div class="stg-user-avatar" style="font-size:10px;background:var(--navy);">' + escHtml((c.name || '?')[0]) + '</div>' +
          '<div class="stg-user-info">' +
            '<div class="stg-user-name">' + escHtml(c.name || '—') + '</div>' +
            '<div class="stg-user-meta">' + (c.contactId || '') + (c.email ? ' · ' + c.email : '') + (c.phone ? ' · ' + c.phone : '') + '</div>' +
          '</div>' +
          '<span style="font-size:9px;color:' + badgeColor + ';font-weight:700;flex-shrink:0;">● ' + (isActive ? 'Active' : 'Inactive') + '</span>' +
          '<div class="stg-user-actions">' +
            '<button class="stg-user-btn" onclick="editContact(\'' + escHtml(c.contactId) + '\')">تعديل</button>' +
            (isActive
              ? '<button class="stg-user-btn danger" onclick="toggleContact(\'' + escHtml(c.contactId) + '\',false)">إيقاف</button>'
              : '<button class="stg-user-btn" onclick="toggleContact(\'' + escHtml(c.contactId) + '\',true)">تفعيل</button>') +
          '</div>' +
        '</div>';
      }).join('');
    }).catch(function() { stgError(el); });
}

// ── ⑤  Fee Rules ─────────────────────────────────────────────────────────────
function loadFees() {
  var el = stgListEl('stg-fees-list'); stgLoading(el);
  gasGet('getSettingsFees', _session && _session.token)
    .then(function(rows) {
      if (!rows || !rows.length) { stgEmpty(el, 'لا توجد رسوم / No fees configured'); return; }
      el.innerHTML = rows.map(function(f) {
        var isActive = String(f.status).toLowerCase() === 'active';
        var dotColor = isActive ? 'var(--forest)' : 'var(--muted)';
        return '<div class="stg-user-row">' +
          '<div class="stg-user-info">' +
            '<div class="stg-user-name" style="direction:rtl;">' + escHtml(f.name || '—') + '</div>' +
            '<div class="stg-user-meta">' + (f.frequency || '') + ' · ' + (f.feeType || '') + ' · ' + (f.target || '') + (f.startDate ? ' · from ' + f.startDate : '') + '</div>' +
          '</div>' +
          '<div style="text-align:right;flex-shrink:0;">' +
            '<div style="font-family:var(--mono);font-size:13px;font-weight:500;color:var(--forest);">$' + (f.baseRate || '0') + '</div>' +
            '<div style="font-size:9px;color:' + dotColor + ';">● ' + (f.status || '') + '</div>' +
          '</div>' +
        '</div>';
      }).join('');
    }).catch(function() { stgError(el); });
}

// ── ⑥  Unit Fee Overrides ────────────────────────────────────────────────────
function loadOverrides() {
  var el = stgListEl('stg-overrides-list'); stgLoading(el);
  gasGet('getSettingsOverrides', _session && _session.token)
    .then(function(rows) {
      if (!rows || !rows.length) { stgEmpty(el, 'لا توجد استثناءات / No overrides configured'); return; }
      el.innerHTML = rows.map(function(o) {
        return '<div class="stg-user-row">' +
          '<div class="stg-user-avatar" style="background:var(--gold);color:var(--navy);font-size:10px;">' + escHtml(o.unitId || '—') + '</div>' +
          '<div class="stg-user-info">' +
            '<div class="stg-user-name">' + escHtml(o.unitId || '—') + ' — ' + escHtml(o.overrideType || '') + '</div>' +
            '<div class="stg-user-meta">' + (o.appliesTo || '') + (o.reason ? ' · ' + o.reason : '') + (o.startDate ? ' · ' + o.startDate : '') + (o.endDate ? ' → ' + o.endDate : '') + '</div>' +
          '</div>' +
          '<div style="font-family:var(--mono);font-size:13px;font-weight:500;color:var(--burg);flex-shrink:0;">$' + (o.value || '0') + '</div>' +
        '</div>';
      }).join('');
    }).catch(function() { stgError(el); });
}

// ── ⑦  Utility Master ────────────────────────────────────────────────────────
function loadUtility() {
  var el = stgListEl('stg-utility-list'); stgLoading(el);
  gasGet('getSettingsUtility', _session && _session.token)
    .then(function(rows) {
      if (!rows || !rows.length) { stgEmpty(el, 'لا توجد خدمات / No utilities configured'); return; }
      el.innerHTML = rows.map(function(u) {
        return '<div class="stg-user-row">' +
          '<div class="stg-user-avatar" style="background:var(--burg);font-size:14px;">⚡</div>' +
          '<div class="stg-user-info">' +
            '<div class="stg-user-name">' + escHtml(u.name || '—') + '</div>' +
            '<div class="stg-user-meta">' + (u.unit || '') + (u.tag ? ' · ' + u.tag : '') + '</div>' +
          '</div>' +
          '<div class="stg-user-actions"><button class="stg-user-btn" onclick="editUtility(\'' + escHtml(u.name) + '\')">تعديل</button></div>' +
        '</div>';
      }).join('');
    }).catch(function() { stgError(el); });
}

// ── ⑧  Meter Readings ────────────────────────────────────────────────────────
function loadMeters() {
  var el = stgListEl('stg-meters-list'); stgLoading(el);
  gasGet('getSettingsMeters', _session && _session.token)
    .then(function(rows) {
      if (!rows || !rows.length) { stgEmpty(el, 'لا توجد قراءات / No readings found'); return; }
      el.innerHTML = rows.map(function(r) {
        return '<div class="stg-meter-row">' +
          '<div class="stg-meter-top">' +
            '<div class="stg-meter-unit">' + escHtml(r.unit || '—') + ' — ' + escHtml(r.utilityType || '') + '</div>' +
            '<div class="stg-meter-date">' + (r.date || '') + '</div>' +
          '</div>' +
          '<div class="stg-meter-vals">' +
            '<div class="stg-meter-val">Prev: <strong>' + (r.prev || '—') + '</strong></div>' +
            '<div class="stg-meter-val">Curr: <strong>' + (r.curr || '—') + '</strong></div>' +
            '<div class="stg-meter-val" style="color:var(--forest);">Use: <strong>' + (r.consumption || '—') + '</strong></div>' +
          '</div>' +
        '</div>';
      }).join('');
    }).catch(function() { stgError(el); });
}

// ── ⑨ + ⑩  Categories (income / expense) ────────────────────────────────────
function loadCategories(type) {
  var elId  = type === 'income' ? 'stg-incat-list' : 'stg-excat-list';
  var gasAct = type === 'income' ? 'getSettingsIncomeCategories' : 'getSettingsExpenseCategories';
  var el    = stgListEl(elId); stgLoading(el);

  gasGet(gasAct)
    .then(function(rows) {
      if (!rows || !rows.length) { stgEmpty(el, 'لا توجد فئات / No categories found'); return; }
      el.innerHTML = rows.map(function(c) {
        var isActive = String(c.status).toLowerCase() === 'active';
        var dotColor = isActive ? 'var(--forest)' : 'var(--muted)';
        return '<div class="stg-cat-row">' +
          '<div class="stg-cat-info">' +
            '<div class="stg-cat-ar">' + escHtml(c.nameAr || '—') + '</div>' +
            '<div class="stg-cat-en">' + escHtml(c.nameEn || '') + '</div>' +
            '<div class="stg-cat-code">' + (c.code || '') + (c.parent ? ' · ' + c.parent : '') + '</div>' +
          '</div>' +
          '<div class="stg-cat-actions">' +
            '<span style="font-size:9px;color:' + dotColor + ';font-weight:700;">● ' + (c.status || '') + '</span>' +
            '<div style="display:flex;gap:4px;">' +
              '<button class="stg-user-btn" onclick="editCategory(\'' + type + '\',\'' + escHtml(c.code) + '\')">تعديل</button>' +
              (isActive
                ? '<button class="stg-user-btn danger" onclick="toggleCategory(\'' + type + '\',\'' + escHtml(c.code) + '\',false)">إيقاف</button>'
                : '<button class="stg-user-btn" onclick="toggleCategory(\'' + type + '\',\'' + escHtml(c.code) + '\',true)">تفعيل</button>') +
            '</div>' +
          '</div>' +
        '</div>';
      }).join('');
    }).catch(function() { stgError(el); });
}

// ── ⑪  Opening Balances ──────────────────────────────────────────────────────
function loadBalances() {
  var el = stgListEl('stg-bal-list'); stgLoading(el);
  gasGet('getSettingsBalances', _session && _session.token)
    .then(function(rows) {
      if (!rows || !rows.length) { stgEmpty(el, 'لا توجد أرصدة / No balances'); return; }
      el.innerHTML = rows.map(function(r) {
        var bal = parseFloat(r.balance) || 0;
        var color = bal < 0 ? 'var(--burg)' : 'var(--forest)';
        return '<div class="stg-user-row">' +
          '<div class="stg-user-info">' +
            '<div class="stg-user-name" style="direction:rtl;">' + escHtml(r.unit || '—') + ' — ' + escHtml(r.name || '') + '</div>' +
            '<div class="stg-user-meta">' + (r.year || '') + ' · ' + (r.contractId || '') + ' · ' + (r.type || '') + '</div>' +
          '</div>' +
          '<div style="font-family:var(--mono);font-size:13px;font-weight:500;color:' + color + ';flex-shrink:0;">$' + bal.toFixed(2) + '</div>' +
        '</div>';
      }).join('');
    }).catch(function() { stgError(el); });
}

// ── ⑫  Users & Access ────────────────────────────────────────────────────────
function loadUsers() {
  var el = stgListEl('stg-users-list'); stgLoading(el);
  gasGet('getSettingsUsers', _session && _session.token)
    .then(function(users) {
      if (!users || !users.length) { stgEmpty(el, 'لا يوجد مستخدمون / No users found'); return; }
      el.innerHTML = users.map(function(u) {
        var initial    = (u.name || '?')[0].toUpperCase();
        var badgeClass = !u.active ? 'badge-off'
                       : u.role === 'Admin'      ? 'badge-admin'
                       : u.role === 'Management' ? 'badge-mgmt'
                       : 'badge-occ';
        var statusLabel = u.active ? u.role : 'Inactive';
        return '<div class="stg-user-row">' +
          '<div class="stg-user-avatar">' + initial + '</div>' +
          '<div class="stg-user-info">' +
            '<div class="stg-user-name">' + escHtml(u.name) + '</div>' +
            '<div class="stg-user-meta">' + (u.email || 'No email') + '</div>' +
          '</div>' +
          '<span class="stg-user-badge ' + badgeClass + '">' + statusLabel.toUpperCase() + '</span>' +
          '<div class="stg-user-actions">' +
            '<button class="stg-user-btn" onclick="resetPin(\'' + escHtml(u.name) + '\')">PIN</button>' +
            (u.active
              ? '<button class="stg-user-btn danger" onclick="toggleUserStatus(\'' + escHtml(u.name) + '\',false)">إيقاف</button>'
              : '<button class="stg-user-btn" onclick="toggleUserStatus(\'' + escHtml(u.name) + '\',true)">تفعيل</button>') +
          '</div>' +
        '</div>';
      }).join('');
    }).catch(function() { stgError(el); });
}

// ── ⑬  YearCash — view only ──────────────────────────────────────────────────
function loadYearCash() {
  var el = stgListEl('stg-yearcash-list'); stgLoading(el);
  gasGet('getSettingsYearCash', _session && _session.token)
    .then(function(rows) {
      if (!rows || !rows.length) { stgEmpty(el, 'لا توجد سجلات / No records'); return; }
      var html = '<div class="stg-yc-row">' +
        '<div class="stg-yc-hdr">Year</div>' +
        '<div class="stg-yc-hdr">Opening</div>' +
        '<div class="stg-yc-hdr">Closing</div>' +
        '<div class="stg-yc-hdr">INC</div>' +
        '<div class="stg-yc-hdr">EXP</div>' +
      '</div>';
      html += rows.map(function(r) {
        var open  = parseFloat(r.opening)  || 0;
        var close = parseFloat(r.closing)  || 0;
        return '<div class="stg-yc-row">' +
          '<div class="stg-yc-val">' + (r.year || '—') + '</div>' +
          '<div class="stg-yc-val">$' + open.toFixed(2) + '</div>' +
          '<div class="stg-yc-val" style="color:' + (close >= 0 ? 'var(--forest)' : 'var(--burg)') + ';">$' + close.toFixed(2) + '</div>' +
          '<div class="stg-yc-cnt">' + (r.incCount || '—') + '</div>' +
          '<div class="stg-yc-cnt">' + (r.expCount || '—') + '</div>' +
        '</div>';
      }).join('');
      el.innerHTML = html;
    }).catch(function() { stgError(el); });
}

// ── ⑭  Year-End Close ────────────────────────────────────────────────────────
function loadYearEnd() {
  var statusEl  = document.getElementById('stg-ye-status');
  var historyEl = document.getElementById('stg-ye-history');
  gasGet('getSettingsYearEnd', _session && _session.token)
    .then(function(d) {
      if (!d) return;
      var closed = d.closedThisYear;
      statusEl.innerHTML =
        '<strong>' + (d.currentYear || '—') + ' · ' + (closed ? '✅ مغلقة / Closed' : '⏳ مفتوحة / Open') + '</strong>' +
        '<span style="font-size:11px;color:var(--muted);display:block;margin-top:4px;">' + (d.statusMsg || '') + '</span>';
      if (d.history && d.history.length) {
        var h = '<div style="font-size:10px;font-weight:700;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;">Year History</div>';
        h += d.history.map(function(row) {
          return '<div style="display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--bdr);font-size:12px;">' +
            '<span style="font-family:var(--mono);">' + (row.year || '—') + '</span>' +
            '<span style="color:var(--muted);">Opening: $' + (row.openingCash || '—') + '</span>' +
            '<span style="color:var(--forest);">Closing: $' + (row.closingCash || '—') + '</span>' +
          '</div>';
        }).join('');
        historyEl.innerHTML = h;
      }
    }).catch(function() {
      statusEl.innerHTML = '<strong>⚠️ Failed to load year-end status</strong>';
    });
}

// ── Save actions ──────────────────────────────────────────────────────────────
function saveSection(name) {
  if (!sessionValid()) return;
  if (name === 'building') {
    stgSave('saveSettingsBuilding', {
      buildingName: document.getElementById('stg-bld-name').value.trim(),
      address:      document.getElementById('stg-bld-addr').value.trim(),
      fiscalMonth:  document.getElementById('stg-fiscal-month').value,
      openingCash:  document.getElementById('stg-opening-cash').value
    }, 'Building profile saved ✅');
  }
}

function stgSave(action, payload, successMsg) {
  gasPost({ action: action, payload: payload, token: _session.token })
    .then(function() { toast(successMsg, 'ok'); })
    .catch(function(e) { toast('❌ ' + e.message, 'fail'); });
}

// ── Contacts actions ──────────────────────────────────────────────────────────
function editContact(id)  { toast('ℹ️ Edit contact: ' + id, 'info'); }
function addContact()     { toast('ℹ️ Add contact form — coming soon', 'info'); }
function toggleContact(id, activate) {
  if (!sessionValid()) return;
  if (!confirm((activate ? 'Activate' : 'Deactivate') + ' contact ' + id + '?')) return;
  gasPost({ action: 'setContactStatus', payload: { contactId: id, active: activate }, token: _session.token })
    .then(function() { toast('✅ Contact updated', 'ok'); loadContacts(); })
    .catch(function(e) { toast('❌ ' + e.message, 'fail'); });
}

// ── Category actions ──────────────────────────────────────────────────────────
function editCategory(type, code)  { toast('ℹ️ Edit category: ' + code, 'info'); }
function addCategory(type)         { toast('ℹ️ Add ' + type + ' category — coming soon', 'info'); }
function toggleCategory(type, code, activate) {
  if (!sessionValid()) return;
  if (!confirm((activate ? 'Activate' : 'Deactivate') + ' category ' + code + '?')) return;
  gasPost({ action: 'setCategoryStatus', payload: { type: type, code: code, active: activate }, token: _session.token })
    .then(function() { toast('✅ Category updated', 'ok'); loadCategories(type); })
    .catch(function(e) { toast('❌ ' + e.message, 'fail'); });
}

// ── User actions ──────────────────────────────────────────────────────────────
function resetPin(name) {
  if (!sessionValid()) return;
  var newPin = prompt('New PIN for ' + name + ' (4 digits):');
  if (!newPin || !/^\d{4}$/.test(newPin)) { toast('❌ PIN must be exactly 4 digits', 'fail'); return; }
  gasPost({ action: 'resetUserPin', payload: { name: name, newPin: newPin }, token: _session.token })
    .then(function() { toast('✅ PIN updated for ' + name, 'ok'); })
    .catch(function(e) { toast('❌ ' + e.message, 'fail'); });
}

function toggleUserStatus(name, activate) {
  if (!sessionValid()) return;
  if (!confirm((activate ? 'Activate' : 'Deactivate') + ' user ' + name + '?')) return;
  gasPost({ action: 'setUserStatus', payload: { name: name, active: activate }, token: _session.token })
    .then(function() { toast((activate ? '✅ Activated: ' : '✅ Deactivated: ') + name, 'ok'); loadUsers(); })
    .catch(function(e) { toast('❌ ' + e.message, 'fail'); });
}

function openAddUser() { toast('ℹ️ Add user form — coming soon', 'info'); }

// ── Unit / Utility / Meter / Override stubs ───────────────────────────────────
// ── Add Contract sheet ────────────────────────────────────────────────────────
var _contractUnits    = [];   // [{unitId, section, type}]
var _contractContacts = [];   // [{contactId, name}]
var _activeContracts  = {};   // { unitId: contractRow } — active contract per unit

function addContract() {
  if (!sessionValid()) return;
  // Reset form
  document.getElementById('cs-unit').innerHTML    = '<option value="" disabled selected>جاري التحميل... / Loading...</option>';
  document.getElementById('cs-contact').innerHTML = '<option value="" disabled selected>جاري التحميل... / Loading...</option>';
  document.getElementById('cs-role').value    = '';
  document.getElementById('cs-start').value   = '';
  document.getElementById('cs-end').value     = '';
  document.getElementById('cs-balance').value = '0';
  document.getElementById('cs-id-preview').textContent = 'Fill Unit · Contact · Start Date to generate';
  document.getElementById('cs-id-preview').classList.add('empty');
  document.getElementById('cs-status-pill').textContent = '— fill dates —';
  document.getElementById('cs-status-pill').className = 'cs-status-pill empty';
  document.getElementById('cs-warn').classList.remove('show');
  document.getElementById('cs-confirm').classList.remove('show');
  document.getElementById('cs-confirm-chk').checked = false;
  document.getElementById('cs-submit').disabled = true;

  // Set max date = today
  var today = todayStr();
  document.getElementById('cs-start').max = today;

  // Open sheet
  document.getElementById('contract-sheet-wrap').classList.add('open');

  // Load units + contacts in parallel
  Promise.all([
    gasGet('getSettingsUnits', _session && _session.token),
    gasGet('getSettingsContacts', _session && _session.token),
    gasGet('getSettingsOccupancy', _session && _session.token)  // all contracts to find active ones
  ]).then(function(results) {
    _contractUnits    = results[0] || [];
    _contractContacts = (results[1] || []).filter(function(c) {
      return String(c.status).toLowerCase() === 'active';
    });
    // Build active contract lookup by unitId
    _activeContracts = {};
    (results[2] || []).forEach(function(c) {
      if (String(c.status).toLowerCase() === 'active') {
        _activeContracts[c.unitId] = c;
      }
    });

    // Populate unit dropdown
    var uSel = document.getElementById('cs-unit');
    uSel.innerHTML = '<option value="" disabled selected>اختر وحدة / Select unit...</option>';
    _contractUnits.forEach(function(u) {
      var opt = document.createElement('option');
      opt.value = u.unitId;
      opt.dataset.section = u.section || '';
      var occupied = _activeContracts[u.unitId]
        ? ' ● (occupied)' : '';
      opt.textContent = u.unitId + ' — §' + (u.section || '') + ' · ' + (u.type || '') + occupied;
      uSel.appendChild(opt);
    });

    // Populate contact dropdown
    var cSel = document.getElementById('cs-contact');
    cSel.innerHTML = '<option value="" disabled selected>اختر جهة اتصال / Select contact...</option>';
    _contractContacts.forEach(function(c) {
      var opt = document.createElement('option');
      opt.value = c.contactId;
      opt.dataset.name = c.name || '';
      opt.textContent = c.contactId + ' — ' + (c.name || '');
      cSel.appendChild(opt);
    });
  }).catch(function() {
    toast('⚠️ Failed to load form data', 'fail');
    closeContractSheet();
  });
}

function closeContractSheet() {
  document.getElementById('contract-sheet-wrap').classList.remove('open');
}

function onContractUnitChange() {
  checkActiveContract();
  onContractFieldChange();
}

function checkActiveContract() {
  var unitId  = document.getElementById('cs-unit').value;
  var warnEl  = document.getElementById('cs-warn');
  var confEl  = document.getElementById('cs-confirm');
  var confChk = document.getElementById('cs-confirm-chk');

  if (unitId && _activeContracts[unitId]) {
    var existing = _activeContracts[unitId];
    var startVal = document.getElementById('cs-start').value;
    var closeDate = startVal ? dateMinus1(startVal) : '(new start date − 1 day)';
    document.getElementById('cs-warn-msg').innerHTML =
      'الوحدة <strong>' + unitId + '</strong> لديها عقد نشط مع ' +
      '<strong>' + escHtml(existing.name || '') + '</strong> ' +
      '(العقد: ' + escHtml(existing.contractId || '') + ').<br>' +
      'سيتم إغلاقه تلقائياً بتاريخ <strong>' + closeDate + '</strong>.<br><br>' +
      'Unit <strong>' + unitId + '</strong> has an active contract with ' +
      '<strong>' + escHtml(existing.name || '') + '</strong>. ' +
      'It will be auto-closed on <strong>' + closeDate + '</strong>.';
    document.getElementById('cs-confirm-txt').textContent =
      'I confirm closing the existing contract and creating the new one.';
    warnEl.classList.add('show');
    confEl.classList.add('show');
    confChk.checked = false;
  } else {
    warnEl.classList.remove('show');
    confEl.classList.remove('show');
  }
  updateContractSubmit();
}

function onContractDateChange() {
  // Update status pill
  var startVal = document.getElementById('cs-start').value;
  var endVal   = document.getElementById('cs-end').value;
  var pill     = document.getElementById('cs-status-pill');

  if (!startVal) {
    pill.textContent = '— fill dates —';
    pill.className   = 'cs-status-pill empty';
  } else if (endVal) {
    pill.textContent = '● Inactive';
    pill.className   = 'cs-status-pill inactive';
  } else {
    pill.textContent = '● Active';
    pill.className   = 'cs-status-pill active';
  }

  // Update warning close date if unit already selected
  var unitId = document.getElementById('cs-unit').value;
  if (unitId && _activeContracts[unitId]) {
    checkActiveContract();
  }

  onContractFieldChange();
}

function onContractFieldChange() {
  // Update Contract ID preview
  var unitSel    = document.getElementById('cs-unit');
  var contactSel = document.getElementById('cs-contact');
  var startVal   = document.getElementById('cs-start').value;
  var preview    = document.getElementById('cs-id-preview');

  var unitId     = unitSel.value;
  var contactId  = contactSel.value;

  if (unitId && contactId && startVal) {
    var year   = startVal.substring(0, 4);
    // Sequence: count existing contracts for this unit + 1
    var seq = (_occAllRows.filter(function(c) { return c.unitId === unitId; }).length + 1);
    var seqStr = String(seq).padStart(3, '0');
    var contractId = unitId + '-' + contactId + '-' + year + '-' + seqStr;
    preview.textContent = contractId;
    preview.classList.remove('empty');
  } else {
    preview.textContent = 'Fill Unit · Contact · Start Date to generate';
    preview.classList.add('empty');
  }

  updateContractSubmit();
}

function updateContractSubmit() {
  var unitId    = document.getElementById('cs-unit').value;
  var contactId = document.getElementById('cs-contact').value;
  var role      = document.getElementById('cs-role').value;
  var startVal  = document.getElementById('cs-start').value;
  var endVal    = document.getElementById('cs-end').value;
  var btn       = document.getElementById('cs-submit');
  var hasConflict = unitId && _activeContracts[unitId];
  var confirmed   = document.getElementById('cs-confirm-chk').checked;

  // Validation
  var valid = unitId && contactId && role && startVal;

  // Start date must not be in future
  if (startVal && startVal > todayStr()) valid = false;

  // End date must be >= start date if provided
  if (startVal && endVal && endVal < startVal) valid = false;

  // If conflict, must confirm
  if (hasConflict && !confirmed) valid = false;

  btn.disabled = !valid;
}

function submitContract() {
  if (!sessionValid()) return;

  var unitSel    = document.getElementById('cs-unit');
  var contactSel = document.getElementById('cs-contact');
  var unitId     = unitSel.value;
  var contactId  = contactSel.value;
  var unitOpt    = unitSel.options[unitSel.selectedIndex];
  var contactOpt = contactSel.options[contactSel.selectedIndex];
  var role       = document.getElementById('cs-role').value;
  var startVal   = document.getElementById('cs-start').value;
  var endVal     = document.getElementById('cs-end').value;
  var balance    = parseFloat(document.getElementById('cs-balance').value) || 0;

  // Final validation
  if (!unitId || !contactId || !role || !startVal) {
    toast('❌ Please fill all required fields', 'fail'); return;
  }
  if (startVal > todayStr()) {
    toast('❌ Start date cannot be in the future', 'fail'); return;
  }
  if (endVal && endVal < startVal) {
    toast('❌ End date must be on or after start date', 'fail'); return;
  }

  var hasConflict = _activeContracts[unitId];
  if (hasConflict && !document.getElementById('cs-confirm-chk').checked) {
    toast('❌ Please confirm closing the existing contract', 'fail'); return;
  }

  // Build payload
  var year   = startVal.substring(0, 4);
  var seq    = (_occAllRows.filter(function(c) { return c.unitId === unitId; }).length + 1);
  var seqStr = String(seq).padStart(3, '0');
  var contractId = unitId + '-' + contactId + '-' + year + '-' + seqStr;

  var payload = {
    unitId:       unitId,
    section:      (unitOpt && unitOpt.dataset.section) || '',
    contactId:    contactId,
    contactName:  (contactOpt && contactOpt.dataset.name) || '',
    role:         role,
    startDate:    startVal,
    endDate:      endVal || '',
    balanceFwd:   balance,
    contractId:   contractId,
    closeExisting: hasConflict ? hasConflict.contractId : ''
  };

  document.getElementById('cs-submit').disabled = true;
  document.getElementById('cs-submit').textContent = 'جاري الحفظ...';

  gasPost({ action: 'addOccupancyContract', payload: payload, token: _session.token })
    .then(function(msg) {
      toast('✅ ' + (msg || 'Contract saved'), 'ok');
      closeContractSheet();
      loadOccupancy(); // refresh the list
    })
    .catch(function(e) {
      toast('❌ ' + (e.message || 'Failed to save'), 'fail');
      document.getElementById('cs-submit').disabled = false;
      document.getElementById('cs-submit').textContent = 'حفظ العقد / Save Contract';
    });
}

// ── Date helpers ──────────────────────────────────────────────────────────────
function todayStr() {
  var d = new Date();
  return d.getFullYear() + '-' +
    String(d.getMonth() + 1).padStart(2, '0') + '-' +
    String(d.getDate()).padStart(2, '0');
}

function dateMinus1(dateStr) {
  var d = new Date(dateStr);
  d.setDate(d.getDate() - 1);
  return d.getFullYear() + '-' +
    String(d.getMonth() + 1).padStart(2, '0') + '-' +
    String(d.getDate()).padStart(2, '0');
}
function addUtility()       { toast('ℹ️ Add utility — coming soon', 'info'); }
function editUtility(name)  { toast('ℹ️ Edit utility: ' + name, 'info'); }
function addOverride()      { toast('ℹ️ Add override — coming soon', 'info'); }
function addMeterReading()  { toast('ℹ️ Add meter reading — coming soon', 'info'); }

// ── Gear visibility ───────────────────────────────────────────────────────────
function showGear(isAdmin) {
  var sbGear = document.getElementById('sb-gear');
  if (sbGear) sbGear.style.display = isAdmin ? 'block' : 'none';
  var dtGear = document.getElementById('dt-gear');
  if (dtGear) dtGear.style.display = isAdmin ? 'block' : 'none';
}

// ── Utility ───────────────────────────────────────────────────────────────────
function escHtml(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

</script>
<!-- ══════════════════════════════════════════════
     SETTINGS PANEL (Admin only — 14 sections)
══════════════════════════════════════════════ -->
<div id="settings-panel">

  <div class="stg-topbar">
    <div class="stg-title">
      الإعدادات / Settings
      <span>ADMIN ONLY</span>
    </div>
    <button class="stg-close" onclick="closeSettings()">✕</button>
  </div>

  <div class="stg-scroll" id="stg-scroll">

    <!-- ①  Building Profile -->
    <div class="stg-section" id="stg-building">
      <div class="stg-sec-hdr" onclick="toggleSection('stg-building')">
        <div class="stg-sec-ico">🏢</div>
        <div class="stg-sec-info">
          <div class="stg-sec-title">ملف المبنى / Building Profile</div>
          <div class="stg-sec-sub">Name, address, fiscal year, opening cash</div>
        </div>
        <div class="stg-sec-arr">›</div>
      </div>
      <div class="stg-sec-body">
        <div class="stg-field"><div class="stg-field-lbl">Building Name / اسم المبنى</div>
          <input class="inp" id="stg-bld-name" type="text" placeholder="e.g. Le Porter"></div>
        <div class="stg-field"><div class="stg-field-lbl">Address / العنوان</div>
          <input class="inp" id="stg-bld-addr" type="text" placeholder="Street, City"></div>
        <div class="stg-field"><div class="stg-field-lbl">Fiscal Year Start / بداية السنة المالية</div>
          <select class="inp" id="stg-fiscal-month">
            <option value="1">January / يناير</option><option value="2">February / فبراير</option>
            <option value="3">March / مارس</option><option value="4">April / أبريل</option>
            <option value="5">May / مايو</option><option value="6">June / يونيو</option>
            <option value="7">July / يوليو</option><option value="8">August / أغسطس</option>
            <option value="9">September / سبتمبر</option><option value="10">October / أكتوبر</option>
            <option value="11">November / نوفمبر</option><option value="12">December / ديسمبر</option>
          </select></div>
        <div class="stg-field"><div class="stg-field-lbl">Opening Cash / النقد الافتتاحي</div>
          <input class="inp" id="stg-opening-cash" type="number" step="0.01" placeholder="0.00"></div>
        <button class="stg-save" onclick="saveSection('building')">حفظ / Save</button>
      </div>
    </div>

    <!-- ②  Units -->
    <div class="stg-section" id="stg-units">
      <div class="stg-sec-hdr" onclick="toggleSection('stg-units')">
        <div class="stg-sec-ico">🏠</div>
        <div class="stg-sec-info">
          <div class="stg-sec-title">الوحدات / Units</div>
          <div class="stg-sec-sub">Unit ID · Floor · Type · SqM · Amps</div>
        </div>
        <div class="stg-sec-arr">›</div>
      </div>
      <div class="stg-sec-body">
        <div id="stg-units-list" class="stg-list-wrap"></div>
        <button class="stg-add-btn" onclick="addUnit()">＋ إضافة وحدة / Add Unit</button>
      </div>
    </div>

    <!-- ③  Occupancy -->
    <div class="stg-section" id="stg-occ">
      <div class="stg-sec-hdr" onclick="toggleSection('stg-occ')">
        <div class="stg-sec-ico">👥</div>
        <div class="stg-sec-info">
          <div class="stg-sec-title">الإشغال / Occupancy</div>
          <div class="stg-sec-sub">Contracts · tenants · roles · dates</div>
        </div>
        <div class="stg-sec-arr">›</div>
      </div>
      <div class="stg-sec-body">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div style="font-size:10px;color:var(--muted);" id="occ-count"></div>
          <button class="stg-user-btn" id="occ-toggle" onclick="toggleOccAll()"
            style="border-color:var(--navy);color:var(--navy);">
            عرض الكل / Show All
          </button>
        </div>
        <div id="stg-occ-list" class="stg-list-wrap"></div>
        <button class="stg-add-btn" onclick="addContract()">＋ إضافة عقد / Add Contract</button>
      </div>
    </div>

    <!-- ④  Contacts -->
    <div class="stg-section" id="stg-contacts">
      <div class="stg-sec-hdr" onclick="toggleSection('stg-contacts')">
        <div class="stg-sec-ico">📋</div>
        <div class="stg-sec-info">
          <div class="stg-sec-title">جهات الاتصال / Contacts</div>
          <div class="stg-sec-sub">Contact ID · Name · Email · Phone · Status</div>
        </div>
        <div class="stg-sec-arr">›</div>
      </div>
      <div class="stg-sec-body">
        <div id="stg-contacts-list" class="stg-list-wrap"></div>
        <button class="stg-add-btn" onclick="addContact()">＋ إضافة جهة اتصال / Add Contact</button>
      </div>
    </div>

    <!-- ⑤  Fee Rules -->
    <div class="stg-section" id="stg-fees">
      <div class="stg-sec-hdr" onclick="toggleSection('stg-fees')">
        <div class="stg-sec-ico">💰</div>
        <div class="stg-sec-info">
          <div class="stg-sec-title">قواعد الرسوم / Fee Rules</div>
          <div class="stg-sec-sub">Charge · frequency · type · rate · target</div>
        </div>
        <div class="stg-sec-arr">›</div>
      </div>
      <div class="stg-sec-body">
        <div id="stg-fees-list" class="stg-list-wrap"></div>
      </div>
    </div>

    <!-- ⑥  Unit Fee Override -->
    <div class="stg-section" id="stg-overrides">
      <div class="stg-sec-hdr" onclick="toggleSection('stg-overrides')">
        <div class="stg-sec-ico">🔧</div>
        <div class="stg-sec-info">
          <div class="stg-sec-title">تجاوز رسوم الوحدة / Unit Fee Override</div>
          <div class="stg-sec-sub">Per-unit exceptions to standard fee rules</div>
        </div>
        <div class="stg-sec-arr">›</div>
      </div>
      <div class="stg-sec-body">
        <div id="stg-overrides-list" class="stg-list-wrap"></div>
        <button class="stg-add-btn" onclick="addOverride()">＋ إضافة استثناء / Add Override</button>
      </div>
    </div>

    <!-- ⑦  Utility Master -->
    <div class="stg-section" id="stg-utility">
      <div class="stg-sec-hdr" onclick="toggleSection('stg-utility')">
        <div class="stg-sec-ico">⚡</div>
        <div class="stg-sec-info">
          <div class="stg-sec-title">الخدمات / Utility Master</div>
          <div class="stg-sec-sub">Utility name · unit of measure · system tag</div>
        </div>
        <div class="stg-sec-arr">›</div>
      </div>
      <div class="stg-sec-body">
        <div id="stg-utility-list" class="stg-list-wrap"></div>
        <button class="stg-add-btn" onclick="addUtility()">＋ إضافة خدمة / Add Utility</button>
      </div>
    </div>

    <!-- ⑧  Meter Readings -->
    <div class="stg-section" id="stg-meters">
      <div class="stg-sec-hdr" onclick="toggleSection('stg-meters')">
        <div class="stg-sec-ico">📈</div>
        <div class="stg-sec-info">
          <div class="stg-sec-title">قراءات العداد / Meter Readings</div>
          <div class="stg-sec-sub">Date · unit · utility · prev / current · consumption</div>
        </div>
        <div class="stg-sec-arr">›</div>
      </div>
      <div class="stg-sec-body">
        <div id="stg-meters-list" class="stg-list-wrap"></div>
        <button class="stg-add-btn" onclick="addMeterReading()">＋ إضافة قراءة / Add Reading</button>
      </div>
    </div>

    <!-- ⑨  Income Categories -->
    <div class="stg-section" id="stg-incat">
      <div class="stg-sec-hdr" onclick="toggleSection('stg-incat')">
        <div class="stg-sec-ico">🏷️</div>
        <div class="stg-sec-info">
          <div class="stg-sec-title">فئات الدخل / Income Categories</div>
          <div class="stg-sec-sub">Code · Arabic · English · parent · status</div>
        </div>
        <div class="stg-sec-arr">›</div>
      </div>
      <div class="stg-sec-body">
        <div id="stg-incat-list" class="stg-list-wrap"></div>
        <button class="stg-add-btn" onclick="addCategory('income')">＋ إضافة فئة / Add Category</button>
      </div>
    </div>

    <!-- ⑩  Expense Categories -->
    <div class="stg-section" id="stg-excat">
      <div class="stg-sec-hdr" onclick="toggleSection('stg-excat')">
        <div class="stg-sec-ico">🏷️</div>
        <div class="stg-sec-info">
          <div class="stg-sec-title">فئات المصروف / Expense Categories</div>
          <div class="stg-sec-sub">Code · Arabic · English · parent · status</div>
        </div>
        <div class="stg-sec-arr">›</div>
      </div>
      <div class="stg-sec-body">
        <div id="stg-excat-list" class="stg-list-wrap"></div>
        <button class="stg-add-btn" onclick="addCategory('expense')">＋ إضافة فئة / Add Category</button>
      </div>
    </div>

    <!-- ⑪  Opening Balances -->
    <div class="stg-section" id="stg-balances">
      <div class="stg-sec-hdr" onclick="toggleSection('stg-balances')">
        <div class="stg-sec-ico">📊</div>
        <div class="stg-sec-info">
          <div class="stg-sec-title">الأرصدة الافتتاحية / Opening Balances</div>
          <div class="stg-sec-sub">Per contract · per year · debit / credit</div>
        </div>
        <div class="stg-sec-arr">›</div>
      </div>
      <div class="stg-sec-body">
        <div id="stg-bal-list" class="stg-list-wrap"></div>
      </div>
    </div>

    <!-- ⑫  Users & Access -->
    <div class="stg-section" id="stg-users">
      <div class="stg-sec-hdr" onclick="toggleSection('stg-users')">
        <div class="stg-sec-ico">👤</div>
        <div class="stg-sec-info">
          <div class="stg-sec-title">المستخدمون / Users & Access</div>
          <div class="stg-sec-sub">View users · reset PINs · activate / deactivate</div>
        </div>
        <div class="stg-sec-arr">›</div>
      </div>
      <div class="stg-sec-body">
        <div id="stg-users-list" class="stg-list-wrap"></div>
        <button class="stg-add-btn" onclick="openAddUser()">＋ إضافة مستخدم / Add User</button>
      </div>
    </div>

    <!-- ⑬  YearCash — view only -->
    <div class="stg-section" id="stg-yearcash">
      <div class="stg-sec-hdr" onclick="toggleSection('stg-yearcash')">
        <div class="stg-sec-ico">💵</div>
        <div class="stg-sec-info">
          <div class="stg-sec-title">سجل النقد السنوي / YearCash</div>
          <div class="stg-sec-sub">Year · opening · closing · INC / EXP counts — view only</div>
        </div>
        <div class="stg-sec-arr">›</div>
      </div>
      <div class="stg-sec-body">
        <div id="stg-yearcash-list" class="stg-list-wrap"></div>
      </div>
    </div>

    <!-- ⑭  Year-End Close -->
    <div class="stg-section" id="stg-yearend">
      <div class="stg-sec-hdr" onclick="toggleSection('stg-yearend')">
        <div class="stg-sec-ico">📅</div>
        <div class="stg-sec-info">
          <div class="stg-sec-title">إغلاق السنة / Year-End Close</div>
          <div class="stg-sec-sub">Run close · view history</div>
        </div>
        <div class="stg-sec-arr">›</div>
      </div>
      <div class="stg-sec-body">
        <div class="stg-ye-status" id="stg-ye-status">
          <strong>جاري التحميل... / Loading...</strong>
        </div>
        <div id="stg-ye-history" style="margin-top:12px;"></div>
        <button class="stg-danger-btn" onclick="openFiscal()">
          ⚠️ تنفيذ الإغلاق / Execute Year-End Close
        </button>
      </div>
    </div>

  </div><!-- /stg-scroll -->
</div><!-- /settings-panel -->

<!-- ══════════════════════════════════════════════
     ADD CONTRACT SHEET
══════════════════════════════════════════════ -->
<div id="contract-sheet-wrap">
  <div id="contract-sheet">

    <div class="cs-title">إضافة عقد / Add Contract</div>
    <div class="cs-sub">Fields marked <span style="color:var(--burg);">*</span> are required</div>

    <!-- Warning: unit already has active contract -->
    <div class="cs-warn" id="cs-warn">
      <strong>⚠️ تنبيه / Warning</strong>
      <span id="cs-warn-msg"></span>
    </div>

    <!-- Confirm checkbox (shown with warning) -->
    <label class="cs-confirm" id="cs-confirm">
      <input type="checkbox" id="cs-confirm-chk" onchange="updateContractSubmit()">
      <span id="cs-confirm-txt"></span>
    </label>

    <!-- Unit -->
    <div class="cs-field">
      <div class="cs-lbl">Unit / الوحدة <span class="req">*</span></div>
      <select class="inp" id="cs-unit" onchange="onContractUnitChange()">
        <option value="" disabled selected>اختر وحدة / Select unit...</option>
      </select>
    </div>

    <!-- Contact -->
    <div class="cs-field">
      <div class="cs-lbl">Contact / جهة الاتصال <span class="req">*</span></div>
      <select class="inp" id="cs-contact" onchange="onContractFieldChange()">
        <option value="" disabled selected>اختر جهة اتصال / Select contact...</option>
      </select>
    </div>

    <!-- Role -->
    <div class="cs-field">
      <div class="cs-lbl">Role / الدور <span class="req">*</span></div>
      <select class="inp" id="cs-role" onchange="onContractFieldChange()">
        <option value="" disabled selected>اختر الدور / Select role...</option>
        <option value="Tenant">Tenant / مستأجر</option>
        <option value="Relative">Relative / قريب</option>
        <option value="Owner">Owner / مالك</option>
      </select>
    </div>

    <!-- Start Date -->
    <div class="cs-field">
      <div class="cs-lbl">Start Date / تاريخ البدء <span class="req">*</span></div>
      <input class="inp" type="date" id="cs-start" onchange="onContractDateChange()">
    </div>

    <!-- End Date -->
    <div class="cs-field">
      <div class="cs-lbl">End Date / تاريخ الانتهاء <span style="color:var(--muted);font-weight:400;">(optional)</span></div>
      <input class="inp" type="date" id="cs-end" onchange="onContractDateChange()">
    </div>

    <!-- Balance Forward -->
    <div class="cs-field">
      <div class="cs-lbl">Balance Forward / الرصيد المرحّل</div>
      <input class="inp" type="number" step="0.01" id="cs-balance" placeholder="0.00" value="0">
    </div>

    <!-- Contract ID preview -->
    <div class="cs-field">
      <div class="cs-lbl">Contract ID (auto-generated)</div>
      <div class="cs-preview empty" id="cs-id-preview">Fill Unit · Contact · Start Date to generate</div>
    </div>

    <!-- Status preview -->
    <div class="cs-field">
      <div class="cs-lbl">Status / الحالة (auto)</div>
      <div class="cs-status-pill empty" id="cs-status-pill">— fill dates —</div>
    </div>

    <!-- Buttons -->
    <div class="cs-btns">
      <button class="cs-submit" id="cs-submit" onclick="submitContract()" disabled>
        حفظ العقد / Save Contract
      </button>
      <button class="cs-cancel" onclick="closeContractSheet()">إلغاء</button>
    </div>

  </div>
</div>

</body>
</html>
